<!doctype html>
<html lang=en-US>
<meta charset=utf-8>
<title>Fetch Standard</title>
<link rel=stylesheet href=https://resources.whatwg.org/standard.css>
<link rel=icon href=https://resources.whatwg.org/logo-fetch.svg>

<div class=head>

<p><a class=logo href=https://whatwg.org/><img alt=WHATWG src=https://resources.whatwg.org/logo-fetch.svg width=100 height=100></a>
<h1 id=cors>Fetch</h1>
<h2 class="no-num no-toc">Living Standard &mdash; Last Updated [DATE: 3 August 2002]</h2>

<dl>
 <dt>Participate:
 <dd><a href=https://github.com/whatwg/fetch>GitHub whatwg/fetch</a>
 (<a href=https://github.com/whatwg/fetch/issues/new>file an issue</a>,
 <a href=https://github.com/whatwg/fetch/issues>open issues</a>)
 <dd><a href=https://wiki.whatwg.org/wiki/IRC>IRC: #whatwg on Freenode</a>

 <dt>Commits:
 <dd><a href=https://github.com/whatwg/fetch/commits>GitHub whatwg/fetch/commits</a>
 <dd><a href=https://twitter.com/fetchstandard>@fetchstandard</a>

 <dt>Translation <small>(non-normative)</small>:
 <dd title=Japanese><a href=https://triple-underscore.github.io/Fetch-ja.html lang=ja hreflang=ja rel=alternative>日本語</a>
</dl>

<script src=https://resources.whatwg.org/file-issue.js async></script>
<script id=head src=https://resources.whatwg.org/dfn.js defer></script>

</div>



<h2 class="no-num no-toc short">Abstract</h2>

<p>The Fetch standard defines requests, responses, and the process that binds them:
fetching.



<h2 class="no-num no-toc">Table of Contents</h2>
<!-- toc -->



<h2 id=goals class="no-num short">Goals</h2>

<p>To unify fetching across the web platform this specification supplants a number of algorithms and
specifications:

<ul class="brief no-backref">
 <li>HTML Standard's fetch and potentially CORS-enabled fetch algorithms
 <span data-anolis-ref class=informative>HTML</span>
 <li>CORS <span data-anolis-ref class=informative>CORS</span>
 <li>HTTP `<code title=http-origin>Origin</code>` header semantics
 <span data-anolis-ref class=informative>ORIGIN</span>
</ul>

<p>Unifying fetching provides consistent handling of:

<ul class=brief>
 <li>URL schemes
 <li>Redirects
 <li>Cross-origin semantics
 <li>CSP <span data-anolis-ref>CSP</span>
 <li>Service workers <span data-anolis-ref>SW</span>
 <li>Mixed Content <span data-anolis-ref>MIX</span>
 <li>`<code title>Referer</code>` <span data-anolis-ref>REFERRER</span>
</ul>



<h2 id=preface class=short>Preface</h2>

<p>At a high level, fetching a resource is a fairly simple operation. A request goes in, a
response comes out. <!--You can't explain that! -->The details of that operation are
however quite involved and used to not be written down carefully and differ from one API
to the next.

<p>Numerous APIs provide the ability to fetch a resource, e.g. HTML's <code>img</code> and
<code>script</code> element, CSS' <code>cursor</code> and <code>list-style-image</code>,
the <code>navigator.sendBeacon()</code> and <code>self.importScripts()</code> JavaScript
APIs. The Fetch Standard provides a unified architecture for these features so they are
all consistent when it comes to various aspects of fetching, such as redirects and the
CORS protocol.

<p>The Fetch Standard also defines the <code title=dom-global-fetch>fetch()</code>
JavaScript API, which exposes most of the networking functionality at a fairly low level
of abstraction.



<h2 id=conformance class="short">Conformance</h2>

<p>All diagrams, examples, and notes in this specification are
non-normative, as are all sections explicitly marked non-normative.
Everything else in this specification is normative.

<p>The key words "MUST", "MUST NOT", "REQUIRED", <!--"SHALL", "SHALL
NOT",--> "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and
"OPTIONAL" in the normative parts of this specification are to be
interpreted as described in RFC2119. For readability, these words do
not appear in all uppercase letters in this specification.
<span data-anolis-ref>RFC2119</span>



<h2 id=infrastructure>Infrastructure</h2>

<p>This specification uses terminology from the ABNF, Encoding, HTML, IDL, Streams, and URL Standards.
<span data-anolis-ref>ABNF</span>
<span data-anolis-ref>ENCODING</span>
<span data-anolis-ref>HTML</span>
<span data-anolis-ref>WEBIDL</span>
<span data-anolis-ref>STREAMS</span>
<span data-anolis-ref>URL</span>

<p>A <span data-anolis-spec=encoding>byte</span> sequence with bytes in the range 0x00 to
0x7F, inclusive, is represented as a <span data-anolis-spec=encoding>utf-8</span>-encoded
<span data-anolis-spec=encoding>string</span> with code points in the range U+0000 to
U+007F, inclusive. To avoid confusion with an actual string, backticks are used.

<p id=example-string-vs-byte class=example>"<code title>true</code>" is a
<span data-anolis-spec=encoding>string</span>, while `<code title>true</code>` is a byte sequence.

<p>Comparing two byte sequences in a <dfn>byte-case-insensitive</dfn> manner means
comparing them exactly, byte for byte, except that the bytes in the range 0x41 to 0x5A,
inclusive, are considered to also match their corresponding byte in the range 0x61 to
0x7A, inclusive.

<p>A <dfn>case-insensitive byte sequence</dfn> is a byte sequence that when compared to
another byte sequence does so in a <span>byte-case-insensitive</span> manner.

<p id=example-case-insensitive-byte-sequence class=example>The
<span title="case-insensitive byte sequence">case-insensitive byte sequences</span>
`<code title>Content-Type</code>` and `<code title>content-TYPE</code>` are equal.

<p>To <dfn>byte-lowercase</dfn> a byte sequence, increase each byte it contains, in the
range 0x41 to 0x5A, inclusive, by 0x20.

<p>To <dfn>byte-uppercase</dfn> a byte sequence, subtract each byte it contains, in the
range 0x61 to 0x7A, inclusive, by 0x20.

<hr>

<p id="fetch-url">A <dfn>response URL</dfn> is a
<span data-anolis-spec=url title=concept-url>URL</span> for which implementations need not store the
<span data-anolis-spec=url title=concept-url-fragment>fragment</span> as it is never exposed. When
<span data-anolis-spec=url title=concept-url-serializer>serialized</span>, the
<i title>exclude fragment flag</i> is set, meaning implementations can store the
<span data-anolis-spec=url title=concept-url-fragment>fragment</span> nonetheless.

<hr>

<p><dfn>Credentials</dfn> are HTTP cookies, TLS client certificates, and
<span title="authentication entry">authentication entries</span>.

<hr>

<p><span data-anolis-spec=html title=concept-task>Tasks</span> that are
<span data-anolis-spec=html title="queue a task">queued</span> by this standard are annotated as one
of:

<ul class=brief>
 <li><dfn>process request body</dfn>
 <li id=process-request-end-of-file><dfn>process request end-of-body</dfn>
 <li><dfn>process response</dfn>
 <li id=process-response-end-of-file><dfn>process response end-of-body</dfn>
 <li><dfn>process response done</dfn>
</ul>

<p>To <dfn>queue a fetch task</dfn> on <span title=concept-request>request</span>
<var>request</var> to <var>run an operation</var>, run these steps:

<ol>
 <li><p>If <var>request</var>'s <span title=concept-request-client>client</span> is
 null, terminate these steps.

 <li><p><span data-anolis-spec=html>Queue a task</span> to
 <var>run an operation</var> on <var>request</var>'s
 <span title=concept-request-client>client</span>'s
 <span data-anolis-spec=html>responsible event loop</span> using the
 <span data-anolis-spec=html>networking task source</span>.
</ol>

<p>To <dfn>queue a fetch-request-done task</dfn>, given a <var>request</var>,
<span>queue a fetch task</span> on <var>request</var> to <span>process request end-of-body</span>
for <var>request</var>.

<hr>

<p>To <dfn>read a <var>request</var></dfn>, if <var>request</var>'s
<span title=concept-request-body>body</span> is non-null, whenever
<var>request</var>'s <span title=concept-request-body>body</span> is read from (i.e.
is transmitted or read by script), increase <var>request</var>'s
<span title=concept-request-body>body</span>'s
<span title=concept-body-transmitted>transmitted bytes</span> with the amount of payload body
bytes transmitted and then <span>queue a fetch task</span> on <var>request</var> to
<span>process request body</span> for <var>request</var>.
<!-- XXX xref "read", "payload body" -->


<h3 id=http>HTTP</h3>

<p>While <span title=concept-fetch>fetching</span> encompasses more than just HTTP, it
borrows a number of concepts from HTTP and applies these to resources obtained via other
means (e.g., <code title>data</code> URLs).

<p>The <dfn data-export>HTTP whitespace bytes</dfn> are 0x09, 0x0A, 0x0D, and 0x20.

<p>An <dfn title=concept-https-state-value data-export>HTTPS state value</dfn> is "<code title>none</code>",
"<code title>deprecated</code>", or "<code title>modern</code>".

<p class="note no-backref">A <span title=concept-response>response</span> delivered over HTTPS will
typically have its <span title=concept-response-https-state>HTTPS state</span> set to
"<code title>modern</code>". A user agent can use "<code title>deprecated</code>" in a transition
period. E.g., while removing support for a hash function, weak cypher suites, certificates for an
"Internal Name", or certificates with an overly long validity period. How exactly a user agent can
use "<code title>deprecated</code>" is not defined by this specification. An
<span data-anolis-spec=html>environment settings object</span> typically derives its
<span data-anolis-spec=html>HTTPS state</span> from a <span title=concept-response>response</span>.


<h4 id=methods>Methods</h4>

<p>A <dfn title=concept-method data-export>method</dfn> is a byte sequence that matches the
<span data-anolis-spec=http>method</span> token production.

<p id=simple-method>A <dfn data-export>CORS-safelisted method</dfn> is a
<span title=concept-method>method</span> that is `<code title>GET</code>`,
`<code title>HEAD</code>`, or `<code title>POST</code>`.

<p>A <dfn data-export>forbidden method</dfn> is a <span title=concept-method>method</span> that is a
<span>byte-case-insensitive</span> match for `<code title>CONNECT</code>`,
`<code title>TRACE</code>`, or `<code title>TRACK</code>`.
<span data-anolis-ref class=informative>HTTPVERBSEC</span>

<p>To <dfn title=concept-method-normalize data-export data-dfn-for=method>normalize</dfn> a
<span title=concept-method>method</span>, if it is a <span>byte-case-insensitive</span>
match for `<code title>DELETE</code>`, `<code title>GET</code>`,
`<code title>HEAD</code>`, `<code title>OPTIONS</code>`, `<code title>POST</code>`, or
`<code title>PUT</code>`, <span>byte-uppercase</span> it.

<p class="note no-backref"><span title=concept-method-normalize>Normalization</span> is
done for backwards compatibility and consistency across APIs as
<span title=concept-method>methods</span> are actually "case-sensitive".

<p id=example-normalization class=example>Using `<code title>patch</code>` is highly likely to
result in a `<code title>405 Method Not Allowed</code>`. `<code title>PATCH</code>` is much more
likely to succeed.

<p class="note no-backref">There are no restrictions on <span title=concept-method>methods</span>.
`<code title>CHICKEN</code>` is perfectly acceptable (and not a misspelling of
`<code title>CHECKIN</code>`). Other than those that are
<span title=concept-method-normalize>normalized</span> there are no casing restrictions either.
`<code title>Egg</code>` or `<code title>eGg</code>` would be fine, though uppercase is encouraged
for consistency.


<h4 id=terminology-headers>Headers</h4>

<p>A <dfn title=concept-header-list dfn-export>header list</dfn> consists of zero or more
<span title=concept-header>headers</span>.

<p class="note no-backref">A <span title=concept-header-list>header list</span> is essentially a
specialized multimap. An ordered list of key-value pairs with potentially duplicate keys.

<p>To <dfn title=concept-header-list-append data-export data-dfn-for="header list">append</dfn> a
<span title=concept-header-name>name</span>/<span title=concept-header-value>value</span>
(<var>name</var>/<var>value</var>) pair to a
<span title=concept-header-list>header list</span> (<var>list</var>), append a new
<span title=concept-header>header</span> whose <span title=concept-header-name>name</span>
is <var>name</var>, <span title="byte-lowercase">byte-lowercased</span>, and
<span title=concept-header-value>value</span> is <var>value</var>, to
<var>list</var>.

<p>To <dfn title=concept-header-list-delete data-export data-dfn-for="header list">delete</dfn> a
<span title=concept-header-name>name</span> (<var>name</var>) from a
<span title=concept-header-list>header list</span> (<var>list</var>), remove all
<span title=concept-header>headers</span> whose
<span title=concept-header-name>name</span> is <var>name</var>,
<span title="byte-lowercase">byte-lowercased</span>, from <var>list</var>.

<p>To <dfn title=concept-header-list-set data-export data-dfn-for="header list">set</dfn> a
<span title=concept-header-name>name</span>/<span title=concept-header-value>value</span>
(<var>name</var>/<var>value</var>) pair in a
<span title=concept-header-list>header list</span> (<var>list</var>), run these
steps:

<ol>
 <li><p><span>Byte-lowercase</span> <var>name</var>.

 <li><p>If there are any <span title=concept-header>headers</span> in
 <var>list</var> whose <span title=concept-header-name>name</span> is
 <var>name</var>, set the <span title=concept-header-value>value</span> of the first
 such <span title=concept-header>header</span> to <var>value</var> and remove the
 others.

 <li><p>Otherwise, append a new <span title=concept-header>header</span> whose
 <span title=concept-header-name>name</span> is <var>name</var> and
 <span title=concept-header-value>value</span> is <var>value</var>, to
 <var>list</var>.
</ol>

<p>To <dfn title=concept-header-list-combine data-export data-dfn-for="header list">combine</dfn> a
<span title=concept-header-name>name</span>/<span title=concept-header-value>value</span>
(<var>name</var>/<var>value</var>) pair in a
<span title=concept-header-list>header list</span> (<var>list</var>), run these
steps:

<ol>
 <li><p><span>Byte-lowercase</span> <var>name</var>.

 <li><p>If there are any <span title=concept-header>headers</span> in <var>list</var> whose
 <span title=concept-header-name>name</span> is <var>name</var>, set the
 <span title=concept-header-value>value</span> of the first such
 <span title=concept-header>header</span> to its <span title=concept-header-value>value</span>,
 followed by `<code>,</code>`, followed by <var>value</var>.

 <li><p>Otherwise, append a new <span title=concept-header>header</span> whose
 <span title=concept-header-name>name</span> is <var>name</var> and
 <span title=concept-header-value>value</span> is <var>value</var>, to
 <var>list</var>.
</ol>

<p class="note no-backref"><span title=concept-header-list-combine>Combine</span> is used by
<code data-anolis-spec=xhr>XMLHttpRequest</code> and the
<span title=concept-websocket-establish>WebSocket protocol handshake</span>.

<p>To
<dfn title=concept-header-list-sort-and-combine data-export data-dfn-for="header list">sort and combine</dfn>
a <span title=concept-header-list>header list</span> (<var>list</var>), run these steps:

<ol>
 <li><p>Let <var>headers</var> be an empty list of
 <span title=concept-header-name>name</span>-<span title=concept-header-value>value</span> pairs
 with the key being the <span title=concept-header-name>name</span> and value the
 <span title=concept-header-value>value</span>.

 <li><p>Let <var>names</var> be all the <span title=concept-header-name>names</span> of the
 <span title=concept-header>headers</span> in <var>list</var>, with duplicates removed, and sorted
 lexicographically.

 <li>
  <p>For each <var>name</var> in <var>names</var>, run these substeps:

  <ol>
   <li><p>Let <var>value</var> be the
   <span title=concept-header-value-combined>combined value</span> given <var>name</var> and
   <var>list</var>.

   <li><p>Append <var>name</var>-<var>value</var> to <var>headers</var>.
  </ol>

 <li><p>Return <var>headers</var>.
</ol>

<hr>

<p>A <dfn title=concept-header data-export>header</dfn> consists of a
<dfn title=concept-header-name data-export data-dfn-for=header>name</dfn> and
<dfn title=concept-header-value data-export data-dfn-for=header>value</dfn>.
A <span title=concept-header-name>name</span> is a
<span>case-insensitive byte sequence</span> that matches the
<span data-anolis-spec=http>field-name</span> token production. A
<span title=concept-header-value>value</span> is a byte sequence that matches the
<span data-anolis-spec=http>field-content</span> token production.

<p class=XXX>The definition of <span title=concept-header-value>value</span>
<a href="https://github.com/whatwg/fetch/issues/332">needs serious work</a>.

<p class="note no-backref"><span data-anolis-spec=http>field-value</span> allows 0x0A and
0x0D bytes which can lead to reparsing issues.

<p>To <dfn title=concept-header-value-normalize data-export data-dfn-for=header>normalize</dfn> a
<span title=concept-header-value>value</span>, remove any leading and trailing
<span>HTTP whitespace bytes</span> from it.

<p>A <dfn title=concept-header-value-combined data-export data-dfn-for=header>combined value</dfn>,
given a <span title=concept-header-name>name</span> (<var>name</var>) and
<span title=concept-header-list>header list</span> (<var>list</var>), is the
<span title=concept-header-value>values</span> of all <span title=concept-header>headers</span> in
<var>list</var> whose <span title=concept-header-name>name</span> is <var>name</var>, separated from
each other by `<code title>,</code>`, in order.

<hr>

<p id=simple-header>A <dfn data-export>CORS-safelisted request-header</dfn> is a
<span title=concept-header>header</span> whose <span title=concept-header-name>name</span> is one of

<ul class=brief>
 <li>`<code title>Accept</code>`
 <li>`<code title>Accept-Language</code>`
 <li>`<code title>Content-Language</code>`
 <li>`<code title>Content-Type</code>` and whose <span title=concept-header-value>value</span>,
 <span title=concept-header-parse>once parsed</span>, has a MIME type (ignoring parameters)
 that is `<code title>application/x-www-form-urlencoded</code>`,
 `<code title>multipart/form-data</code>`, or `<code title>text/plain</code>`
</ul>
<!-- XXX * needs better xref
         * ignoring parameters has been the standard for a long time now
         * interesting test: "Content-Type: text/plain;" -->

<p>or whose <span title=concept-header-name>name</span> is one of

<ul class=brief>
 <li>`<code title><a href=http://httpwg.org/http-extensions/client-hints.html#dpr>DPR</a></code>`
 <li>`<code title><a href=http://httpwg.org/http-extensions/client-hints.html#downlink>Downlink</a></code>`
 <li>`<code title><a href=http://httpwg.org/http-extensions/client-hints.html#save-data>Save-Data</a></code>`
 <li>`<code title><a href=http://httpwg.org/http-extensions/client-hints.html#viewport-width>Viewport-Width</a></code>`
 <li>`<code title><a href=http://httpwg.org/http-extensions/client-hints.html#width>Width</a></code>`
</ul>

<p>and whose <span title=concept-header-value>value</span>,
<span title=concept-header-parse>once parsed</span>, is not a failure.

<p>A <dfn data-export>CORS non-wildcard request-header name</dfn> is
`<code title>Authorization</code>`.

<p>A <dfn data-export>CORS-safelisted response-header name</dfn>, given a
<span title=concept-response-cors-exposed-header-name-list>CORS-exposed header-name list</span>
<var>list</var>, is a <span title=concept-header>header</span>
<span title=concept-header-name>name</span> that is one of

<ul class=brief>
 <li>`<code title>Cache-Control</code>`
 <li>`<code title>Content-Language</code>`
 <li>`<code title>Content-Type</code>`
 <li>`<code title>Expires</code>`
 <li>`<code title>Last-Modified</code>`
 <li>`<code title>Pragma</code>`
 <li>Any <span title=concept-header-value>value</span> in <var>list</var> that is not a
 <span>forbidden response-header name</span>.
</ul>

<p>A <dfn data-export>forbidden header name</dfn> is a <span title=concept-header>header</span>
<span title=concept-header-name>name</span> that is one of

<ul class=brief>
 <li>`<code title>Accept-Charset</code>`
 <li>`<code title>Accept-Encoding</code>`
 <li>`<code title>Access-Control-Request-Headers</code>`
 <li>`<code title>Access-Control-Request-Method</code>`
 <li>`<code title>Connection</code>`
 <li>`<code title>Content-Length</code>`
 <li>`<code title>Cookie</code>`
 <li>`<code title>Cookie2</code>`
 <li>`<code title>Date</code>`
 <li>`<code title>DNT</code>`
 <li>`<code title>Expect</code>`
 <li>`<code title>Host</code>`
 <li>`<code title>Keep-Alive</code>`
 <li>`<code title=http-origin>Origin</code>`
 <li>`<code title>Referer</code>`
 <li>`<code title>TE</code>`
 <li>`<code title>Trailer</code>`
 <li>`<code title>Transfer-Encoding</code>`
 <li>`<code title>Upgrade</code>`
 <li>`<code title>Via</code>`
</ul>

<p>or a <span title=concept-header>header</span> <span title=concept-header-name>name</span> that
starts with `<code title>Proxy-</code>` or `<code title>Sec-</code>` (including being just
`<code title>Proxy-</code>` or `<code title>Sec-</code>`).

<p class=note>These are forbidden so the user agent remains in full control over them.
<span title=concept-header-name>Names</span> starting with `<code title>Sec-</code>` are
reserved to allow new <span title=concept-header>headers</span> to be minted that are safe
from APIs using <span title=concept-fetch>fetch</span> that allow control over
<span title=concept-header>headers</span> by developers, such as
<code data-anolis-spec=xhr>XMLHttpRequest</code>.
<span data-anolis-ref class=informative>XHR</span>

<p>A <dfn data-export>forbidden response-header name</dfn> is a
<span title=concept-header>header</span> <span title=concept-header-name>name</span> that is one of:

<ul class=brief>
 <li>`<code title>Set-Cookie</code>`
 <li>`<code title>Set-Cookie2</code>`
</ul>

<hr>

<p>To <dfn title=concept-header-parse dfn-export>parse a header value</dfn> given a
<span title=concept-header-name>name</span> (<var>name</var>)  and a
<span title=concept-header>header</span> or a <span title=concept-header-list>header list</span>
(<var>headers</var>), run these steps:

<ol>
 <li><p>If <var>name</var> is not in <var>headers</var>, return null.

 <li>
  <p>If the ABNF for <var>name</var> allows a single
  <span title=concept-header>header</span> and <var>headers</var> contains more than
  one, return failure.

  <p class="note no-backref">If different error handling is needed, extract the desired
  <span title=concept-header>header</span> first.

 <li><p>If parsing all the <span title=concept-header>headers</span>
 <span title=concept-header-name>named</span> <var>name</var> in
 <var>headers</var>, per the ABNF for <var>name</var>, failed, return failure.

 <li><p>Return one or more <span title=concept-header-value>values</span> resulting from
 parsing all the <span title=concept-header>headers</span>
 <span title=concept-header-name>named</span> <var>name</var> in
 <var>headers</var>, per the ABNF for <var>name</var>.
</ol>

<p>To
<dfn title=concept-header-extract-MIME-type data-export data-dfn-for="header list">extract a MIME type</dfn>
from a <span title=concept-header-list>header list</span> (<var>headers</var>), run these steps:

<ol>
 <li><p>Let <var>MIMEType</var> be the result of
 <span title=concept-header-parse>parsing</span> `<code title>Content-Type</code>` in
 <var>headers</var>.

 <li><p>If <var>MIMEType</var> is null or failure, return the empty byte sequence.

 <li><p>Return <var>MIMEType</var>,
 <span title="byte-lowercase">byte-lowercased</span>.
</ol>

<hr>

<p>A <dfn id=default-user-agent-value data-export>default `<code>User-Agent</code>` value</dfn> is a
user-agent-defined <span title=concept-header-value>value</span> for the
`<code title=http-user-agent>User-Agent</code>` <span title=concept-header>header</span>.

<h4 id=statuses>Statuses</h4>

<p>A <dfn id=concept-status data-export>status</dfn> is a code.

<p>A <dfn data-export>null body status</dfn> is a <span>status</span> that is <code>101</code>,
<code>204</code>, <code>205</code>, or <code>304</code>.

<p>An <dfn data-export>ok status</dfn> is any <span>status</span> in the range <code>200</code> to
<code>299</code>, inclusive.

<p>A <dfn data-export>redirect status</dfn> is a <span>status</span> that is <code>301</code>,
<code>302</code>, <code>303</code>, <code>307</code>, or <code>308</code>.

<h4 id=bodies>Bodies</h4>

<p>A <dfn title=concept-body data-export>body</dfn> consists of:

<ul>
 <li>
  <p>A <dfn title=concept-body-stream data-export data-dfn-for=body>stream</dfn> (a
  <code title=concept-ReadableStream>ReadableStream</code> object).

  <p class="XXX"><a href="https://github.com/whatwg/streams/issues/379">This might become a
  <code>ReadableByteStream</code> object</a>. While the type might change, the behavior specified
  will be equivalent since the hypothetical <code title>ReadableByteStream</code> object will have
  the same members as the <code title=concept-ReadableStream>ReadableStream</code> object has today.

 <li><p>A <dfn title=concept-body-transmitted data-export data-dfn-for=body>transmitted bytes</dfn>
 (an integer), initially 0.

 <li><p>A <dfn title=concept-body-total-bytes data-export data-dfn-for=body>total bytes</dfn> (an
 integer), initially 0.
</ul>

<p>A <span title=concept-body>body</span> <var>body</var> is said to be
<dfn title=concept-body-done data-export data-dfn-for=body>done</dfn> if <var>body</var> is null or
<var>body</var>'s <span title=concept-body-stream>stream</span> is
<span title=concept-ReadableStream-closed>closed</span> or
<span title=concept-ReadableStream-errored>errored</span>.

<p>To <dfn title=concept-body-wait data-export data-dfn-for=body>wait</dfn> for a
<span title=concept-body>body</span> <var>body</var>, wait for <var>body</var> to be
<span title=concept-body-done>done</span>.

<p>To <dfn title=concept-body-clone data-export data-dfn-for=body>clone</dfn> a
<span title=concept-body>body</span> <var>body</var>, run these steps:

<ol>
 <li><p>Let «<var>out1</var>, <var>out2</var>» be the result of
 <span title=concept-tee-ReadableStream>teeing</span> <var>body</var>'s
 <span title=concept-body-stream>stream</span>. Rethrow any exceptions.

 <li><p>Set <var>body</var>'s <span title=concept-body-stream>stream</span> to <var>out1</var>.

 <li><p>Return a <span title=concept-body>body</span> whose
 <span title=concept-body-stream>stream</span> is <var>out2</var> and other members are copied from
 <var>body</var>.
</ol>

<p>To <dfn data-export>handle content codings</dfn> given <var>codings</var> and
<var>bytes</var>, run these substeps:

<ol>
 <li><p>If <var>codings</var> are not supported, return <var>bytes</var>.

 <li><p>Return the result of decoding bytes with the given
 <var>codings</var> as explained in HTTP. <span data-anolis-ref>HTTP</span>
</ol>
<!-- XXX no hook in HTTP -->

<h4 id=requests>Requests</h4>

<p>The input to <span title=concept-fetch>fetch</span> is a
<dfn title=concept-request data-export>request</dfn>.

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-method data-export data-dfn-for=request>method</dfn> (a
<span title=concept-method>method</span>). Unless stated otherwise it is
`<code title>GET</code>`.

<p class="note no-backref">This can be updated during redirects to `<code title>GET</code>` as
described in <span title=concept-http-fetch>HTTP fetch</span>.

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-url data-export data-dfn-for=request>url</dfn> (a
<span data-anolis-spec=url title=concept-url>URL</span>).

<p class="note no-backref">Implementations are encouraged to make this a pointer to the first
<span data-anolis-spec=url title=concept-url>URL</span> in
<span title=concept-request>request</span>'s <span title=concept-request-url-list>url list</span>.
It is provided as a distinct field solely for the convenience of other standards hooking into Fetch.

<p>A <span title=concept-request>request</span> has an associated
<dfn data-export data-dfn-for=request>local-URLs-only flag</dfn>. Unless stated otherwise it is
unset.

<p>A <span title=concept-request>request</span> has an associated
<dfn data-export data-dfn-for=request>sandboxed-storage-area-URLs flag</dfn>. Unless stated
otherwise it is unset.

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-header-list data-export data-dfn-for=request>header list</dfn> (a
<span title=concept-header-list>header list</span>). Unless stated otherwise it is empty.

<p>A <span title=concept-request>request</span> has an associated
<dfn data-export data-dfn-for=request>unsafe-request flag</dfn>. Unless stated otherwise it is
unset.

<p class="note no-backref">The <span>unsafe-request flag</span> is set by APIs such as
<code title=dom-global-fetch>fetch()</code>  and
<code data-anolis-spec=xhr>XMLHttpRequest</code> to ensure a
<span>CORS-preflight fetch</span> is done based on the supplied
<span title=concept-request-method>method</span> and
<span title=concept-request-header-list>header list</span>. It does not free an API from
outlawing <span title="forbidden method">forbidden methods</span> and
<span title="forbidden header name">forbidden header names</span>.

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-body data-export data-dfn-for=request>body</dfn> (null or a
<span title=concept-body>body</span>). Unless stated otherwise it is null.

<p class="note no-backref">This can be updated during redirects to null as described in
<span title=concept-http-fetch>HTTP fetch</span>.

<hr>

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-client data-export data-dfn-for=request>client</dfn> (null or an
<span data-anolis-spec=html>environment settings object</span>).

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-reserved-client data-export data-dfn-for=request>reserved client</dfn>
(null, an <span data-anolis-spec=html>environment</span>, or an
<span data-anolis-spec=html>environment settings object</span>). Unless stated otherwise it is null.

<p class="note no-backref">This is only used by <span>navigation requests</span> and worker
requests, but not service worker requests. It references an
<span data-anolis-spec=html>environment</span> for a <span>navigation request</span> and an
<span data-anolis-spec=html>environment settings object</span> for a worker request.

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-target-client-id data-export data-dfn-for=request>target client id</dfn>
(a string). Unless stated otherwise it is the empty string.

<p class="note no-backref">This is only used by <span>navigation requests</span>. It is the
<span title=concept-environment-id data-anolis-spec=html>id</span> of the
<span data-anolis-spec=html>target browsing context</span>'s
<span data-anolis-spec=html>active document</span>'s
<span data-anolis-spec=html>environment settings object</span>.

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-window data-export data-dfn-for=request>window</dfn>
("<code>no-window</code>", "<code>client</code>", or an
<span data-anolis-spec=html>environment settings object</span> whose
<span data-anolis-spec=html title=concept-settings-object-global>global object</span> is a
<code data-anolis-spec=html>Window</code> object). Unless stated otherwise it is
"<code>client</code>".

<p class="note no-backref">The "<code>client</code>" value is changed to "<code>no-window</code>" or
<span title=concept-request>request</span>'s <span title=concept-request-client>client</span> during
<span title=concept-fetch>fetching</span>. It provides a convenient way for standards to not have to
explicitly set <span title=concept-request>request</span>'s
<span title=concept-request-window>window</span>.

<p id=keep-alive-flag>A <span title=concept-request>request</span> has an associated
<dfn>keepalive flag</dfn>. Unless stated otherwise it is unset.

<p class="note no-backref">This can be used to allow the request to outlive the
<span data-anolis-spec=html>environment settings object</span>, e.g.,
<code>navigator.sendBeacon</code> and the HTML <code>img</code> element set this flag. Requests with
this flag set are subject to additional processing requirements.

<p>A <span title=concept-request>request</span> has an associated
<dfn data-export data-dfn-for=request>skip-service-worker flag</dfn>. Unless stated otherwise it is
unset.

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-initiator data-export data-dfn-for=request>initiator</dfn>, which is
the empty string,
"<code title>download</code>",
"<code title>imageset</code>",
"<code title>manifest</code>", or
"<code title>xslt</code>". Unless stated otherwise it is the empty string.

<p class="note no-backref">A <span title=concept-request>request</span>'s
<span title=concept-request-initiator>initiator</span> is not particularly granular for
the time being as other specifications do not require it to. It is primarily a
specification device to assist defining CSP and Mixed Content. It is not exposed to
JavaScript. <span data-anolis-ref>CSP</span> <span data-anolis-ref>MIX</span>

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-type data-export data-dfn-for=request>type</dfn>, which is
the empty string,
"<code title>audio</code>",
"<code title>font</code>",
"<code title>image</code>",
"<code title>script</code>",
"<code title>style</code>",
"<code title>track</code>", or
"<code title>video</code>". Unless stated otherwise it is the empty string.

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-destination data-export data-dfn-for=request>destination</dfn>, which is
the empty string,
"<code title>document</code>",
"<code title>embed</code>",
"<code title>font</code>",
"<code title>image</code>",
"<code title>manifest</code>",
"<code title>media</code>",
"<code title>object</code>",
"<code title>report</code>",
"<code title>script</code>",
"<code title>serviceworker</code>",
"<code title>sharedworker</code>",
"<code title>style</code>",
"<code title>worker</code>", or
"<code title>xslt</code>". Unless stated otherwise it is the empty string.

<div class=note>
 <p>The following table illustrates the relationship between a
 <span title=concept-request>request</span>'s
 <span title=concept-request-initiator>initiator</span>,
 <span title=concept-request-type>type</span>,
 <span title=concept-request-destination>destination</span>, CSP directives, and features.

 <table>
  <tr>
   <th><span title=concept-request-initiator>Initiator</span>
   <th><span title=concept-request-type>Type</span>
   <th><span title=concept-request-destination>Destination</span>
   <th>CSP directive
   <th>Features
  <tr>
   <td rowspan=16>""
   <td rowspan=6>""
   <td>"<code title>report</code>"
   <td rowspan=2>?
   <td>CSP, NEL reports.
  <tr>
   <td>"<code title>document</code>"
   <td>HTML's navigate algorithm.
  <tr>
   <td>"<code title>document</code>"
   <td><code title>child-src</code>
   <td>HTML's <code>&lt;iframe></code> and <code>&lt;frame></code>
  <tr>
   <td>""
   <td><code title>connect-src</code>
   <td><code>navigator.sendBeacon()</code>, <code>EventSource</code>,
   HTML's <code>ping=""</code>, <code title=dom-global-fetch>fetch()</code>,
   <code>XMLHttpRequest</code>, <code>WebSocket</code>, Cache API?
  <tr>
   <td>"<code title>object</code>"
   <td><code title>object-src</code>
   <td>HTML's <code>&lt;object></code>
  <tr>
   <td>"<code title>embed</code>"
   <td><code title>object-src</code>
   <td>HTML's <code>&lt;embed></code>
  <tr>
   <td>"<code title>audio</code>"
   <td>"<code title>media</code>"
   <td><code title>media-src</code>
   <td>HTML's <code>&lt;audio></code>
  <tr>
   <td>"<code title>font</code>"
   <td>"<code title>font</code>"
   <td><code title>font-src</code>
   <td>CSS' <code>@font-face</code>
  <tr>
   <td>"<code title>image</code>"
   <td>"<code title>image</code>"
   <td><code title>img-src</code>
   <td>HTML's <code>&lt;img src></code>, <code title>/favicon.ico</code> resource,
   SVG's <code>&lt;image></code>, CSS' <code>background-image</code>, CSS'
   <code>cursor</code>, CSS' <code>list-style-image</code>, &hellip;
  <tr>
   <td rowspan=4>"<code title>script</code>"
   <td>"<code title>script</code>"
   <td><code title>script-src</code>
   <td>HTML's <code>&lt;script></code>, <code>importScripts()</code>
  <tr>
   <td>"<code title>serviceworker</code>"
   <td>?
   <td><code title>navigator.serviceWorker.register()</code>
  <tr>
   <td>"<code title>sharedworker</code>"
   <td><code title>child-src</code>
   <td><code>SharedWorker</code>
  <tr>
   <td>"<code title>worker</code>"
   <td><code title>child-src</code>
   <td><code>Worker</code>
  <tr>
   <td>"<code title>style</code>"
   <td>"<code title>style</code>"
   <td><code title>style-src</code>
   <td>HTML's <code>&lt;link rel=stylesheet></code>, CSS' <code>@import</code>
  <tr>
   <td>"<code title>track</code>"
   <td>"<code title>media</code>"
   <td><code title>media-src</code>
   <td>HTML's <code>&lt;track></code>
  <tr>
   <td>"<code title>video</code>"
   <td>"<code title>media</code>"
   <td><code title>media-src</code>
   <td>HTML's <code>&lt;video></code> element
  <tr>
   <td>"<code title>download</code>"
   <td>""
   <td>""
   <td>?
   <td>HTML's <code>download=""</code>, "Save Link As&hellip;" UI
  <tr>
   <td>"<code title>imageset</code>"
   <td>"<code title>image</code>"
   <td>"<code title>image</code>"
   <td><code title>img-src</code>
   <td>HTML's <code>&lt;img srcset></code> and <code>&lt;picture></code>
  <tr>
   <td>"<code title>manifest</code>"
   <td rowspan=2>""
   <td>"<code title>manifest</code>"
   <td><code title>manifest-src</code>
   <td>HTML's <code>&lt;link rel=manifest></code>
  <tr>
   <td>"<code title>xslt</code>"
   <td>"<code title>xslt</code>"
   <td><code title>script-src</code>
   <td><code>&lt;?xml-stylesheet></code>
 </table>

 <p>CSP's <code>form-action</code> needs to be a hook directly in HTML's navigate or form
 submission algorithm.

 <p>CSP will also need to check
 <span title=concept-request>request</span>'s
 <span title=concept-request-client>client</span>'s
 <span data-anolis-spec=html>browsing context</span>'s
 <span data-anolis-spec=html title="ancestor browsing context">ancestor browsing contexts</span>
  for various CSP directives.
</div>

<hr>

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-priority data-export data-dfn-for=request>priority</dfn> (null or a
user-agent-defined object). Unless otherwise stated it is null.

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-origin data-export data-dfn-for=request>origin</dfn>, which is
"<code>client</code>" or an <span data-anolis-spec=html>origin</span>. Unless stated otherwise it is
"<code>client</code>".

<p class="note no-backref">"<code>client</code>" is changed to an
<span data-anolis-spec=html>origin</span> during <span title=concept-fetch>fetching</span>. It
provides a convenient way for standards to not have to set
<span title=concept-request>request</span>'s <span title=concept-request-origin>origin</span>.
<span title=concept-request>Request</span>'s <span title=concept-request-origin>origin</span> can be
changed during redirects too.

<p>A <span title=concept-request>request</span> has an associated
<dfn data-export data-dfn-for=request>omit-<code>Origin</code>-header flag</dfn>. Unless stated
otherwise it is unset.

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-referrer data-export data-dfn-for=request>referrer</dfn>, which is
"<code>no-referrer</code>", "<code>client</code>", or a
<span data-anolis-spec=url title=concept-url>URL</span>. Unless stated otherwise it is
"<code>client</code>".

<p class="note no-backref">"<code>client</code>" is changed to "<code>no-referrer</code>" or a
<span data-anolis-spec=url title=concept-url>URL</span> during
<span title=concept-fetch>fetching</span>. It provides a convenient way for standards to not have to
set <span title=concept-request>request</span>'s
<span title=concept-request-referrer>referrer</span>.

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-referrer-policy data-export data-dfn-for=request>referrer policy</dfn>,
which is a <span data-anolis-spec=referrer>referrer policy</span>. Unless stated otherwise it is
the empty string. <span data-anolis-ref>REFERRER</span>

<p class="note no-backref">This can be used to override a referrer policy associated with an
<span data-anolis-spec=html>environment settings object</span>.


<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-client-hints-list data-export data-dfn-for=request>client hints list</dfn>,
which is a <span title=concept-client-hints-list>client-hints list</span>. Unless stated
otherwise, it is the empty list.

<p class="note no-backref">This will be used to override a client hints list associated with
an <span data-anolis-spec=html>environment settings object</span>.
<span data-anolis-ref>CLIENT-HINTS</span>

<p>A <span title=concept-request>request</span> has an associated
<dfn data-export data-dfn-for=request>synchronous flag</dfn>. Unless stated otherwise it is unset.

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-mode data-export data-dfn-for=request>mode</dfn>, which is
"<code title>same-origin</code>", "<code title>cors</code>", "<code title>no-cors</code>",
"<code title>navigate</code>", or "<code title>websocket</code>". Unless stated otherwise, it is
"<code title>no-cors</code>".

<p class="note no-backref">Even though the default <span title=concept-request>request</span>
<span title=concept-request-mode>mode</span> is "<code title>no-cors</code>", standards are highly
discouraged from using it for new features. It is rather unsafe. "<code title>navigate</code>" and
"<code title>websocket</code>" are special values for the HTML Standard.
<span data-anolis-ref>HTML</span>

<p>A <span title=concept-request>request</span> has an associated
<dfn data-export data-dfn-for=request>use-CORS-preflight flag</dfn>. Unless stated otherwise, it is
unset.

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-credentials-mode data-export data-dfn-for=request>credentials mode</dfn>,
which is "<code title>omit</code>", "<code title>same-origin</code>", or
"<code title>include</code>". Unless stated otherwise, it is "<code title>omit</code>".

<p class="note no-backref"><span title=concept-request>Request</span>'s
<span title=concept-request-credentials-mode>credentials mode</span> controls the flow of
<span>credentials</span> during a <span title=concept-fetch>fetch</span>. When
<span title=concept-request>request</span>'s <span title=concept-request-mode>mode</span> is
"<code title>navigate</code>", its
<span title=concept-request-credentials-mode>credentials mode</span> is assumed to be
"<code title>include</code>" and <span title=concept-fetch>fetch</span> does not currently account
for other values. If <cite>HTML</cite> changes here, this standard will need corresponding changes.

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-use-url-credentials-flag data-export data-dfn-for=request>use-URL-credentials flag</dfn>.
Unless stated otherwise, it is unset.

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-cache-mode data-export data-dfn-for=request>cache mode</dfn>, which is
"<code title>default</code>", "<code title>no-store</code>", "<code title>reload</code>",
"<code title>no-cache</code>", "<code title>force-cache</code>", or
"<code title>only-if-cached</code>". Unless stated otherwise, it is "<code title>default</code>".

<div class="note no-backref">
 <dl>
  <dt>"<code title>default</code>"
  <dd><span title=concept-fetch>Fetch</span> will inspect the HTTP cache on the way to the network.
  If there is a fresh response it will be used. If there is a stale response a conditional request
  will be created, and a normal request otherwise. It then updates the HTTP cache with the response.
  <span data-anolis-ref>HTTP</span>

  <dt>"<code title>no-store</code>"
  <dd>Fetch behaves as if there is no HTTP cache at all.

  <dt>"<code title>reload</code>"
  <dd>Fetch behaves as if there is no HTTP cache on the way to the network. Ergo, it creates a
  normal request and updates the HTTP cache with the response.

  <dt>"<code title>no-cache</code>"
  <dd>Fetch creates a conditional request if there is a response in the HTTP cache and a normal
  request otherwise. It then updates the HTTP cache with the response.

  <dt>"<code title>force-cache</code>"
  <dd>Fetch uses any response in the HTTP cache matching the request, not paying attention to
  staleness. If there was no response, it creates a normal request and updates the HTTP cache with
  the response.

  <dt>"<code title>only-if-cached</code>"
  <dd>Fetch uses any response in the HTTP cache matching the request, not paying attention to
  staleness. If there was no response, it returns a network error. (Can only be used when
  <span title=concept-request>request</span>'s <span title=concept-request-mode>mode</span> is
  "<code title>same-origin</code>". Any cached redirects will be followed assuming
  <span title=concept-request>request</span>'s
  <span title=concept-request-redirect-mode>redirect mode</span> is "<code>follow</code>" and the
  redirects do not violate <span title=concept-request>request</span>'s
  <span title=concept-request-mode>mode</span>.)
 </dl>

 <p>If <span title=concept-request-header-list>header list</span> contains a
 <span title=concept-header>header</span> whose <span title=concept-header-name>name</span> is one
 of
 `<code title>If-Modified-Since</code>`,
 `<code title>If-None-Match</code>`,
 `<code title>If-Unmodified-Since</code>`,
 `<code title>If-Match</code>`, and
 `<code title>If-Range</code>`,
 <span title=concept-fetch>fetch</span> will set
 <span title=concept-request-cache-mode>cache mode</span> to "<code title>no-store</code>" if it is
 "<code title>default</code>".
</div>

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-redirect-mode data-export data-dfn-for=request>redirect mode</dfn>, which is
"<code title>follow</code>", "<code title>error</code>", or "<code title>manual</code>".
Unless stated otherwise, it is "<code title>follow</code>".

<p>A <span title=concept-request>request</span> has associated
<dfn title=concept-request-integrity-metadata data-export data-dfn-for=request>integrity metadata</dfn>
(a string). Unless stated otherwise, it is the empty string.

<p>A <span title=concept-request>request</span> has associated
<dfn title=concept-request-nonce-metadata data-export data-dfn-for=request>cryptographic nonce metadata</dfn>
(a string). Unless stated otherwise, it is the empty string.

<p>A <span title=concept-request>request</span> has associated
<dfn title=concept-request-parser-metadata data-export data-dfn-for=request>parser metadata</dfn>
which is the empty string, "<code title>parser-inserted</code>", or
"<code title>not-parser-inserted</code>". Unless otherwise stated, it is the empty string.

<p class="note no-backref">A <span title=concept-request>request</span>'s
<span title=concept-request-url-list>cryptographic nonce metadata</span> and
<span title=concept-request-parser-metadata>parser metadata</span> are generally populated from
attributes and flags on the HTML element responsible for triggering a fetch. They are used by
various algorithms in <span data-anolis-ref>CSP</span> to determine whether requests or responses
should be blocked in a given context.

<hr>

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-url-list data-export data-dfn-for=request>url list</dfn> (a list of one
or more <span data-anolis-spec=url title=concept-url>URLs</span>). Unless stated otherwise, it is a
list containing a copy of <span title=concept-request>request</span>'s
<span title=concept-request-url>url</span>.

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-current-url data-export data-dfn-for=request>current url</dfn>. It is a
pointer to the last <span data-anolis-spec=url title=concept-url>URL</span> in
<span title=concept-request>request</span>'s <span title=concept-request-url-list>url list</span>.

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-redirect-count data-export data-dfn-for=request>redirect count</dfn>.
Unless stated otherwise, it is zero.

<p>A <span title=concept-request>request</span> has an associated
<dfn title=concept-request-response-tainting data-export data-dfn-for=request>response tainting</dfn>,
which is "<code title>basic</code>", "<code title>cors</code>", or "<code title>opaque</code>".
Unless stated otherwise, it is "<code title>basic</code>".

<p>A <span title=concept-request>request</span> has an associated
<dfn data-export data-dfn-for=request>done flag</dfn>. Unless stated otherwise, it is unset.

<p class="note no-backref">A <span title=concept-request>request</span>'s
<span title=concept-request-url-list>url list</span>,
<span title=concept-request-current-url>current url</span>,
<span title=concept-request-redirect-count>redirect count</span>,
<span title=concept-request-response-tainting>response tainting</span>, and
<span>done flag</span> are used as bookkeeping details by the
<span title=concept-fetch>fetch</span> algorithm.

<hr>

<p>A <dfn data-export>subresource request</dfn> is a <span title=concept-request>request</span>
whose <span title=concept-request-destination>destination</span> is "<code title>font</code>",
"<code title>image</code>", "<code title>manifest</code>", "<code title>media</code>",
"<code title>script</code>", "<code title>style</code>", "<code title>xslt</code>", or the empty
string.

<p>A <dfn data-export>potential-navigation-or-subresource request</dfn> is a
<span title=concept-request>request</span> whose
<span title=concept-request-destination>destination</span> is
"<code title>object</code>" or "<code title>embed</code>".

<p>A <dfn data-export>non-subresource request</dfn> is a <span title=concept-request>request</span>
whose <span title=concept-request-destination>destination</span> is "<code title>document</code>",
"<code title>report</code>", "<code title>serviceworker</code>", "<code title>sharedworker</code>",
or "<code title>worker</code>".

<p>A <dfn data-export>navigation request</dfn> is a <span title=concept-request>request</span> whose
<span title=concept-request-destination>destination</span> is
"<code title>document</code>".

<p class=note>See <span data-anolis-spec=sw>handle fetch</span> for usage of these terms.
<span data-anolis-ref>SW</span>

<p>To <dfn title=concept-request-clone data-export data-dfn-for=request>clone</dfn> a
<span title=concept-request>request</span> <var>request</var>, run these steps:

<ol>
 <li><p>Let <var>newRequest</var> be a copy of <var>request</var>, except for its
 <span title=concept-request-body>body</span>.

 <li><p>If <var>request</var>'s <span title=concept-request-body>body</span> is non-null, set
 <var>newRequest</var>'s <span title=concept-request-body>body</span> to the result of
 <span title=concept-body-clone>cloning</span> <var>request</var>'s
 <span title=concept-request-body>body</span>. Rethrow any exceptions.

 <li><p>Return <var>newRequest</var>.
</ol>


<h4 id=responses>Responses</h4>

<p>The result of <span title=concept-fetch>fetch</span> is a
<dfn title=concept-response data-export>response</dfn>. A <span title=concept-response>response</span>
evolves over time. That is, not all its fields are available straight away.

<p>A <span title=concept-response>response</span> has an associated
<dfn title=concept-response-type data-export data-dfn-for=response>type</dfn> which is
"<code title>basic</code>",
"<code title>cors</code>",
"<code title>default</code>",
"<code title>error</code>",
"<code title>opaque</code>", or
"<code title>opaqueredirect</code>".
Unless stated otherwise, it is "<code title>default</code>".

<p>A <span title=concept-response>response</span> can have an associated
<dfn title=concept-response-termination-reason data-export data-dfn-for=response>termination reason</dfn>
which is <i title>end-user abort</i>, <i title>fatal</i>, or <i title>timeout</i>.

<p>A <span title=concept-response>response</span> has an associated
<dfn title=concept-response-url data-export data-dfn-for=response>url</dfn>. It is a pointer to the
last <span>response URL</span> in <span title=concept-response>response</span>'s
<span title=concept-response-url-list>url list</span> and null if
<span title=concept-response>response</span>'s <span title=concept-response-url-list>url list</span>
is the empty list.

<p>A <span title=concept-response>response</span> has an associated
<dfn title=concept-response-url-list data-export data-dfn-for=response>url list</dfn> (a list of
zero or more <span title="response URL">response URLs</span>). Unless stated otherwise, it is the
empty list.

<p class="note no-backref">Except for the last <span>response URL</span>, if any, a
<span title=concept-response>response</span>'s <span title=concept-response-url-list>url list</span>
cannot be exposed to script. That would violate <span>atomic HTTP redirect handling</span>.

<p>A <span title=concept-response>response</span> has an associated
<dfn title=concept-response-status data-export data-dfn-for=response>status</dfn>, which is a
<span>status</span>. Unless stated otherwise it is <code>200</code>.

<p>A <span title=concept-response>response</span> has an associated
<dfn title=concept-response-status-message data-export data-dfn-for=response>status message</dfn>.
Unless stated otherwise it is `<code title>OK</code>`.

<p>A <span title=concept-response>response</span> has an associated
<dfn title=concept-response-header-list data-export data-dfn-for=response>header list</dfn> (a
<span title=concept-header-list>header list</span>). Unless stated otherwise it is empty.

<p>A <span title=concept-response>response</span> has an associated
<dfn title=concept-response-body data-export data-dfn-for=response>body</dfn> (null or a
<span title=concept-body>body</span>). Unless stated otherwise it is null.

<p>A <span title=concept-response>response</span> has an associated
<dfn title=concept-response-trailer data-export data-dfn-for=response>trailer</dfn> (a
<span title=concept-header-list>header list</span>). Unless stated otherwise it is empty.

<p>A <span title=concept-response>response</span> has an associated
<dfn title=concept-response-https-state data-export data-dfn-for=response>HTTPS state</dfn> (an
<span title=concept-https-state-value>HTTPS state value</span>). Unless stated otherwise, it is
"<code title>none</code>".

<p>A <span title=concept-response>response</span> has an associated
<dfn title=concept-response-csp-list data-export data-dfn-for=response>CSP list</dfn>, which is a
list of <a href=https://w3c.github.io/webappsec-csp/#policy>Content Security Policy objects</a>
for the <span title=concept-response>response</span>. The list is empty unless otherwise
specified. <span data-anolis-ref>CSP</span>

<p>A <span title=concept-response>response</span> has an associated
<dfn title=concept-response-cors-exposed-header-name-list data-export data-dfn-for=response>CORS-exposed header-name list</dfn>
(a list of zero or more <span title=concept-header>header</span>
<span title=concept-header-name>names</span>). The list is empty unless otherwise specified.

<p class="note no-backref">A <span title=concept-response>response</span> will typically get its
<span title=concept-response-cors-exposed-header-name-list>CORS-exposed header-name list</span>
set by <span title=concept-header-parse>parsing</span> the
`<code title=http-access-control-expose-headers>Access-Control-Expose-Headers</code>` header. This
list is used by a <span title=concept-filtered-response-cors>CORS filtered response</span> to
determine which headers to expose.

<p>A <span title=concept-response>response</span> can have an associated
<dfn title=concept-response-location-url data-export data-dfn-for=response>location URL</dfn> (null,
failure, or a <span data-anolis-spec=url title=concept-url>URL</span>). Unless specified otherwise,
<span title=concept-response>response</span> has no
<span title=concept-response-location-url>location URL</span>.

<p class="note no-backref">This concept is used for redirect handling in Fetch and in HTML's
navigate algorithm. It ensures `<code title>Location</code>` is
<span title=concept-header-parse>parsed</span> consistently and only once.
<span data-anolis-ref>HTML</span>

<hr>

<p>A <span title=concept-response>response</span> whose
<span title=concept-response-type>type</span> is "<code title>error</code>" is known as a
<dfn title=concept-network-error data-export>network error</dfn>.

<p>A <span title=concept-network-error>network error</span> is a
<span title=concept-response>response</span> whose
<span title=concept-response-status>status</span> is always <code title>0</code>,
<span title=concept-response-status-message>status message</span> is always the empty byte sequence,
<span title=concept-response-header-list>header list</span> is always empty,
<span title=concept-response-body>body</span> is always null, and
<span title=concept-response-trailer>trailer</span> is always empty.

<hr>

<p>A <dfn title=concept-filtered-response data-export>filtered response</dfn> is a limited view on a
<span title=concept-response>response</span> that is not a
<span title=concept-network-error>network error</span>. This
<span title=concept-response>response</span> is referred to as the
<span title=concept-filtered-response>filtered response</span>'s associated
<dfn title=concept-internal-response data-export>internal response</dfn>.

<p class="note no-backref">The <span title=concept-fetch>fetch</span> algorithm returns
such a view to ensure APIs do not accidentally leak information. If the information is
required, e.g., to feed image data to a decoder, the associated
<span title=concept-internal-response>internal response</span> can be used, which is only
"accessible" to internal specification algorithms.

<p>A <dfn title=concept-filtered-response-basic data-export>basic filtered response</dfn> is a
<span title=concept-filtered-response>filtered response</span> whose
<span title=concept-response-type>type</span> is "<code title>basic</code>" and
<span title=concept-response-header-list>header list</span> excludes any
<span title=concept-header>headers</span> in
<span title=concept-internal-response>internal response</span>'s
<span title=concept-response-header-list>header list</span> whose
<span title=concept-header-name>name</span> is a
<span>forbidden response-header name</span>.

<p>A <dfn title=concept-filtered-response-cors data-export>CORS filtered response</dfn> is a
<span title=concept-filtered-response>filtered response</span> whose
<span title=concept-response-type>type</span> is "<code title>cors</code>",
<span title=concept-response-header-list>header list</span> excludes any
<span title=concept-header>headers</span> in
<span title=concept-internal-response>internal response</span>'s
<span title=concept-response-header-list>header list</span> whose
<span title=concept-header-name>name</span> is <em>not</em> a
<span>CORS-safelisted response-header name</span>, given
<span title=concept-internal-response>internal response</span>'s
<span title=concept-response-cors-exposed-header-name-list>CORS-exposed header-name list</span>, and
<span tilte=concept-response-trailer>trailer</span> is empty.

<p>An <dfn title=concept-filtered-response-opaque data-export>opaque filtered response</dfn> is a
<span title=concept-filtered-response>filtered response</span> whose
<span title=concept-response-type>type</span> is "<code title>opaque</code>",
<span title=concept-response-url-list>url list</span> is the empty list,
<span title=concept-response-status>status</span> is <code title>0</code>,
<span title=concept-response-status-message>status message</span> is the empty byte sequence,
<span title=concept-response-header-list>header list</span> is empty,
<span title=concept-response-body>body</span> is null, and
<span title=concept-response-trailer>trailer</span> is empty.

<p>An
<dfn title=concept-filtered-response-opaque-redirect data-export>opaque-redirect filtered response</dfn>
is a <span title=concept-filtered-response>filtered response</span> whose
<span title=concept-response-type>type</span> is "<code title>opaqueredirect</code>",
<span title=concept-response-status>status</span> is <code title>0</code>,
<span title=concept-response-status-message>status message</span> is the empty byte sequence,
<span title=concept-response-header-list>header list</span> is empty,
<span title=concept-response-body>body</span> is null, and
<span title=concept-response-trailer>trailer</span> is empty.

<div class="note no-backref">
 <p>Exposing the <span title=concept-response-url-list>url list</span> for
 <span title=concept-filtered-response-opaque-redirect>opaque-redirect filtered responses</span> is
 harmless since no redirects are followed.

 <p>In other words, an <span title=concept-filtered-response-opaque>opaque filtered response</span>
 and an
 <span title=concept-filtered-response-opaque-redirect>opaque-redirect filtered response</span> are
 nearly indistinguishable from a <span title=concept-network-error>network error</span>. When
 introducing new APIs, do not use the <span title=concept-internal-response>internal response</span>
 for internal specification algorithms as that will leak information.

 <p>This also means that JavaScript APIs, such as <code title=dom-Response-ok>response.ok</code>,
 will return rather useless results.</p>
</div>

<p>To <dfn title=concept-response-clone data-export data-dfn-for=response>clone</dfn> a
<span title=concept-response>response</span> <var>response</var>, run these steps:

<ol>
 <li><p>If <var>response</var> is a <span title=concept-filtered-response>filtered response</span>,
 return a new identical filtered response whose <span title=concept-internal-response>internal
 response</span> is a <span title=concept-response-clone>clone</span> of <var>response</var>'s
 <span title=concept-internal-response>internal response</span>. Rethrow any exceptions.

 <li><p>Let <var>newResponse</var> be a copy of <var>response</var>, except for its
 <span title=concept-response-body>body</span>.

 <li><p>If <var>response</var>'s <span title=concept-response-body>body</span> is non-null, set
 <var>newResponse</var>'s <span title=concept-response-body>body</span> to the result of
 <span title=concept-body-clone>cloning</span> <var>response</var>'s
 <span title=concept-response-body>body</span>. Rethrow any exceptions.

 <li><p>Return <var>newResponse</var>.
</ol>


<h3 id=authentication-entries>Authentication entries</h3>

<p>An <dfn data-export>authentication entry</dfn> and a
<dfn data-export>proxy-authentication entry</dfn> are tuples of username, password, and realm,
associated with one or more <span title=concept-request>requests</span>.

<p>User agents should allow both to be cleared together with HTTP cookies and similar tracking
functionality.
<!-- fingerprinting -->

<p>Further details are defined by HTTP. <span data-anolis-ref>HTTP</span>


<h3 id=fetch-groups>Fetch groups</h3>

<p>Each <span data-anolis-spec=html>environment settings object</span> has an associated
<dfn title=concept-fetch-group data-export>fetch group</dfn>.

<p>A <span title=concept-fetch-group>fetch group</span> holds an ordered list of
<dfn title=concept-fetch-record data-export data-dfn-for="fetch group">fetch records</dfn>.

<p>A <span title=concept-fetch-record>fetch record</span> has an associated
<dfn title=concept-fetch-record-request data-export data-dfn-for="fetch group">request</dfn> (a
<span title=concept-request>request</span>).

<p>A <span title=concept-fetch-record>fetch record</span> has an associated
<dfn title=concept-fetch-record-fetch data-export data-dfn-for="fetch group">fetch</dfn> (a
<span title=concept-fetch>fetch</span> algorithm or null).

<hr>

<p>When a <span title=concept-fetch-group>fetch group</span> is
<dfn title=concept-fetch-group-terminate data-export data-dfn-for="fetch group">terminated</dfn>,
for each associated <span title=concept-fetch-record>fetch record</span> whose
<span title=concept-fetch-record-request>request</span>'s <span>done flag</span> or
<span>keepalive flag</span> is unset, <span title=concept-fetch-terminate>terminate</span> the
<span title=concept-fetch-record>fetch record</span>'s
<span title=concept-fetch-record-fetch>fetch</span> with reason <i title>fatal</i>.


<h3 id=connections>Connections</h3>

<p>A user agent has an associated
<dfn title=concept-connection-pool data-export>connection pool</dfn>. A
<span title=concept-connection-pool>connection pool</span> consists of zero or more
<dfn title=concept-connection data-export>connections</dfn>. Each
<span title=concept-connection>connection</span> is identified by an <b>origin</b> (an
<span data-anolis-spec=html>origin</span>) and <b>credentials</b> (a boolean).

<p>To <dfn title=concept-connection-obtain data-export>obtain a connection</dfn>, given an
<var>origin</var> and <var>credentials</var>, run these steps:

<ol>
 <li><p>If <span title=concept-connection-pool>connection pool</span> contains a
 <span title=concept-connection>connection</span> whose <b>origin</b> is <var>origin</var> and
 <b>credentials</b> is <var>credentials</var>, return that
 <span title=concept-connection>connection</span>.

 <li>
  <p>Let <var>connection</var> be the result of establishing an HTTP connection to
  <var>origin</var>. <span data-anolis-ref>HTTP</span> <span data-anolis-ref>TLS</span>

  <p>If <var>credentials</var> is false, do <em>not</em> send a TLS client certificate.

  <p>If establishing a connection does not succeed (e.g., a DNS, TCP, or TLS error), return failure.

 <li><p>Add <var>connection</var> to the <span title=concept-connection-pool>connection pool</span>
 with <b>origin</b> being <var>origin</var> and <b>credentials</b> being <var>credentials</var>.

 <li><p>Return <var>connection</var>.
</ol>

<p class="note no-backref">This is intentionally a little vague as the finer points are still
evolving. Describing this helps explain the <code>&lt;link rel=preconnect></code> feature and
clearly stipulates that <span title=concept-connection>connections</span> are keyed on
<b>credentials</b>. The latter clarifies that e.g., TLS session identifiers are not reused across
<span title=concept-connection>connections</span> whose <b>credentials</b> are false with
<span title=concept-connection>connections</span> whose <b>credentials</b> are true.
<!-- See https://github.com/whatwg/fetch/issues/114#issuecomment-143500095 for when we make
     WebSocket saner -->


<h3 id=port-blocking>Port blocking</h3>

<p>To determine whether fetching a <span title=concept-request>request</span> <var>request</var>
<dfn title="block bad port" data-export data-lt="block bad port">should be blocked due to a bad port</dfn>,
run these steps:

<ol>
 <li><p>Let <var>url</var> be <var>request</var>'s
 <span title=concept-request-current-url>current url</span>.

 <li><p>Let <var>scheme</var> be <var>url</var>'s
 <span data-anolis-spec=url title=concept-url-scheme>scheme</span>.

 <li><p>Let <var>port</var> be <var>url</var>'s
 <span data-anolis-spec=url title=concept-url-port>port</span>.

 <li><p>If <var>scheme</var> is "<code title>ftp</code>" and <var>port</var> is 20 or 21, then
 return <b>allowed</b>.

 <li><p>Otherwise, if <var>scheme</var> is a <span data-anolis-spec=url>network scheme</span> and
 <var>port</var> is a <span>bad port</span>, then return <b>blocked</b>.

 <li><p>Return <b>allowed</b>.
</ol>

<p>A <span data-anolis-spec=url title=concept-url-port>port</span> is a
<dfn data-export>bad port</dfn> if it is listed in the first column of the following table.

<table>
 <tr><th>Port<th>Typical service
 <tr><td>1<td>tcpmux
 <tr><td>7<td>echo
 <tr><td>9<td>discard
 <tr><td>11<td>systat
 <tr><td>13<td>daytime
 <tr><td>15<td>netstat
 <tr><td>17<td>qotd
 <tr><td>19<td>chargen
 <tr><td>20<td>ftp-data
 <tr><td>21<td>ftp
 <tr><td>22<td>ssh
 <tr><td>23<td>telnet
 <tr><td>25<td>smtp
 <tr><td>37<td>time
 <tr><td>42<td>name
 <tr><td>43<td>nicname
 <tr><td>53<td>domain
 <tr><td>77<td>priv-rjs
 <tr><td>79<td>finger
 <tr><td>87<td>ttylink
 <tr><td>95<td>supdup
 <tr><td>101<td>hostriame
 <tr><td>102<td>iso-tsap
 <tr><td>103<td>gppitnp
 <tr><td>104<td>acr-nema
 <tr><td>109<td>pop2
 <tr><td>110<td>pop3
 <tr><td>111<td>sunrpc
 <tr><td>113<td>auth
 <tr><td>115<td>sftp
 <tr><td>117<td>uucp-path
 <tr><td>119<td>nntp
 <tr><td>123<td>ntp
 <tr><td>135<td>loc-srv / epmap
 <tr><td>139<td>netbios
 <tr><td>143<td>imap2
 <tr><td>179<td>bgp
 <tr><td>389<td>ldap
 <tr><td>465<td>smtp+ssl
 <tr><td>512<td>print / exec
 <tr><td>513<td>login
 <tr><td>514<td>shell
 <tr><td>515<td>printer
 <tr><td>526<td>tempo
 <tr><td>530<td>courier
 <tr><td>531<td>chat
 <tr><td>532<td>netnews
 <tr><td>540<td>uucp
 <tr><td>556<td>remotefs
 <tr><td>563<td>nntp+ssl
 <tr><td>587<td>smtp
 <tr><td>601<td>syslog-conn
 <tr><td>636<td>ldap+ssl
 <tr><td>993<td>ldap+ssl
 <tr><td>995<td>pop3+ssl
 <tr><td>2049<td>nfs
 <tr><td>3659<td>apple-sasl<!-- not in Gecko, Apple addition adopted by Chrome -->
 <tr><td>4045<td>lockd
 <tr><td>6000<td>x11
 <tr><td>6665<td>irc (alternate)<!-- not in Gecko, Apple addition adopted by Chrome -->
 <tr><td>6666<td>irc (alternate)<!-- not in Gecko, Apple addition adopted by Chrome -->
 <tr><td>6667<td>irc (default)<!-- not in Gecko, Apple addition adopted by Chrome -->
 <tr><td>6668<td>irc (alternate)<!-- not in Gecko, Apple addition adopted by Chrome -->
 <tr><td>6669<td>irc (alternate)<!-- not in Gecko, Apple addition adopted by Chrome -->
</table>
<!-- http://www-archive.mozilla.org/projects/netlib/PortBanning.html -->


<h3 id="should-response-to-request-be-blocked-due-to-mime-type?"><dfn title="should response to request be blocked due to mime type" data-export>Should
<var>response</var> to <var>request</var> be blocked due to its MIME type?</dfn></h3>

<p>Run these steps:

<ol>
 <li><p>Let <var>MIMEType</var> be the result of
 <span title=concept-header-extract-mime-type>extracting a MIME type</span> from
 <var>response</var>'s <span title=concept-response-header-list>header list</span>.

 <li><p>Let <var>type</var> be <var>request</var>'s <span title=concept-request-type>type</span>.

 <li>
  <p>If <var>type</var> is "<code title>script</code>" and one of the following is true, then return
  <b>blocked</b>:

  <ul class="brief">
   <li><var>MIMEType</var> starts with `<code title>audio/</code>`, `<code title>image/</code>`, or
   `<code title>video/</code>`.
   <li><var>MIMEType</var> is `<code title>text/csv</code>`.
  </ul>

 <li><p>Return <b title>allowed</b>.
</ol>


<h3 id=client-hints-list>Client hints list</h3>

<p class="note">This section will be integrated into HTTP Client Hints.
<span data-anolis-ref>CLIENT-HINTS</span>
<!-- XXX -->

<p>A <dfn title=concept-client-hints-list data-export>client hints list</dfn> is a list of
<a href=http://httpwg.org/http-extensions/client-hints.html#accept-ch>Client hint tokens</a>,
each of which is one of `<code title>dpr</code>`,
`<code title>save-data</code>`, `<code title>viewport-width</code>`, or
`<code title>width</code>`.


<h3 id=streams>Streams</h3>

<p class="note no-backref">This section might be integrated into other standards, such as IDL.

<h4 id=readablestream>ReadableStream</h4>

<p>A <dfn title=concept-ReadableStream data-export data-dfn-type=interface>ReadableStream</dfn>
object represents a <span data-anolis-spec=streams title=readablestream>stream of data</span>. In
this section, we define common operations for
<code title=concept-ReadableStream>ReadableStream</code> objects.
<span data-anolis-ref>STREAMS</span>

<p>To
<dfn title=concept-enqueue-ReadableStream data-export data-dfn-for=ReadableStream>enqueue</dfn>
<var>chunk</var> into a <code title=concept-ReadableStream>ReadableStream</code> object
<var>stream</var>, run these steps:

<ol>
 <li><p>Call
 <span data-anolis-spec=streams>ReadableStreamDefaultControllerEnqueue</span>(<var>stream</var>.[[readableStreamController]],
 <var>chunk</var>). Rethrow any exceptions.
</ol>

<p>To <dfn title=concept-close-ReadableStream data-export data-dfn-for=ReadableStream>close</dfn> a
<code title=concept-ReadableStream>ReadableStream</code> object <var>stream</var>, run these steps:

<ol>
 <li><p>Call
 <span data-anolis-spec=streams>ReadableStreamDefaultControllerClose</span>(<var>stream</var>.[[readableStreamController]]).
 Rethrow any exceptions.
</ol>

<p>To <dfn title=concept-error-ReadableStream data-export data-dfn-for=ReadableStream>error</dfn> a
<code title=concept-ReadableStream>ReadableStream</code> object <var>stream</var> with given
<var>reason</var>, run these steps:

<ol>
 <li><p>Call
 <span data-anolis-spec=streams>ReadableStreamDefaultControllerError</span>(<var>stream</var>.[[readableStreamController]]).
 <var>reason</var>). Rethrow any exceptions.
</ol>

<p>To
<dfn title=concept-construct-ReadableStream data-export data-dfn-for=ReadableStream>construct a <code>ReadableStream</code> object</dfn>
with given <var>strategy</var>, <var>pull</var> action and <var>cancel</var> action, all of which
are optional, run these steps:

<ol>
 <li><p>Let <var>init</var> be a new object.

 <li><p>Set <var>init</var>["pull"] to a function that runs <var>pull</var> if
 <var>pull</var> is given.

 <li><p>Set <var>init</var>["cancel"] to a function that runs <var>cancel</var> if
 <var>cancel</var> is given.

 <li><p>Let <var>stream</var> be the result of calling the initial value of
 <code title=concept-ReadableStream>ReadableStream</code> as constructor with
 <var>init</var> and <var>strategy</var> if given. Rethrow any exceptions.

 <li><p>Return <var>stream</var>.
</ol>

<p>To
<dfn title=concept-construct-fixed-ReadableStream data-export data-dfn-for=ReadableStream>construct a fixed <code>ReadableStream</code> object</dfn>
with given <var>chunks</var>, run these steps:

<ol>
 <li><p>Let <var>stream</var> be the result of
 <span title=concept-construct-ReadableStream>constructing</span> a
 <code title=concept-ReadableStream>ReadableStream</code> object. Rethrow any exceptions.

 <li><p>For each <var>chunk</var> in <var>chunks</var>,
 <span title=concept-enqueue-ReadableStream>enqueue</span> <var>chunk</var> into
 <var>stream</var>. Rethrow any exceptions.

 <li><p><span title=concept-close-ReadableStream>Close</span> <var>stream</var>. Rethrow any
 exceptions.

 <li>Return <var>stream</var>.
</ol>

<p>To <dfn title=concept-get-reader data-export data-dfn-for=ReadableStream>get a reader</dfn> from
a <code title=concept-ReadableStream>ReadableStream</code> object <var>stream</var>, run these
steps:

<ol>
 <li><p>Let <var>reader</var> be the result of calling
 <span data-anolis-spec=streams>AcquireReadableStreamDefaultReader</span>(<var>stream</var>).
 Rethrow any exceptions.

 <li><p>Return <var>reader</var>.
</ol>

<p>To
<dfn title=concept-read-chunk-from-ReadableStream data-export data-dfn-for=ReadableStream>read a chunk</dfn>
from a <code title=concept-ReadableStream>ReadableStream</code> object with <var>reader</var>,
return the result of calling
<span data-anolis-spec=streams>ReadableStreamDefaultReaderRead</span>(<var>reader</var>).

<p>To
<dfn title=concept-read-all-bytes-from-ReadableStream data-export data-dfn-for=ReadableStream>read all bytes</dfn>
from a <code title=concept-ReadableStream>ReadableStream</code> object with <var>reader</var>, run
these steps:

<ol>
 <li><p>Let <var>promise</var> be a new promise.

 <li><p>Let <var>bytes</var> be an empty byte sequence.

 <li>
 <p>Let <var>read</var> be the result of calling
 <span data-anolis-spec=streams>ReadableStreamDefaultReaderRead</span>(<var>reader</var>).

 <ul>
  <li><p>When <var>read</var> is fulfilled with an object whose <code title>done</code>
  property is false and whose <code title>value</code> property is a
  <code title>Uint8Array</code> object, append the <code title>value</code> property to
  <var>bytes</var> and run the above step again.

  <li><p>When <var>read</var> is fulfilled with an object whose <code title>done</code>
  property is true, resolve <var>promise</var> with <var>bytes</var>.

  <li><p>When <var>read</var> is fulfilled with a value that matches with neither of the
  above patterns, reject <var>promise</var> with a <code title>TypeError</code>.

  <li><p>When <var>read</var> is rejected with an error, reject <var>promise</var>
  with that error.
 </ul>

 <li><p>Return <var>promise</var>.
</ol>

<p>To <dfn title=concept-cancel-ReadableStream data-export data-dfn-for=ReadableStream>cancel</dfn>
a <code title=concept-ReadableStream>ReadableStream</code> object with <var>reader</var> and
<var>reason</var>, return the result of calling
<span data-anolis-spec=streams>ReadableStreamCancel</span>(<var>reader</var>, <var>reason</var>).

<p class="note no-backref">Because the reader grants exclusive access, the actual mechanism of how
to read cannot be observed. Implementations could use more direct mechanism if convenient.

<p>To <dfn title=concept-tee-ReadableStream data-export data-dfn-for=ReadableStream>tee</dfn> a
<code title=concept-ReadableStream>ReadableStream</code> object <var>stream</var>, run these steps:

<ol>
 <li><p>Return the result of calling
 <span data-anolis-spec=streams>ReadableStreamTee</span>(<var>stream</var>, true).
 Rethrow any exception.
</ol>

<p>An <dfn title=concept-empty-ReadableStream data-export data-dfn-for=ReadableStream>empty</dfn>
<code title=concept-ReadableStream>ReadableStream</code> object is the result of
<span title=concept-construct-fixed-ReadableStream>constructing</span> a fixed
<code title=concept-ReadableStream>ReadableStream</code> object with an empty list.

<p class="note no-backref">Constructing an <span title=concept-empty-ReadableStream>empty</span>
<code title=concept-ReadableStream>ReadableStream</code> object will not throw an exception.

<p>A <code title=concept-ReadableStream>ReadableStream</code> object <var>stream</var> is said to be
<dfn title=concept-ReadableStream-readable data-export data-dfn-for=ReadableStream>readable</dfn> if
<var>stream</var>.[[state]] is "readable".

<p>A <code title=concept-ReadableStream>ReadableStream</code> object <var>stream</var> is said to be
<dfn title=concept-ReadableStream-closed data-export data-dfn-for=ReadableStream>closed</dfn> if
<var>stream</var>.[[state]] is "closed".

<p>A <code title=concept-ReadableStream>ReadableStream</code> object <var>stream</var> is said to be
<dfn title=concept-ReadableStream-errored data-export data-dfn-for=ReadableStream>errored</dfn> if
<var>stream</var>.[[state]] is "errored".

<p>A <code title=concept-ReadableStream>ReadableStream</code> object <var>stream</var> is said to be
<dfn title=concept-ReadableStream-locked data-export data-dfn-for=ReadableStream>locked</dfn> if the
result of calling <span data-anolis-spec=streams>IsReadableStreamLocked</span>(<var>stream</var>) is
true.

<p>A <code title=concept-ReadableStream>ReadableStream</code> object <var>stream</var> is said to
<dfn title=concept-ReadableStream-need-more-data data-export data-dfn-for=ReadableStream>need more data</dfn>
if the following conditions hold:

<ul>
 <li><p><var>stream</var> is <span title=concept-ReadableStream-readable>readable</span>.

 <li><p>The result of calling
 <span data-anolis-spec=streams>ReadableStreamDefaultControllerGetDesiredSize</span>(<var>stream</var>.[[readableStreamController]]).
 is positive.
</ul>

<p>A <code title=concept-ReadableStream>ReadableStream</code> object <var>stream</var> is said to be
<dfn title=concept-ReadableStream-disturbed data-export data-dfn-for=ReadableStream>disturbed</dfn>
if the result of calling
<span data-anolis-spec=streams>IsReadableStreamDisturbed</span>(<var>stream</var>) is true.



<h2 id=http-extensions>HTTP extensions</h2>

<h3 id=origin-header>`<code title>Origin</code>` header</h3>

<p>The `<dfn title=http-origin data-export data-dfn-type=http-header><code>Origin</code></dfn>`
request <span title=concept-header>header</span> indicates where a
<span title=concept-fetch>fetch</span> originates from.

<p class="note no-backref">The `<code title=http-origin>Origin</code>` header is a version
of the `<code title=http-referer>Referer</code>` [sic] header that does not reveal a
<span data-anolis-spec=url title=concept-url-path>path</span>. It is used for
all <span title=concept-http-fetch>HTTP fetches</span> whose <i title>CORS flag</i> is
set as well as those where <span title=concept-request>request</span>'s
<span title=concept-request-method>method</span> is `<code title>POST</code>`. Due to
compatibility constraints it is not included in all
<span title=concept-fetch>fetches</span>.
<!-- Ian Hickson told me Adam Barth researched that -->

<p>Its <span title=concept-header-value>value</span> ABNF:

<pre>Origin                           = origin-or-null

origin-or-null                   = origin / %x6E.75.6C.6C ; "null", case-sensitive
origin                           = <span data-anolis-spec=url title=concept-url-scheme>scheme</span> "://" <span data-anolis-spec=url title=concept-url-host>host</span> [ ":" <span data-anolis-spec=url title=concept-url-port>port</span> ]</pre>

<p class="note no-backref">This supplants the `<code title=http-origin>Origin</code>`
<span title=concept-header>header</span>.
<span data-anolis-ref class=informative>ORIGIN</span>


<h3 id=http-cors-protocol>CORS protocol</h3>

<p>To allow sharing responses cross-origin and allow for more versatile
<span title=concept-fetch>fetches</span> than possible with HTML's
<code data-anolis-spec=html>form</code> element, the <dfn data-export>CORS protocol</dfn> exists. It
is layered on top of HTTP and allows responses to declare they can be shared with other
<span data-anolis-spec=html>origin</span>.

<p class=note>It needs to be an opt-in mechanism to prevent leaking data from responses behind a
firewall (intranets). Additionally, for <span title=concept-request>requests</span> including
<span>credentials</span> it needs to be opt-in to prevent leaking potentially-sensitive data.

<p>This section explains the <span>CORS protocol</span> as it pertains to server developers.
Requirements for user agents are part of the <span title=concept-fetch>fetch</span> algorithm,
except for the <a href=#http-new-header-syntax>new HTTP header syntax</a>.


<h4 id=general>General</h4>

<p>The <span>CORS protocol</span> consists of a set of headers that indicates whether a response can
be shared cross-origin.

<p>For <span title=concept-request>requests</span> that are more involved than what is possible with
HTML's <code data-anolis-spec=html>form</code> element, a <span>CORS-preflight request</span> is
performed, to ensure <span title=concept-request>request</span>'s
<span title=concept-request-current-url>current url</span> supports the <span>CORS protocol</span>.


<h4 id=http-requests>HTTP requests</h4>

<p>A <dfn data-export>CORS request</dfn> is an HTTP request that includes an
`<code title=http-origin>Origin</code>` header. It cannot be reliably identified as particpating in
the <span>CORS protocol</span> as the `<code title=http-origin>Origin</code>` header is sometimes
included for other purposes too.

<p>A <dfn data-export>CORS-preflight request</dfn> is a <span>CORS request</span> that checks to see
if the <span>CORS protocol</span> is understood. It uses `<code title>OPTIONS</code>` as
<span title=concept-method>method</span> and includes these
<span title=concept-header>headers</span>:

<dl>
 <dt>`<dfn title=http-access-control-request-method data-export data-dfn-type=http-header><code>Access-Control-Request-Method</code></dfn>`
 <dd><p>Indicates which <span title=concept-method>method</span> a future
 <span>CORS request</span> to the same resource might use.

 <dt>`<dfn title=http-access-control-request-headers data-export data-dfn-type=http-header><code>Access-Control-Request-Headers</code></dfn>`
 <dd><p>Indicates which <span title=concept-header>headers</span> a future
 <span>CORS request</span> to the same resource might use.
</dl>


<h4 id=http-responses>HTTP responses</h4>

<p>An HTTP response to a <span>CORS request</span> can include the following
<span title=concept-header>headers</span>:

<dl>
 <dt>`<dfn title=http-access-control-allow-origin data-export data-dfn-type=http-header><code>Access-Control-Allow-Origin</code></dfn>`
 <dd><p>Indicates whether the response can be shared, via returning the literal
 <span title=concept-header-value>value</span> of the
 `<code title=http-origin>Origin</code>` request <span title=concept-header>header</span>
 (which can be `<code title>null</code>`) or `<code title>*</code>` in a response.

 <dt>`<dfn title=http-access-control-allow-credentials data-export data-dfn-type=http-header><code>Access-Control-Allow-Credentials</code></dfn>`
 <dd>
  <p>Indicates whether the response can be shared when <span title=concept-request>request</span>'s
  <span title=concept-request-credentials-mode>credentials mode</span> is
  "<code title>include</code>".

  <p class=note>For a <span>CORS-preflight request</span>,
  <span title=concept-request>request</span>'s
  <span title=concept-request-credentials-mode>credentials mode</span> is always
  "<code title>omit</code>", but for any subsequent
  <span title="CORS request">CORS requests</span> it might not be. Support therefore needs
  to be indicated as part of the HTTP response to the <span>CORS-preflight request</span>
  as well.
</dl>

<p>An HTTP response to a <span>CORS-preflight request</span> can include the following
<span title=concept-header>headers</span>:

<dl>
 <dt>`<dfn title=http-access-control-allow-methods data-export data-dfn-type=http-header><code>Access-Control-Allow-Methods</code></dfn>`
 <dd>
  <p>Indicates which <span title=concept-method>methods</span> are supported by the
  <span title=concept-response>response</span>'s <span title=concept-response-url>url</span> for the
  purposes of the <span>CORS protocol</span>.

  <p class=note>The `<code title>Allow</code>` <span title=concept-header>header</span> is
  not relevant for the purposes of the <span>CORS protocol</span>.

 <dt>`<dfn title=http-access-control-allow-headers data-export data-dfn-type=http-header><code>Access-Control-Allow-Headers</code></dfn>`
 <dd><p>Indicates which <span title=concept-header>headers</span> are supported by the
 <span title=concept-response>response</span>'s <span title=concept-response-url>url</span> for the
 purposes of the <span>CORS protocol</span>.

 <dt>`<dfn title=http-access-control-max-age data-export data-dfn-type=http-header><code>Access-Control-Max-Age</code></dfn>`
 <dd><p>Indicates how long the information provided by the
 `<code title=http-access-control-allow-methods>Access-Control-Allow-Methods</code>` and
 `<code title=http-access-control-allow-headers>Access-Control-Allow-Headers</code>`
 <span title=concept-header>headers</span> can be cached.
</dl>

<p>An HTTP response to a <span>CORS request</span> that is not a
<span>CORS-preflight request</span> can also include the following
<span title=concept-header>header</span>:

<dl>
 <dt>`<dfn title=http-access-control-expose-headers data-export data-dfn-type=http-header><code>Access-Control-Expose-Headers</code></dfn>`
 <dd><p>Indicates which <span title=concept-header>headers</span> can be exposed as part
 of the response by listing their <span title=concept-header-name>names</span>.
</dl>


<h4 id=http-new-header-syntax>HTTP new-header syntax</h4>

<p>ABNF for the <span title=concept-header-value>values</span> of the
<span title=concept-header>headers</span> used by the <span>CORS protocol</span>:

<pre>Access-Control-Request-Method    = <span data-anolis-spec=http>method</span>
Access-Control-Request-Headers   = #<span data-anolis-spec=http>field-name</span>

wildcard                         = "*"
Access-Control-Allow-Origin      = origin-or-null / wildcard
Access-Control-Allow-Credentials = %x74.72.75.65 ; "true", case-sensitive
Access-Control-Expose-Headers    = #<span data-anolis-spec=http>field-name</span> / wildcard
Access-Control-Max-Age           = <span data-anolis-spec=http-caching>delta-seconds</span>
Access-Control-Allow-Methods     = #<span data-anolis-spec=http>method</span> / wildcard
Access-Control-Allow-Headers     = #field-name-or-wildcard
field-name-or-wildcard           = <span data-anolis-spec=http>field-name</span> / wildcard</pre>

<p class="note">The difference between the <code title>Access-Control-Expose-Headers</code> and
<code title>Access-Control-Allow-Headers</code> production is that the latter needs to be able to
handle `<code title>*, Authorization</code>` as header value whereas the former does not.


<h4 id=cors-protocol-and-credentials>CORS protocol and credentials</h4>

<!-- non-normative -->

<p>When <span title=concept-request>request</span>'s
<span title=concept-request-credentials-mode>credentials mode</span> is "<code>include</code>" it
has an impact on the functioning of the <span>CORS protocol</span> other than including
<span>credentials</span> in the <span title=concept-fetch>fetch</span>.

<div id=example-xhr-credentials class=example>
 <p>In the old days, <code data-anolis-spec=xhr>XMLHttpRequest</code> could be used to set
 <span title=concept-request>request</span>'s
 <span title=concept-request-credentials-mode>credentials mode</span> to "<code>include</code>":

 <pre>var client = new XMLHttpRequest()
client.open("GET", "./")
client.withCredentials = true
/* &hellip; */</pre>

 <p>Nowadays, <code title>fetch("./", { credentials:"include" }).then(/* &hellip; */)</code>
 suffices.
</div>

<p>A <span title=concept-request>request</span>'s
<span title=concept-request-credentials-mode>credentials mode</span> is not necessarily observable
on the server; only when <span>credentials</span> exist for a
<span title=concept-request>request</span> can it be observed by virtue of the
<span>credentials</span> being included. Note that even so, a <span>CORS-preflight request</span>
never includes <span>credentials</span>.

<p>The server developer therefore needs to decide whether or not responses "tainted" with
<span>credentials</span> can be shared. And also needs to decide if
<span title=concept-request>requests</span> necessitating a <span>CORS-preflight request</span> can
include <span>credentials</span>. Generally speaking, both sharing responses and allowing requests
with <span>credentials</span> is rather unsafe, and extreme care has to be taken to avoid the
<a href="https://en.wikipedia.org/wiki/Confused_deputy_problem">confused deputy problem</a>.
<!-- Turn into a reference? Meh. -->

<p>To share responses with <span>credentials</span>, the
`<code title=http-access-control-allow-origin>Access-Control-Allow-Origin</code>` and
`<code title=http-access-control-allow-credentials>Access-Control-Allow-Credentials</code>`
<span title=concept-header>headers</span> are important. The following table serves to illustrate
the various legal and illegal combinations for a request to <code>https://rabbit.invalid/</code>:

<table>
 <tr>
  <th>Request's credentials mode
  <th>`<code title>Access-Control-Allow-Origin</code>`
  <th>`<code title>Access-Control-Allow-Credentials</code>`
  <th>Shared?
  <th>Notes
 <tr>
  <td>"<code>omit</code>"
  <td>`<code>*</code>`
  <td>Omitted
  <td>✅
  <td>&mdash;
 <tr>
  <td>"<code>omit</code>"
  <td>`<code>*</code>`
  <td>`<code>true</code>`
  <td>✅
  <td>If credentials mode is not "<code>include</code>", then
  `<code title=http-access-control-allow-credentials>Access-Control-Allow-Credentials</code>` is
  ignored.
 <tr>
  <td>"<code>omit</code>"
  <td>`<code>https://rabbit.invalid/`</td>
  <td>Omitted
  <td>❌
  <td>A serialized origin has no trailing slash.
 <tr>
  <td>"<code>omit</code>"
  <td>`<code>https://rabbit.invalid`</td>
  <td>Omitted
  <td>✅
  <td>&mdash;
 <tr>
  <td>"<code>include</code>"
  <td>`<code>*</code>`
  <td>`<code>true</code>`
  <td>❌
  <td>If credentials mode is "<code>include</code>", then
  `<code title=http-access-control-allow-origin>Access-Control-Allow-Origin</code>` cannot be
  `<code>*</code>`.
 <tr>
  <td>"<code>include</code>"
  <td>`<code>https://rabbit.invalid`</td>
  <td>`<code>true</code>`
  <td>✅
  <td>&mdash;
 <tr>
  <td>"<code>include</code>"
  <td>`<code>https://rabbit.invalid`</td>
  <td>`<code>True</code>`
  <td>❌
  <td>`<code>true</code>` is (byte) case-sensitive.
</table>

<p>Similarly, `<code title=http-access-control-expose-headers>Access-Control-Expose-Headers</code>`,
`<code title=http-access-control-allow-methods>Access-Control-Allow-Methods</code>`, and
`<code title=http-access-control-allow-headers>Access-Control-Allow-Headers</code>` response
headers can only use `<code>*</code>` as value when <span title=concept-request>request</span>'s
<span title=concept-request-credentials-mode>credentials mode</span> is not "<code>include</code>".


<h4 id=cors-protocol-examples>Examples</h4>

<div id=example-simple-cors class=example>
 <p>A script at <code>https://foo.invalid/</code> wants to fetch some data from
 <code>https://bar.invalid/</code>. (Neither <span>credentials</span> nor response header access is
 important.)

 <pre id=unicorn>var url = "https://bar.invalid/api?key=730d67a37d7f3d802e96396d00280768773813fbe726d116944d814422fc1a45&amp;data=about:unicorn";
fetch(url).then(success, failure)</pre>

 <p>This will use the <span>CORS protocol</span>, though this is entirely transparent to the
 developer from <code>foo.invalid</code>. As part of the <span>CORS protocol</span>, the user agent
 will include the `<code title=http-origin>Origin</code>` header in the request:

 <pre>Origin: https://foo.invalid</pre>

 <p>Upon receiving a response from <code>bar.com</code>, the user agent will verify the
 `<code title=http-access-control-allow-origin>Access-Control-Allow-Origin</code>` response header.
 If its value is either `<code>https://foo.invalid</code>` or `<code>*</code>`, the user agent will
 invoke the <code>success</code> callback. If it has any other value, or is simply missing, the user
 agent will invoke the <code>failure</code> callback.
</div>

<div id=example-cors-with-response-header class=example>
 <p>The developer of <code>foo.invalid</code> is back, and now wants to fetch some data from
 <code>bar.invalid</code> while also accessing a response header.

 <pre>fetch(url).then(response => {
  var hsts = response.headers.get("strict-transport-security"),
      csp = response.headers.get("content-security-policy")
  log(hsts, csp)
})</pre>

 <p><code>bar.invalid</code> provides a correct
 `<code title=http-access-control-allow-origin>Access-Control-Allow-Origin</code>` response header
 per the earlier example. The values of <code>hsts</code> and <code>csp</code> will depend on the
 `<code title=http-access-control-expose-headers>Access-Control-Expose-Headers</code>` response
 header. For example, if the response included the following headers

 <pre>Content-Security-Policy: default-src 'self'
Strict-Transport-Security: max-age=31536000; includeSubdomains; preload
Access-Control-Expose-Headers: Content-Security-Policy</pre>

 <p>then <code>hsts</code> would be null and <code>csp</code> would be
 "<code>default-src 'self'</code>", even though the response did include both headers. This is
 because <code>bar.invalid</code> needs to explicitly share each header by listing their names in
 the `<code title=http-access-control-expose-headers>Access-Control-Expose-Headers</code>` response
 header.

 <p>Alternatively, if <code>bar.invalid</code> wanted to share all its response headers, for
 requests that do not include <span>credentials</span>, it could use `<code>*</code>` as value for
 the `<code title=http-access-control-expose-headers>Access-Control-Expose-Headers</code>` response
 header. If the request would have included <span>credentials</span>, the response header names
 would have to be listed explicitly and `<code>*</code>` could not be used.
</div>

<div id=example-cors-with-credentials class=example>
 <p>The developer of <code>foo.invalid</code> returns, now fetching some data from
 <code>bar.invalid</code> while including <span>credentials</span>. This time around the
 <span>CORS protocol</span> is no longer transparent to the developer as <span>credentials</span>
 require an explicit opt-in:

 <pre>fetch(url, { credentials:"include" }).then(success, failure)</pre>

 <p>This also makes any `<code title>Set-Cookie</code>` response headers <code>bar.invalid</code>
 includes fully functional (they are ignored otherwise).

 <p>The user agent will make sure to include any relevant <span>credentials</span> in the request.
 It will also put stricter requirements on the response. Not only will <code>bar.invalid</code> be
 required to list `<code>https://foo.invalid</code>` as value for
 `<code title=http-access-control-allow-origin>Access-Control-Allow-Origin</code>` (`<code>*</code>`
 is not allowed when <span>credentials</span> are involved), the
 `<code title=http-access-control-allow-credentials>Access-Control-Allow-Credentials</code>` has to
 be present too:

 <pre>Access-Control-Allow-Origin: https://foo.invalid
Access-Control-Allow-Credentials: true</pre>

 <p>If the response does not include those two headers with those values, the <code>failure</code>
 callback will be invoked and any `<code title>Set-Cookie</code>` response headers will end up being
 ignored.
</div>


<h3 id=x-content-type-options-header>`<code title>X-Content-Type-Options</code>` header</h3>

<p>The
`<dfn title="http-x-content-type-options" data-export data-dfn-type=http-header><code>X-Content-Type-Options</code></dfn>`
response <span title=concept-header>header</span> can be used to require checking of a
<span title=concept-response>response</span>'s `<code title>Content-Type</code>`
<span title=concept-header>header</span> against the
<span title=concept-request-type>type</span> of a
<span title=concept-request>request</span>.

<p>Its <span title=concept-header-value>value</span> ABNF:

<pre>X-Content-Type-Options           = "nosniff" ; case-insensitive</pre>

<h4 id="should-response-to-request-be-blocked-due-to-nosniff?"><dfn title="should response to request be blocked due to nosniff">Should
<var>response</var> to <var>request</var> be blocked due to nosniff?</dfn></h4>

<p>Run these steps:

<ol>
 <li><p>If <var>response</var>'s
 <span title=concept-response-header-list>header list</span> has no
 <span title=concept-header>header</span> whose
 <span title=concept-header-name>name</span> is
 `<code title=http-x-content-type-options>X-Content-Type-Options</code>`, return
 <b title>allowed</b>.

 <li><p>Let <var>nosniff</var> be the result of
 <span title=concept-header-parse>parsing</span> the <em>first</em>
 <span title=concept-header>header</span> whose
 <span title=concept-header-name>name</span> is
 `<code title=http-x-content-type-options>X-Content-Type-Options</code>` in
 <var>response</var>'s <span title=concept-response-header-list>header list</span>.

 <li><p>If <var>nosniff</var> is failure, return <b title>allowed</b>.

 <li><p>Let <var>MIMEType</var> be the result of
 <span title=concept-header-extract-mime-type>extracting a MIME type</span> from
 <var>response</var>'s <span title=concept-response-header-list>header list</span>.

 <li><p>Let <var>type</var> be <var>request</var>'s
 <span title=concept-request-type>type</span>.

 <li><p class=XXX>"<code title>audio</code>", "<code title>video</code>" ...

 <li><p>If <var>type</var> is "<code title>image</code>", and <var>MIMEType</var> does <em>not</em>
 start with `<code title>image/</code>`, return <b>blocked</b>.

 <li><p>If <var>type</var> is "<code title>font</code>" and
 <var>MIMEType</var> (ignoring parameters) is <em>not</em> a
 <a class=XXX href=https://lists.w3.org/Archives/Public/www-style/2015Apr/0027.html>font MIME type</a>,
 return <b title>blocked</b>.

 <li><p>If <var>type</var> is "<code title>script</code>", and <var>MIMEType</var>
 (ignoring parameters) is <em>not</em> a <span data-anolis-spec=html>JavaScript MIME type</span>,
 return <b title>blocked</b>.

 <li><p>If <var>type</var> is "<code title>style</code>" and
 <var>MIMEType</var> (ignoring parameters) is <em>not</em>
 `<code title>text/css</code>`, return <b title>blocked</b>.

 <li><p>If <var>type</var> is "<code title>track</code>" and
 <var>MIMEType</var> (ignoring parameters) is <em>not</em>
 `<code title>text/vtt</code>`, return <b title>blocked</b>.

 <li><p>Return <b title>allowed</b>.
</ol>


<h2 id=fetching>Fetching</h2>

<div class="note no-backref">
 <p>The algorithm below defines <span title=concept-fetch>fetching</span>. In broad
 strokes, it takes a <span title=concept-request>request</span> and outputs a
 <span title=concept-response>response</span>.

 <p>That is, it either returns a <span title=concept-response>response</span> if
 <span title=concept-request>request</span>'s <span>synchronous flag</span> is set, or it
 <span title="queue a fetch task">queues tasks</span> annotated <span>process response</span>,
 <span>process response end-of-body</span>, and <span>process response done</span> for the
 <span title=concept-response>response</span>.

 <p>To capture uploads, if <span title=concept-request>request</span>'s
 <span>synchronous flag</span> is unset,
 <span data-anolis-spec=html title=concept-task>tasks</span> annotated
 <span>process request body</span> and <span>process request end-of-body</span> for the
 <span title=concept-request>request</span> can be
 <span title="queue a fetch task">queued</span>.
</div>

<p>To perform a <dfn title=concept-fetch data-export>fetch</dfn> using <var>request</var>, run
the steps below. An ongoing <span title=concept-fetch>fetch</span> can be
<dfn title=concept-fetch-terminate data-export data-dfn-for=fetch>terminated</dfn> with reason
<var>reason</var>, which must be <i title>end-user abort</i>, <i title>fatal</i>,
<i title>timeout</i>, or <i title>garbage collection</i>.

<p>The user agent may be asked to
<dfn title=concept-fetch-suspend data-export data-dfn-for=fetch>suspend</dfn> the ongoing fetch.
The user agent may either accept or ignore the suspension request. The suspended fetch can be
<dfn title=concept-fetch-resume data-export data-dfn-for=fetch>resumed</dfn>. The user agent should
ignore the suspension request if the ongoing fetch is updating the response in the HTTP cache for
the request.

<p class="note no-backref">The user agent does not update the entry in the HTTP cache for a
<span title=concept-request>request</span> if request's cache mode is "no-store" or a
`<code>Cache-Control: no-store</code>` header appears in the response.
<span data-anolis-ref>HTTP</span>

<ol>
 <li><p>If <var>request</var>'s <span title=concept-request-window>window</span> is
 "<code>client</code>", set <var>request</var>'s
 <span title=concept-request-window>window</span> to <var>request</var>'s
 <span title=concept-request-client>client</span>, if <var>request</var>'s
 <span title=concept-request-client>client</span>'s
 <span data-anolis-spec=html title=concept-settings-object-global>global object</span> is a
 <code data-anolis-spec=html>Window</code> object, and to "<code>no-window</code>"
 otherwise.

 <li><p>If <var>request</var>'s <span title=concept-request-origin>origin</span> is
 "<code>client</code>", set <var>request</var>'s
 <span title=concept-request-origin>origin</span> to  <var>request</var>'s
 <span title=concept-request-client>client</span>'s <span data-anolis-spec=html>origin</span>.

 <li>
  <p>If <var>request</var>'s <span title=concept-request-header-list>header list</span> does not
  contain a <span title=concept-header>header</span> whose
  <span title=concept-header-name>name</span> is `<code title>Accept</code>`, run these substeps:

  <ol>
   <li><p>Let <var>value</var> be `<code title>*/*</code>`.

   <li><p>If <var>request</var> is a <span>navigation request</span>, a user agent should set
   <var>value</var> to
   `<code title>text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</code>`.

   <li>
    <p>Otherwise, a user agent should set <var>value</var> to the first matching statement, if any,
    switching on <var>request</var>'s <span title=concept-request-type>type</span>:
    <!-- https://github.com/whatwg/fetch/issues/43#issuecomment-97909717 -->

    <dl class=switch>
     <dt>"<code title>image</code>"
     <dd>`<code title>image/png,image/svg+xml,image/*;q=0.8,*/*;q=0.5</code>`

     <dt>"<code title>style</code>"
     <dd>`<code title>text/css,*/*;q=0.1</code>`
    </dl>

   <li><p><span title=concept-header-list-append>Append</span>
   `<code title=http-accept>Accept</code>`/<var>value</var> to <var>request</var>'s
   <span title=concept-request-header-list>header list</span>.
  </ol>

 <li><p>If <var>request</var>'s <span title=concept-request-header-list>header list</span> does not
 contain a <span title=concept-header>header</span> whose
 <span title=concept-header-name>name</span> is
 `<code title=http-accept-language>Accept-Language</code>`, user agents should
 <span title=concept-header-list-append>append</span>
 `<code>Accept-Language</code>`/an appropriate <span title=concept-header-value>value</span>
 to <var>request</var>'s <span title=concept-request-header-list>header list</span>.

 <li>
  <p>If <var>request</var>'s <span title=concept-request-priority>priority</span> is
  null, use <var>request</var>'s
  <span title=concept-request-initiator>initiator</span>,
  <span title=concept-request-type>type</span>, and
  <span title=concept-request-destination>destination</span>
  appropriately in setting it to a user-agent-defined object.

  <p class=note>The user-agent-defined object could encompass stream weight and dependency
  for HTTP/2, and equivalent information used to prioritize dispatch and processing of
  HTTP/1 fetches.


 <li>
  <p>If <var>request</var> is a <span>navigation request</span>, a user agent should, for each
  <span title=concept-header>header</span> <span title=concept-header-name>name</span>
  (<var>hint-name</var>) in the first column of the following table, if <var>hint-name</var>
  is not in <var>request</var>'s <span title=concept-request-header-list>header list</span>,
  <span title=concept-header-list-append>append</span>
  <var>hint-name</var>/<var>hint-value</var> given in the same row on the second column, to
  <var>request</var>'s <span title=concept-request-header-list>header list</span>.

  <table>
   <tr>
    <th><span title=hint-name>hint-name</span>
    <th><span title=hint-value>hint-value</span>
   <tr>
    <td>`<code title=http-dpr>dpr</a></code>`
    <td>a suitable <a href=http://httpwg.org/http-extensions/client-hints.html#dpr>dpr value</a>
   <tr>
    <td>`<code title=http-save-data>save-data</code>`
    <td>a suitable <a href=http://httpwg.org/http-extensions/client-hints.html#save-data>save-data value</a>
   <tr>
    <td>`<code title=http-viewport-width>viewport-width</code>`
    <td>a suitable <a href=http://httpwg.org/http-extensions/client-hints.html#viewport-width>viewport-width value</a>
  </table>

 <li>
  <p>If <var>request</var> is a <span>subresource request</span>, run these substeps:

  <ol>
   <li>
    <p>If the <var>request</var>'s <span title=concept-client-hints-list>client hints list</span> is
    not empty, then run these substeps for each <var>hint-name</var> in the list:

    <ol>
     <li>
      <p>Set <var>value</var> to the first matching statement, if any, switching on
      <var>hint-name</var>:

      <dl class=switch>
       <dt>"<code title>dpr</code>"
       <dd>a suitable <a href=http://httpwg.org/http-extensions/client-hints.html#dpr>dpr value</a>
       <dt>"<code title>save-data</code>"
       <dd>a suitable <a href=http://httpwg.org/http-extensions/client-hints.html#save-data>save-data value</a>
       <dt>"<code title>viewport-width</code>"
       <dd>a suitable <a href=http://httpwg.org/http-extensions/client-hints.html#viewport-width>viewport-width value</a>
       <dt>"<code title>width</code>"
       <dd>a suitable <a href=http://httpwg.org/http-extensions/client-hints.html#width>width value</a></code>
      </dl>

     <li><p><span title=concept-header-list-append>Append</span>
     <var>hint-name</var>/<var>value</var> to <var>request</var>'s
     <span title=concept-request-header-list>header list</span>.
    </ol>

   <li><p>Let <var>record</var> be a new
   <span title=concept-fetch-record>fetch record</span> consisting of
   <var>request</var> and this instance of the
   <span title=concept-fetch>fetch</span> algorithm.

   <li><p>Append <var>record</var> to <var>request</var>'s
   <span title=concept-request-client>client</span>'s
   <span title=concept-fetch-group>fetch group</span> list of
   <span title=concept-fetch-record>fetch records</span>.
  </ol>

 <li><p>Return the result of performing a <span title=concept-main-fetch>main fetch</span>
 using <var>request</var>.
</ol>


<h3 id=main-fetch>Main fetch</h3>

<p>To perform a <dfn title=concept-main-fetch>main fetch</dfn> using <var>request</var>, optionally
with a <i>CORS flag</i> and <i>recursive flag</i>, run these steps:

<p class="note">When <span title="concept-main-fetch">main fetch</span> is invoked recursively
<i>recursive flag</i> is set. <i>CORS flag</i> is a bookkeeping detail for handling redirects.

<ol>
 <li><p>Let <var>response</var> be null.

 <li><p>If <var>request</var>'s <span>local-URLs-only flag</span> is set and
 <var>request</var>'s <span title=concept-request-current-url>current url</span> is
 not <span data-anolis-spec=url title="is local">local</span>, set
 <var>response</var> to a <span title=concept-network-error>network error</span>.

 <li><p>Execute <a href="https://w3c.github.io/webappsec-csp/#report-for-request">Report Content Security Policy violations for <var>request</var></a>.
 <span data-anolis-ref>CSP</span>

 <li><p><a href=https://w3c.github.io/webappsec-upgrade-insecure-requests/#upgrade-request>Upgrade <var>request</var> to a potentially secure URL, if appropriate</a>.
 <span data-anolis-ref>UPGRADE</span>

 <li><p>If
 <span title="block bad port">should fetching <var>request</var> be blocked due to a bad port</span>,
 <a href=https://w3c.github.io/webappsec-mixed-content/#should-block-fetch>should fetching <var>request</var> be blocked as mixed content</a>,
 or
 <a href="https://w3c.github.io/webappsec-csp/#should-block-request">should fetching <var>request</var> be blocked by Content Security Policy</a>
 returns <b title>blocked</b>, set <var>response</var> to a
 <span title=concept-network-error>network error</span>.
 <span data-anolis-ref>MIX</span>
 <span data-anolis-ref>CSP</span>

 <li><p>If <var>request</var>'s <span title=concept-request-referrer-policy>referrer policy</span>
 is the empty string and <var>request</var>'s
 <span title=concept-request-client>client</span> is non-null, then set <var>request</var>'s
 <span title=concept-request-referrer-policy>referrer policy</span> to <var>request</var>'s
 <span title=concept-request-client>client</span>'s
 <span data-anolis-spec=html title="environment settings object">referrer policy</span>.
 <span data-anolis-ref>REFERRER</span>
 <!-- We use "environment settings object" here because the HTML Standard does not have a definition
      for the referrer policy concept that is associated with it. -->

 <li>
  <p>If <var>request</var>'s <span title=concept-request-referrer-policy>referrer policy</span>
  is the empty string, then set <var>request</var>'s
  <span title=concept-request-referrer-policy>referrer policy</span> to
  "<code>no-referrer-when-downgrade</code>".

  <p class="note no-backref">We use "<code>no-referrer-when-downgrade</code>" because it is the
  historical default.

 <li>
  <p>If <var>request</var>'s <span title=concept-request-referrer>referrer</span>
  is not "<code>no-referrer</code>", set <var>request</var>'s
  <span title=concept-request-referrer>referrer</span> to the result of invoking
  <span data-anolis-spec=referrer>determine <var>request</var>'s referrer</span>.
  <span data-anolis-ref>REFERRER</span>

  <p class="note no-backref">As stated in <cite>Referrer Policy</cite>, user agents can
  provide the end user with options to override <var>request</var>'s
  <span title=concept-request-referrer>referrer</span> to "<code>no-referrer</code>" or
  have it expose less sensitive information.

 <li>
  <p>Set <var>request</var>'s <span title=concept-request-current-url>current url</span>'s
  <span data-anolis-spec=url title=concept-url-scheme>scheme</span> to "<code title>https</code>" if
  all of the following conditions are true:

  <ul class=brief>
   <li><var>request</var>'s <span title=concept-request-current-url>current url</span>'s
   <span data-anolis-spec=url title=concept-url-scheme>scheme</span> is "<code title>http</code>"
   <li><var>request</var>'s <span title=concept-request-current-url>current url</span>'s
   <span data-anolis-spec=url title=concept-url-host>host</span> is a
   <span data-anolis-spec=url title=concept-domain>domain</span>
   <li>Matching <var>request</var>'s <span title=concept-request-current-url>current url</span>'s
   <span data-anolis-spec=url title=concept-url-host>host</span> per
   <a href="https://tools.ietf.org/html/rfc6797#section-8.2">Known HSTS Host Domain Name Matching</a>
   results in either a superdomain match with an asserted <code title>includeSubDomains</code>
   directive or a congruent match (with or without an asserted <code title>includeSubDomains</code>
   directive) <span data-anolis-ref>HSTS</span>
  </ul>
 <!-- Per Mike West HSTS happens "probably after" Referrer -->

 <li><p>If <var>request</var>'s <span>synchronous flag</span> is unset and
 <i title>recursive flag</i> is unset, run the remaining steps
 <span data-anolis-spec=html>in parallel</span>.

 <li>
  <p>If <var>response</var> is null, then set <var>response</var> to the result of running the
  substeps corresponding to the first matching statement:

  <dl class=switch>
   <dt><var>request</var>'s <span title=concept-request-current-url>current url</span>'s
   <span data-anolis-spec=url title=concept-url-origin>origin</span> is <var>request</var>'s
   <span title=concept-request-origin>origin</span> and <i>CORS flag</i> is unset
   <dt><var>request</var>'s
   <span title=concept-request-current-url>current url</span>'s
   <span data-anolis-spec=url title=concept-url-scheme>scheme</span> is "<code>data</code>"
   <dt><var>request</var>'s <span title=concept-request-mode>mode</span> is
   "<code title>navigate</code>" or "<code title>websocket</code>"

   <dd>
    <ol>
     <li><p>Set <var>request</var>'s
     <span title=concept-request-response-tainting>response tainting</span> to "<code>basic</code>".

     <li><p>Return the result of performing a <span title=concept-basic-fetch>basic fetch</span>
     using <var>request</var>.
    </ol>

    <p class="note no-backref">HTML assigns any documents and workers created from
    <span data-anolis-spec=url title=concept-url>URLs</span> whose
    <span data-anolis-spec=url title=concept-url-scheme>scheme</span> is "<code>data</code>" a
    unique <span data-anolis-spec=html>opaque origin</span>. Service workers can only be created
    from <span data-anolis-spec=url title=concept-url>URLs</span> whose
    <span data-anolis-spec=url title=concept-url-scheme>scheme</span> is an
    <span data-anolis-spec=url>HTTP(S) scheme</span>.
    <span data-anolis-ref>HTML</span> <span data-anolis-ref>SW</span>

   <dt><var>request</var>'s <span title=concept-request-mode>mode</span> is
   "<code title>same-origin</code>"

   <dd><p>Return a <span title=concept-network-error>network error</span>.

   <dt><var>request</var>'s <span title=concept-request-mode>mode</span> is
   "<code title>no-cors</code>"
   <dd>
    <ol>
     <li><p>Set <var>request</var>'s
     <span title=concept-request-response-tainting>response tainting</span> to
     "<code title>opaque</code>".

     <li><p>Return the result of performing a <span title=concept-basic-fetch>basic fetch</span>
     using <var>request</var>.
     <!-- file URLs end up here as they are not same-origin typically. -->
    </ol>

   <dt><var>request</var>'s <span title=concept-request-current-url>current url</span>'s
   <span data-anolis-spec=url title=concept-url-scheme>scheme</span> is <em>not</em> an
   <span data-anolis-spec=url>HTTP(S) scheme</span>

   <dd><p>Return a <span title=concept-network-error>network error</span>.

   <dt><var>request</var>'s <span>use-CORS-preflight flag</span> is set
   <dt><var>request</var>'s <span>unsafe-request flag</span> is set and either <var>request</var>'s
   <span title=concept-request-method>method</span> is not a <span>CORS-safelisted method</span> or
   a <span title=concept-header>header</span> in <var>request</var>'s
   <span title=concept-header-list>header list</span> is not a
   <span>CORS-safelisted request-header</span>
   <dd>
    <ol>
     <li><p>Set <var>request</var>'s
     <span title=concept-request-response-tainting>response tainting</span> to
     "<code title>cors</code>".

     <li><p>Let <var>corsWithPreflightResponse</var> be the result of performing an
     <span title=concept-http-fetch>HTTP fetch</span> using <var>request</var> with <i>CORS flag</i>
     and <i>CORS-preflight flag</i> set.

     <li><p>If <var>corsWithPreflightResponse</var> is a
     <span title=concept-network-error>network error</span>, then
     <span title=concept-cache-clear>clear cache entries</span> using <var>request</var>.

     <li><p>Return <var>corsWithPreflightResponse</var>.
    </ol>

   <dt>Otherwise
   <dd>
    <ol>
     <li><p>Set <var>request</var>'s
     <span title=concept-request-response-tainting>response tainting</span> to
     "<code title>cors</code>".

     <li><p>Return the result of performing an <span title=concept-http-fetch>HTTP fetch</span>
     using <var>request</var> with <i>CORS flag</i> set.
    </ol>
  </dl>

 <li><p>If the <i>recursive flag</i> is set, return <var>response</var>.

 <li>
  <p>If <var>response</var> is not a <span title=concept-network-error>network error</span> and
  <var>response</var> is not a <span title=concept-filtered-response>filtered response</span>, then
  run these substeps:

  <ol>
   <li>
    <p>If <var>request</var>'s
    <span title=concept-request-response-tainting>response tainting</span> is
    "<code title>cors</code>", then run these substeps:

    <ol>
     <li><p>Let <var>headerNames</var> be the result of
     <span title=concept-header-parse>parsing</span>
     `<code title=http-access-control-expose-headers>Access-Control-Expose-Headers</code>` in
     <var>response</var>'s <span title=concept-response-header-list>header list</span>.

     <li><p>If <var>headerNames</var> is `<code title>*</code>` and <var>request</var>'s
     <span title=concept-request-credentials-mode>credentials mode</span> is not
     "<code>include</code>", then set <var>response</var>'s
     <span title=concept-response-cors-exposed-header-name-list>CORS-exposed header-name list</span>
     to all unique <span title=concept-header>header</span>
     <span title=concept-header-name>names</span> in <var>response</var>'s
     <span title=concept-response-header-list>header list</span>.

     <li><p>Otherwise, if <var>headerNames</var> is <em>not</em> `<code title>*</code>`, then set
     <var>response</var>'s
     <span title=concept-response-cors-exposed-header-name-list>CORS-exposed header-name list</span>
     to <var>headerNames</var>.
    </ol>

   <li>
    <p>Set <var>response</var> to the following
    <span title=concept-filtered-response>filtered response</span> with <var>response</var> as its
    <span title=concept-internal-response>internal response</span>, depending on
    <var>request</var>'s <span title=concept-request-response-tainting>response tainting</span>:

    <dl class="switch compact">
     <dt>"<code title>basic</code>"
     <dd><span title=concept-filtered-response-basic>basic filtered response</span>
     <dt>"<code title>cors</code>"
     <dd><span title=concept-filtered-response-cors>CORS filtered response</span>
     <dt>"<code title>opaque</code>"
     <dd><span title=concept-filtered-response-opaque>opaque filtered response</span>
    </dl>
  </ol>

 <li><p>Let <var>internalResponse</var> be <var>response</var>, if <var>response</var> is a
 <span title=concept-network-error>network error</span>, and <var>response</var>'s
 <span title=concept-internal-response>internal response</span> otherwise.

 <li>
  <p>If <var>internalResponse</var>'s <span title=concept-response-url-list>url list</span> is
  empty, then set it to a copy of <var>request</var>'s
  <span title=concept-request-url-list>url list</span>.

  <p class="note">A <span title=concept-response>response</span>'s
  <span title=concept-response-url-list>url list</span> will typically be empty at this point,
  unless it came from a service worker, in which case it will only be empty if it was created
  through <code title=dom-response>new Response()</code>.
 <!-- If you are ever tempted to move this around, carefully consider responses from about URLs,
      blob URLs, service workers, HTTP cache, HTTP network, etc. -->

 <li>
  <p>If <var>response</var> is not a <span title=concept-network-error>network error</span> and any
  of the following algorithms returns <b title>blocked</b>, then set <var>response</var> and
  <var>internalResponse</var> to a <span title=concept-network-error>network error</span>:

  <ul class="brief">
   <li><a href=https://w3c.github.io/webappsec-mixed-content/#should-block-response>should <var>internalResponse</var> to <var>request</var> be blocked as mixed content</a>
   <span data-anolis-ref>MIX</span>
   <li><a href=https://w3c.github.io/webappsec-csp/#should-block-response>should <var>internalResponse</var> to <var>request</var> be blocked by Content Security Policy</a>
   <span data-anolis-ref>CSP</span>
   <li><span title="should response to request be blocked due to mime type">should <var>internalResponse</var> to <var>request</var> be blocked due to its MIME type</span>
   <li><span title="should response to request be blocked due to nosniff">should <var>internalResponse</var> to <var>request</var> be blocked due to nosniff</span>
  </ul>

 <li>
  <p>If <var>response</var> is not a <span title=concept-network-error>network error</span> and
  either <var>request</var>'s <span title=concept-request-method>method</span> is
  `<code title>HEAD</code>` or `<code title>CONNECT</code>`, or <var>internalResponse</var>'s
  <span title=concept-response-status>status</span> is a <span>null body status</span>,
  set <var>internalResponse</var>'s <span title=concept-response-body>body</span> to
  null and disregard any enqueuing toward it (if any).

  <p class=note>This standardizes the error handling for servers that violate HTTP.

 <li>
  <p>If <var>response</var> is not a <span title=concept-network-error>network error</span> and
  <var>request</var>'s <span title=concept-request-integrity-metadata>integrity metadata</span> is
  not the empty string, run these substeps:

  <ol>
   <li><p><span title=concept-body-wait>Wait</span> for <var>response</var>'s
   <span title="concept-response-body">body</span></span>.

   <li><p>If <var>response</var> does not have a
   <span title=concept-response-termination-reason>termination reason</span> and
   <var>response</var> does not
   <a href=https://w3c.github.io/webappsec-subresource-integrity/#does-response-match-metadatalist>match</a>
   <var>request</var>'s <span title=concept-request-integrity-metadata>integrity metadata</span>,
   set <var>response</var> and <var>internalResponse</var> to a
   <span title=concept-network-error>network error</span>.
   <span data-anolis-ref>SRI</span>
  </ol>

  <p class=note>This operates on <var>response</var> as this algorithm is not supposed to observe
  <var>internalResponse</var>. That would allow an attacker to use hashes as an oracle.

 <li>
  <p>If <var>request</var>'s <span>synchronous flag</span> is set,
  <span title=concept-body-wait>wait</span> for <var>internalResponse</var>'s
  <span title=concept-response-body>body</span>, and then return <var>response</var>.

  <p class="note no-backref">This terminates <span title=concept-fetch>fetch</span>.

 <li>
  <p>If <var>request</var>'s <span title=concept-request-current-url>current url</span>'s
  <span data-anolis-spec=url title=concept-url-scheme>scheme</span> is an
  <span data-anolis-spec=url>HTTP(S) scheme</span>, then run these substeps:

  <ol>
   <li><p>If <var>request</var>'s <span title=concept-request-body>body</span> is
   <span title=concept-body-done>done</span>, <span>queue a fetch-request-done task</span> for
   <var>request</var>.

   <li><p>Otherwise, <span data-anolis-spec=html>in parallel</span>,
   <span title=concept-body-wait>wait</span> for <var>request</var>'s
   <span title=concept-request-body>body</span>, and then
   <span>queue a fetch-request-done task</span> for <var>request</var>.
  </ol>

 <li><p><span>Queue a fetch task</span> on <var>request</var> to
 <span>process response</span> for <var>response</var>.

 <li><p><span title=concept-body-wait>Wait</span> for <var>internalResponse</var>'s
 <span title=concept-response-body>body</span>.

 <li><p><span>Queue a fetch task</span> on <var>request</var> to
 <span>process response end-of-body</span> for <var>response</var>.

 <li><p>Wait for <var>internalResponse</var>'s <span title=concept-response-trailer>trailer</span>,
 if any. <span class=note>See
 <a href="https://tools.ietf.org/html/rfc7230#section-4.1.2">section 4.1.2</a> of
 <span data-anolis-ref>HTTP</span>.</span>

 <li><p>Set <var>request</var>'s <span>done flag</span>.

 <li><p><span>Queue a fetch task</span> on <var>request</var> to <span>process response done</span>
 for <var>response</var>.
</ol>


<h3 id=basic-fetch>Basic fetch</h3>

<p>To perform a <dfn title=concept-basic-fetch>basic fetch</dfn> using
<var>request</var>, switch on <var>request</var>'s
<span title=concept-request-current-url>current url</span>'s
<span data-anolis-spec=url title=concept-url-scheme>scheme</span>, and run the associated
steps:

<dl class=switch>
 <dt>"<code title>about</code>"
 <dd>
  <p>If <var>request</var>'s
  <span title=concept-request-current-url>current url</span>'s
  <span data-anolis-spec=url>non-relative flag</span> is set and
  <span data-anolis-spec=url title=concept-url-path>path</span> contains a single string
  "<code title>blank</code>", return a <span title=concept-response>response</span> whose
  <span title=concept-response-header-list>header list</span> consist of a single
  <span title=concept-header>header</span> whose
  <span title=concept-header-name>name</span> is `<code title>Content-Type</code>` and
  <span title=concept-header-value>value</span> is
  `<code title>text/html;charset=utf-8</code>`,
  <span title=concept-response-body>body</span> is the empty byte sequence, and
  <span title=concept-response-https-state>HTTPS state</span> is <var>request</var>'s
  <span title=concept-request-client>client</span>'s <span data-anolis-spec=html>HTTPS state</span>
  if <var>request</var>'s <span title=concept-request-client>client</span> is non-null.

  <p>Otherwise, return a <span title=concept-network-error>network error</span>.

  <p class="note no-backref"><span data-anolis-spec=url title=concept-url>URLs</span> such
  as "<code title>about:config</code>" are handled during
  <span data-anolis-spec=html title=navigate>navigation</span> and result in a
  <span title=concept-network-error>network error</span> in the context of
  <span title=concept-fetch>fetching</span>.

 <dt>"<code title>blob</code>"
 <dd>
  <ol>
   <li><p>Let <var>blob</var> be <var>request</var>'s
   <span title=concept-request-current-url>current url</span>'s
   <span data-anolis-spec=url title=concept-url-object>object</span>.

   <li>
    <p>If <var>request</var>'s <span title=concept-request-method>method</span> is not
    `<code>GET</code>` or <var>blob</var> is null, then return a
    <span title=concept-network-error>network error</span>.

    <p class="note">The `<code>GET</code>` <span title=concept-method>method</span> restriction
    serves no useful purpose other than being interoperable.

   <li><p>Let <var>response</var> be a new
   <span title=concept-response>response</span>.

   <li><p><span title=concept-header-list-append>Append</span>
   `<code title>Content-Length</code>`/<var>blob</var>'s
   <code data-anolis-spec=fileapi title=dom-Blob-size>size</code> attribute value to
   <var>response</var>'s
   <span title=concept-response-header-list>header list</span>.

   <li><p><span title=concept-header-list-append>Append</span>
   `<code title>Content-Type</code>`/<var>blob</var>'s
   <code data-anolis-spec=fileapi title=dom-Blob-type>type</code> attribute value to
   <var>response</var>'s
   <span title=concept-response-header-list>header list</span>.

   <li><p>Set <var>response</var>'s
   <span title=concept-response-https-state>HTTPS state</span> to <var>request</var>'s
   <span title=concept-request-client>client</span>'s <span data-anolis-spec=html>HTTPS state</span>
   if <var>request</var>'s <span title=concept-request-client>client</span> is non-null.

   <li><p>Set <var>response</var>'s <span title=concept-response-body>body</span> to
   the result of performing the <span data-anolis-spec=fileapi>read operation</span> on
   <var>blob</var>.
   <!-- This takes care of setting length, transmitted, and error flag as well -->

   <li><p>Return <var>response</var>.
  </ol>

 <dt>"<code title>data</code>"
 <dd>
  <p>If <a href="https://simonsapin.github.io/data-urls/">obtaining a resource</a> from
  <var>request</var>'s <span title=concept-request-current-url>current url</span> does not return
  failure, then return a <span title=concept-response>response</span> whose
  <span title=concept-response-header-list>header list</span> consist of a single
  <span title=concept-header>header</span> whose <span title=concept-header-name>name</span> is
  `<code title>Content-Type</code>` and <span title=concept-header-value>value</span> is the
  MIME type and parameters returned from
  <a href="https://simonsapin.github.io/data-urls/">obtaining a resource</a>,
  <span title=concept-response-body>body</span> is the data returned from
  <a href="https://simonsapin.github.io/data-urls/">obtaining a resource</a>, and
  <span title=concept-response-https-state>HTTPS state</span> is <var>request</var>'s
  <span title=concept-request-client>client</span>'s <span data-anolis-spec=html>HTTPS state</span>
  if <var>request</var>'s <span title=concept-request-client>client</span> is non-null.
  <span data-anolis-ref>DATAURL</span>
  <!-- XXX "obtaining a resource" needs a better reference -->

  <p>Otherwise, return a <span title=concept-network-error>network error</span>.

 <dt>"<code title>file</code>"
 <dt>"<code title>ftp</code>"
 <dd>
  <p>For now, unfortunate as it is, <code title>file</code> and <code title>ftp</code>
  <span data-anolis-spec=url title=concept-url>URLs</span> are left as an exercise for the
  reader.

  <p>When in doubt, return a <span title=concept-network-error>network error</span>.

 <dt>"<code title>filesystem</code>"</dt> <!-- flag below also applies to "indexeddb" -->
 <dd>
  <p>If <var>request</var>'s <span>sandboxed-storage-area-URLs flag</span> is set,
  return a <span title=concept-network-error>network error</span>.

  <p class=XXX>Otherwise, &hellip; this scheme still needs to be defined.

 <dt><span data-anolis-spec=url>HTTP(S) scheme</span>
 <dd>
  <p>Return the result of performing an <span title=concept-http-fetch>HTTP fetch</span>
  using <var>request</var>.

 <dt>Otherwise
 <dd><p>Return a <span title=concept-network-error>network error</span>.
</dl>


<h3 id=http-fetch>HTTP fetch</h3>

<p>To perform an <dfn title=concept-http-fetch>HTTP fetch</dfn> using <var>request</var> with an
optional <i>CORS flag</i> and <i>CORS-preflight flag</i>, run these steps:

<p class="note no-backref"><i>CORS flag</i> is still a bookkeeping detail. As is
<i>CORS-preflight flag</i>; it indicates a <span>CORS-preflight request</span> is needed.

<ol>
 <li><p>Let <var>response</var> be null.

 <li><p>Let <var>actualResponse</var> be null.

 <li>
  <p>If <var>request</var>'s <span>skip-service-worker flag</span> is unset, then run these
  substeps:

  <ol>
   <li>
    <p>If <var>request</var>'s <span title=concept-request-client>client</span> is null or
    <var>request</var>'s <span title=concept-request-client>client</span>'s
    <span data-anolis-spec=html title=concept-settings-object-global>global object</span> is not a
    <code data-anolis-spec=sw>ServiceWorkerGlobalScope</code> object, then set <var>response</var>
    to the result of invoking <span data-anolis-spec=sw>handle fetch</span> for <var>request</var>.
    <span data-anolis-ref>HTML</span> <span data-anolis-ref>SW</span>

   <li>
    <p>If <var>response</var> is null, <var>request</var> is a <span>subresource request</span>, and
    <var>request</var>'s <span title=concept-request-origin>origin</span> is not
    <span data-anolis-spec=html>same origin</span> with <var>request</var>'s
    <span title=concept-request-url>url</span>'s
    <span data-anolis-spec=url title=concept-url-origin>origin</span>, then set <var>response</var>
    to the result of invoking <span data-anolis-spec=sw>handle foreign fetch</span> for
    <var>request</var>. <span data-anolis-ref>SW</span>

   <li>
    <p>If <var>response</var> is not null, then run these substeps:

    <ol>
     <li><p><span title="Read a request">Read <var>request</var></span>.

     <li><p>Set <var>actualResponse</var> to <var>response</var>, if <var>response</var> is not a
     <span title=concept-filtered-response>filtered response</span>, and to <var>response</var>'s
     <span title=concept-internal-response>internal response</span> otherwise.

     <li>
      <p>If one of the following conditions is true, then return a
      <span title=concept-network-error>network error</span>:

      <ul class=brief>
       <li><var>response</var>'s
       <span title=concept-response-type>type</span> is "<code title>error</code>".

       <li><var>request</var>'s <span title=concept-request-mode>mode</span> is not
       "<code title>no-cors</code>" and <var>response</var>'s
       <span title=concept-response-type>type</span> is "<code title>opaque</code>".

       <li><var>request</var>'s <span title=concept-request-redirect-mode>redirect mode</span> is
       not "<code title>manual</code>" and <var>response</var>'s
       <span title=concept-response-type>type</span> is "<code title>opaqueredirect</code>".

       <li><var>request</var>'s <span title=concept-request-redirect-mode>redirect mode</span> is
       not "<code title>follow</code>" and <var>response</var>'s
       <span title=concept-response-url-list>url list</span> has more than one item.
      </ul>

     <li><p>Execute
     <a href=https://w3c.github.io/webappsec-csp/#set-response-csp-list>set <var>response</var>'s CSP list</a>
     on <var>actualResponse</var>. <span data-anolis-ref>CSP</span>
    </ol>
  </ol>

 <li>
  <p>If <var>response</var> is null, run these substeps:

  <ol>
   <li>
    <p>If the <i title>CORS-preflight flag</i> is set and one of these conditions is true:

    <ul>
     <li>There is no <span title=concept-cache-match-method>method cache match</span> for
     <var>request</var>'s <span title=concept-request-method>method</span> using <var>request</var>,
     and either <var>request</var>'s <span title=concept-request-method>method</span> is a not a
     <span>CORS-safelisted method</span> or <var>request</var>'s
     <span>use-CORS-preflight flag</span> is set.

     <li>There is at least one <span title=concept-header>header</span> in
     <var>request</var>'s <span title=concept-request-header-list>header list</span>
     for whose <span title=concept-header-name>name</span> there is no
     <span title=concept-cache-match-header>header-name cache match</span> using
     <var>request</var> and which is not a <span>CORS-safelisted request-header</span>.
    </ul>

    <p>Then run these subsubsteps:

    <ol>
     <li><p>Let <var>preflightResponse</var> be the result of performing a
     <span>CORS-preflight fetch</span> using <var>request</var>.

     <li><p>If <var>preflightResponse</var> is a
     <span title=concept-network-error>network error</span>, return
     <var>preflightResponse</var>.
    </ol>

    <p class="note no-backref">This step checks the
    <span title=concept-cache>CORS-preflight cache</span> and if there is no suitable entry it
    performs a <span>CORS-preflight fetch</span> which, if successful, populates the cache. The
    purpose of the <span>CORS-preflight fetch</span> is to ensure the
    <span title=concept-fetch>fetched</span> resource is familiar with the
    <span>CORS protocol</span>. The cache is there to minimize the number of
    <span title="CORS-preflight fetch">CORS-preflight fetches</span>.

   <li>
    <p>If <var>request</var>'s <span title=concept-request-redirect-mode>redirect mode</span> is
    "<code>follow</code>", then set <var>request</var>'s <span>skip-service-worker flag</span>.

    <p class="note no-backref">Redirects coming from the network (as opposed to from a service
    worker) are not to be exposed to a service worker.

   <li><p>Set <var>response</var> and <var>actualResponse</var> to the result of performing an
   <span title=concept-http-network-or-cache-fetch>HTTP-network-or-cache fetch</span> using
   <var>request</var> with <i>CORS flag</i> if set.

   <li>
    <p>If <i>CORS flag</i> is set and a <span title=concept-cors-check>CORS check</span> for
    <var>request</var> and <var>response</var> returns failure, then return a
    <span title=concept-network-error>network error</span>.

    <p class="note no-backref">As the <span title=concept-cors-check>CORS check</span> is not to be
    applied to <span title=concept-response>responses</span> whose
    <span title=concept-response-status>status</span> is <code>304</code> or <code>407</code>, or
    <span title=concept-response>responses</span> from a service worker for that matter, it is
    applied here.
  </ol>

 <li>
  <p>If <var>actualResponse</var>'s <span title=concept-response-status>status</span> is a
  <span>redirect status</span>, then run these substeps:

  <ol>
   <li>
    <p>If <var>actualResponse</var>'s <span title=concept-response-status>status</span> is not
    <code>303</code>, <var>request</var>'s <span title=concept-request-body>body</span> is not
    <span title=concept-body-done>done</span>, and the
    <span title=concept-connection>connection</span> uses HTTP/2, then user agents may, and are even
    encouraged to, transmit an <code>RST_STREAM</code> frame.

    <p class="note"><code>303</code> is excluded as certain communities ascribe special status to
    it.

   <li><p>Let <var>location</var> be the result of <span title=concept-header-parse>parsing</span>
   `<code title>Location</code>` in <var>actualResponse</var>'s
   <span title=concept-response-header-list>header list</span>.

   <li><p>If <var>location</var> is a <span title=concept-header-value>value</span>, then set
   <var>location</var> to the result of
   <span data-anolis-spec=url title=concept-url-parser>parsing</span> <var>location</var> with
   <var>actualResponse</var>'s <span title=concept-response-url>url</span>.

   <li><p>Set <var>actualResponse</var>'s
   <span title=concept-response-location-url>location URL</span> to <var>location</var>.

   <li>
    <p>Switch on <var>request</var>'s
    <span title=concept-request-redirect-mode>redirect mode</span>:

    <dl class=switch>
     <dt>"<code title>error</code>"
     <dd><p>Set <var>response</var> to a <span title=concept-network-error>network error</span>.

     <dt>"<code title>manual</code>"
     <dd><p>Set <var>response</var> to an
     <span title=concept-filtered-response-opaque-redirect>opaque-redirect filtered response</span>
     whose <span title=concept-internal-response>internal response</span> is
     <var>actualResponse</var>.

     <dt>"<code title>follow</code>"
     <dd><p>Set <var>response</var> to the result of performing
     <span title=concept-http-redirect-fetch>HTTP-redirect fetch</span> using <var>request</var> and
     <var>response</var> with <i>CORS flag</i> if set.
    </dl>
    <!-- not resetting actualResponse since it's no longer used anyway -->
  </ol>

 <li><p>Return <var>response</var>. <span class="note no-backref">Typically
 <var>actualResponse</var>'s <span title=concept-response-body>body</span>'s
 <span title=concept-body-stream>stream</span> is still being enqueued to after returning.</span>
</ol>


<h3 id=http-redirect-fetch>HTTP-redirect fetch</h3>

<p class="note no-backref">This algorithm will be used by <cite>HTML</cite>'s "navigate" algorithm
in addition to <span title=concept-http-fetch>HTTP fetch</span> above.
<span data-anolis-ref>HTML</span>

<p>To perform an <dfn title=concept-http-redirect-fetch data-export>HTTP-redirect fetch</dfn> using
<var>request</var> and <var>response</var>, with an optional <i>CORS flag</i>, run these steps:

<ol>
 <li><p>Let <var>actualResponse</var> be <var>response</var>, if <var>response</var> is not a
 <span title=concept-filtered-response>filtered response</span>, and <var>response</var>'s
 <span title=concept-internal-response>internal response</span> otherwise.

 <li><p>If <var>actualResponse</var>'s <span title=concept-response-location-url>location URL</span>
 is null, then return <var>response</var>.

 <li><p>If <var>actualResponse</var>'s <span title=concept-response-location-url>location URL</span>
 is failure, then return a <span title=concept-network-error>network error</span>.
 <!-- only Gecko does this; and even that is currently more complicated -->

 <li><p>If <var>actualResponse</var>'s
 <span title=concept-response-location-url>location URL</span>'s
 <span data-anolis-spec=url title=concept-url-scheme>scheme</span> is <em>not</em> an
 <span data-anolis-spec=url>HTTP(S) scheme</span>, then return a
 <span title=concept-network-error>network error</span>.

 <li><p>If <var>request</var>'s <span title=concept-request-redirect-count>redirect count</span> is
 twenty, return a <span title=concept-network-error>network error</span>.

 <li><p>Increase <var>request</var>'s
 <span title=concept-request-redirect-count>redirect count</span> by one.

 <li><p>If <var>request</var>'s <span title=concept-request-mode>mode</span> is "<code>cors</code>",
 <var>request</var>'s <span title=concept-request-origin>origin</span> is <em>not</em>
 <span data-anolis-spec=html>same origin</span> with <var>actualResponse</var>'s
 <span title=concept-response-location-url>location URL</span>'s
 <span data-anolis-spec=url title=concept-url-origin>origin</span>, and <var>actualResponse</var>'s
 <span title=concept-response-location-url>location URL</span>
 <span data-anolis-spec=url title="include credentials">includes credentials</span>, then return a
 <span title=concept-network-error>network error</span>.

 <li>
  <p>If <i>CORS flag</i> is set and <var>actualResponse</var>'s
  <span title=concept-response-location-url>location URL</span>
  <span data-anolis-spec=url title="include credentials">includes credentials</span>, then return a
  <span title=concept-network-error>network error</span>.

  <p class=note>This catches a cross-origin resource redirecting to a same-origin URL.

 <li><p>If <i>CORS flag</i> is set and <var>actualResponse</var>'s
 <span title=concept-response-location-url>location URL</span>'s
 <span data-anolis-spec=url title=concept-url-origin>origin</span> is <em>not</em>
 <span data-anolis-spec=html>same origin</span> with <var>request</var>'s
 <span title=concept-request-current-url>current url</span>'s
 <span data-analis-spec=url title=concept-url-origin>origin</span>, set <var>request</var>'s
 <span title=concept-request-origin>origin</span> to a globally unique identifier.

 <li><p>If either <var>actualResponse</var>'s <span title=concept-response-status>status</span> is
 <code title>301</code> or <code title>302</code> and <var>request</var>'s
 <span title=concept-request-method>method</span> is `<code title>POST</code>`, or
 <var>actualResponse</var>'s <span title=concept-response-status>status</span> is
 <code title>303</code>, set <var>request</var>'s <span title=concept-request-method>method</span>
 to `<code title>GET</code>` and <var>request</var>'s <span title=concept-request-body>body</span>
 to null.

 <li><p>Append <var>actualResponse</var>'s
 <span title=concept-response-location-url>location URL</span> to <var>request</var>'s
 <span title=concept-request-url-list>url list</span>.

 <li><p>Invoke
 <span data-anolis-spec=referrer>set <var>request</var>'s referrer policy on redirect</span> on
 <var>request</var> and <var>actualResponse</var>. <span data-anolis-ref>REFERRER</span>

 <li>
  <p>Return the result of performing a <span title=concept-main-fetch>main fetch</span> using
  <var>request</var> with <i>CORS flag</i> if set and <i>recursive flag</i> set.

  <p class="note no-backref">This has to invoke <span title=concept-main-fetch>main fetch</span> to
  get <span title=concept-request-response-tainting>response tainting</span> correct.
</ol>


<h3 id=http-network-or-cache-fetch>HTTP-network-or-cache fetch</h3>

<p>To perform an
<dfn title=concept-http-network-or-cache-fetch>HTTP-network-or-cache fetch</dfn> using
<var>request</var> with an optional <i>CORS flag</i> and <i>authentication-fetch flag</i>, run these
steps:

<p class=note><i>CORS flag</i> is still a bookkeeping detail. As is
<i>authentication-fetch flag</i>.

<ol>
 <li>
  <p>Let <var>httpRequest</var> be <var>request</var> if
  <var>request</var>'s <span title=concept-request-window>window</span> is "<code>no-window</code>"
  and <var>request</var>'s <span title=concept-request-redirect-mode>redirect mode</span> is
  "<code>error</code>", and the result of <span title=concept-request-clone>cloning</span>
  <var>request</var> otherwise.

  <p class="note no-backref">A <var>request</var> is typically cloned as it needs to be possible to
  add <span title=concept-header>headers</span> and read its
  <span title=concept-request-body>body</span> without affecting <var>request</var>. As
  <var>request</var> is reused with redirects, authentication, and proxy authentication.

 <li>
  <p>Let <i>credentials flag</i> be set if one of

  <ul class=brief>
   <li><var>request</var>'s <span title=concept-request-credentials-mode>credentials mode</span> is
   "<code>include</code>"
   <li><var>request</var>'s  <span title=concept-request-credentials-mode>credentials mode</span> is
   "<code>same-origin</code>" and <var>request</var>'s
   <span title=concept-request-response-tainting>response tainting</span> is "<code>basic</code>"
  </ul>

  <p>is true, and unset otherwise.

 <li><p>Let <var>contentLengthValue</var> be null.

 <li><p>If <var>httpRequest</var>'s <span title=concept-request-body>body</span> is null and
 <var>httpRequest</var>'s <span title=concept-request-method>method</span> is
 `<code title>POST</code>` or `<code title>PUT</code>`, then set <var>contentLengthValue</var> to
 `<code title>0</code>`.
 <!-- https://chromium.googlesource.com/chromium/src/+/master/net/http/http_network_transaction.cc#982 -->

 <li><p>If <var>httpRequest</var>'s <span title=concept-request-body>body</span> is
 non-null, set <var>contentLengthValue</var> to <var>httpRequest</var>'s
 <span title=concept-request-body>body</span>'s
 <span title=concept-body-total-bytes>total bytes</span>,
 <span data-anolis-spec=encoding title="utf-8 encode">utf-8 encoded</span>.
 <!-- XXX with streams we don't always know the length and so need to do chunked here -->

 <li><p>If <var>contentLengthValue</var> is non-null,
 <span title=concept-header-list-append>append</span>
 `<code title>Content-Length</code>`/<var>contentLengthValue</var> to
 <var>httpRequest</var>'s
 <span title=concept-request-header-list>header list</span>.

 <li>
  <p>If <var>contentLengthValue</var> is non-null, <var>httpRequest</var>'s
  <span>keepalive flag</span> is set, and <var>contentLengthValue</var> is greater than a
  user-agent-defined maximum, then return a <span title=concept-network-error>network error</span>.

  <p class="note no-backref">The above user-agent-defined maximum ensures that requests that are
  allowed to outlive the <span data-anolis-spec=html>environment settings object</span> and contain
  a body, have a bounded size and are not allowed to stay alive indefinitely.

 <li><p>If <var>httpRequest</var>'s <span title=concept-request-referrer>referrer</span> is a
 <span data-anolis-spec=url title=concept-url>URL</span>, then
 <span title=concept-header-list-append>append</span>
 `<code title>Referer</code>`/<var>httpRequest</var>'s
 <span title=concept-request-referrer>referrer</span>,
 <span data-anolis-spec=url title=concept-url-serializer>serialized</span> and
 <span data-anolis-spec=encoding title="utf-8 encode">utf-8 encoded</span>, to
 <var>httpRequest</var>'s <span title=concept-request-header-list>header list</span>.
 <!-- XXX ideally we have an easier way to convert something ASCII-safe into bytes
          concept-as-bytes -->

 <li><p>If <var>httpRequest</var>'s <span>omit-<code>Origin</code>-header flag</span> is
 unset, <span title=concept-header-list-append>append</span>
 `<code title>Origin</code>`/<var>httpRequest</var>'s
 <span title=concept-request-origin>origin</span>,
 <span data-anolis-spec=html title="ASCII serialization of an origin">serialized</span>
 and <span data-anolis-spec=encoding title="utf-8 encode">utf-8 encoded</span>, to
 <var>httpRequest</var>'s
 <span title=concept-request-header-list>header list</span>.
 <!-- XXX concept-as-bytes -->

 <li><p>If <var>httpRequest</var>'s <span title=concept-request-header-list>header list</span> does
 <em>not</em> contain a <span title=concept-header>header</span> whose
 <span title=concept-header-name>name</span> is `<code title=http-user-agent>User-Agent</code>`,
 user agents should <span title=concept-header-list-append>append</span>
 `<code title=http-user-agent>User-Agent</code>`/<span>default `<code>User-Agent</code>` value</span>
 to <var>httpRequest</var>'s <span title=concept-request-header-list>header list</span>.

 <li><p>If <var>httpRequest</var>'s <span title=concept-request-cache-mode>cache mode</span> is
 "<code title>default</code>" and <var>httpRequest</var>'s
 <span title=concept-request-header-list>header list</span> contains a
 <span title=concept-header>header</span> <span title=concept-header-named>named</span>
 `<code title>If-Modified-Since</code>`,
 `<code title>If-None-Match</code>`,
 `<code title>If-Unmodified-Since</code>`,
 `<code title>If-Match</code>`, or
 `<code title>If-Range</code>`, set <var>httpRequest</var>'s
 <span title=concept-request-cache-mode>cache mode</span> to "<code title>no-store</code>".

 <li><p>If <var>httpRequest</var>'s <span title=concept-request-cache-mode>cache mode</span> is
 "<code title>no-cache</code>" and <var>httpRequest</var>'s
 <span title=concept-request-header-list>header list</span> does <em>not</em> contain a
 <span title=concept-header>header</span> whose <span title=concept-header-name>name</span> is
 `<code title=http-cache-control>Cache-Control</code>`,
 <span title=concept-header-list-append>append</span>
 `<code title=http-cache-control>Cache-Control</code>`/`<code title>max-age=0</code>` to
 <var>httpRequest</var>'s <span title=concept-request-header-list>header list</span>.

 <li>
  <p>If <var>httpRequest</var>'s <span title=concept-request-cache-mode>cache mode</span> is
  "<code title>no-store</code>" or "<code title>reload</code>", run these substeps:

  <ol>
   <li><p>If <var>httpRequest</var>'s <span title=concept-request-header-list>header list</span>
   does <em>not</em> contain a <span title=concept-header>header</span> whose
   <span title=concept-header-name>name</span> is `<code title=http-pragma>Pragma</code>`,
   <span title=concept-header-list-append>append</span>
   `<code title=http-pragma>Pragma</code>`/`<code title>no-cache</code>` to <var>httpRequest</var>'s
   <span title=concept-request-header-list>header list</span>.

   <li><p>If <var>httpRequest</var>'s <span title=concept-request-header-list>header list</span>
   does <em>not</em> contain a <span title=concept-header>header</span> whose
   <span title=concept-header-name>name</span> is
   `<code title=http-cache-control>Cache-Control</code>`,
   <span title=concept-header-list-append>append</span>
   `<code title=http-cache-control>Cache-Control</code>`/`<code title>no-cache</code>` to
   <var>httpRequest</var>'s <span title=concept-request-header-list>header list</span>.
   <!-- Technically this only applies to HTTP/1.1 and up -->
  </ol>

 <li>
  <p>Modify <var>httpRequest</var>'s
  <span title=concept-request-header-list>header list</span> per HTTP.

  <p class="note no-backref">It would be great if we could make this more normative
  somehow. At this point <span title=concept-header>headers</span> such as
  `<code title=http-accept-encoding>Accept-Encoding</code>`,
  `<code title=http-connection>Connection</code>`,
  `<code title=http-dnt>DNT</code>`, and
  `<code title=http-host>Host</code>`,
  are to be <span title=concept-header-list-append>appended</span> if necessary.

  <p>`<code title=http-accept>Accept</code>`,
  `<code title=http-accept-charset>Accept-Charset</code>`, and
  `<code title=http-accept-language>Accept-Language</code>` must not be included at this point.

  <p class="note no-backref">`<code title=http-accept>Accept</code>` and
  `<code title=http-accept-language>Accept-Language</code>` are already included (unless
  <code title=dom-global-fetch>fetch()</code> is used, which does not include the latter by
  default), and `<code title=http-accept-charset>Accept-Charset</code>` is a waste of bytes. See
  <span>HTTP header layer division</span> for more details.

 <li>
  <p>If <i>credentials flag</i> is set, run these substeps:

  <ol>
   <li>
    <p>If the user agent is not configured to block cookies for <var>httpRequest</var> (see
    <a href="https://tools.ietf.org/html/rfc6265#section-7">section 7</a> of
    <span data-anolis-ref>COOKIES</span>), then run these substeps:

    <ol>
     <li><p>Let <var>cookies</var> be the result of running the "cookie-string" algorithm (see
     <a href="https://tools.ietf.org/html/rfc6265#section-5.4">section 5.4</a> of
     <span data-anolis-ref>COOKIES</span>) with the user agent's cookie store and
     <var>httpRequest</var>'s <span title=concept-request-current-url>current url</span>.

     <li>If <var>cookies</var> is not the empty string, append
     `<code title=http-cookies>Cookie</code>`/<var>cookies</var> to <var>httpRequest</var>'s
     <span title=concept-request-header-list>header list</span>.
    </ol>

   <li><p>If <var>httpRequest</var>'s <span title=concept-request-header-list>header list</span>
   contains a <span title=concept-header>header</span> whose
   <span title=concept-header-name>name</span> is
   `<code title=http-authorization>Authorization</code>`, terminate these substeps.

   <!-- https://wiki.whatwg.org/wiki/HTTP_Authentication -->
   <li><p>Let <var>authorizationValue</var> be null.

   <li><p>If there's an <span>authentication entry</span> for <var>httpRequest</var>
   and either <var>httpRequest</var>'s
   <span title=concept-request-use-url-credentials-flag>use-URL-credentials flag</span> is
   unset or <var>httpRequest</var>'s
   <span title=concept-request-current-url>current url</span> does not
   <span data-anolis-spec=url>include credentials</span>, set
   <var>authorizationValue</var> to <span>authentication entry</span>.
   <!-- need to define the cache concept -->

   <li><p>Otherwise, if <var>httpRequest</var>'s
   <span title=concept-request-current-url>current url</span> does
   <span data-anolis-spec=url>include credentials</span> and <i>authentication-fetch flag</i> is
   set, then set <var>authorizationValue</var> to <var>httpRequest</var>'s
   <span title=concept-request-current-url>current url</span>,
   <span class=XXX>converted to an `<code title>Authorization</code>` value</span>.

   <li><p>If <var>authorizationValue</var> is non-null,
   <span title=concept-header-list-append>append</span>
   `<code title>Authorization</code>`/<var>authorizationValue</var> to
   <var>httpRequest</var>'s
   <span title=concept-request-header-list>header list</span>.
  </ol>

 <li>
  <p>If there's a <span>proxy-authentication entry</span>, use it as appropriate.

  <p class="note no-backref">This intentionally does not depend on
  <var>httpRequest</var>'s
  <span title=concept-request-credentials-mode>credentials mode</span>.

 <li><p>Let <var>response</var> be null.

 <li>
  <p>If <var>httpRequest</var>'s
  <span title=concept-request-cache-mode>cache mode</span> is neither
  "<code title>no-store</code>" nor "<code title>reload</code>", and there is a <em>complete</em>
  <span title=concept-response>response</span> in the HTTP cache for
  <var>httpRequest</var> run these substeps:
  <!-- XXX xref "HTTP cache" -->

  <ol>
   <li>
    <p>If <var>httpRequest</var>'s <span title=concept-request-cache-mode>cache mode</span> is
    "<code title>force-cache</code>" or "<code title>only-if-cached</code>", then set
    <var>response</var> to the <span title=concept-response>response</span> in the HTTP cache for
    <var>httpRequest</var>.

    <p class="note">As mandated by HTTP, this still takes the `<code title=http-vary>Vary</code>`
    <span title=concept-header>header</span> into account.

   <li><p>Otherwise, if <var>httpRequest</var>'s
   <span title=concept-request-cache-mode>cache mode</span> is "<code title>default</code>" and the
   <span title=concept-response>response</span> in the HTTP cache for <var>httpRequest</var> does
   not require revalidation, then set <var>response</var> to that
   <span title=concept-response>response</span>.
   <!-- XXX xref "revalidation" -->

   <li><p>Otherwise, if <var>httpRequest</var>'s
   <span title=concept-request-cache-mode>cache mode</span> is either "<code title>default</code>"
   or "<code title>no-cache</code>", modify <var>httpRequest</var>'s
   <span title=concept-request-header-list>header list</span> with revalidation
   <span title=concept-header>headers</span>.
   <!-- XXX modify, revalidation headers -->
  </ol>

 <li><p>Otherwise, if <var>httpRequest</var>'s
 <span title=concept-request-cache-mode>cache mode</span> is either
 "<code title>default</code>" or "<code title>force-cache</code>", and there is a
 <em>partial</em> <span title=concept-response>response</span> in the HTTP cache for
 <var>httpRequest</var>, modify <var>httpRequest</var>'s
 <span title=concept-request-header-list>header list</span> with resume
 <span title=concept-header>headers</span>.
 <!-- XXX xref partial, modify, resume headers -->

 <li>
  <p>If <var>response</var> is null, run these substeps:

  <ol>
   <li><p>If <var>httpRequest</var>'s <span title=concept-request-cache-mode>cache mode</span> is
   "<code title>only-if-cached</code>", then return a
   <span title=concept-network-error>network error</span>.

   <li><p>Set <var>response</var> to the result of making an
   <span title=concept-http-network-fetch>HTTP-network fetch</span> using <var>httpRequest</var>
   with <i>credentials flag</i> if set.
  </ol>

 <li>
  <p>If <var>response</var>'s <span title=status>status</span> is <code>304</code> and
  <var>httpRequest</var>'s <span title=concept-request-cache-mode>cache mode</span> is either
  "<code title>default</code>" or "<code title>no-cache</code>", run these substeps:

  <ol>
   <li><p>Set <var>cachedResponse</var> to the result of selecting a stored
   <span title=concept-response>response</span> from the HTTP cache using <var>httpRequest</var>, as
   per the
   "<a href="https://tools.ietf.org/html/rfc7234#section-4.3.4">Freshening Stored Responses upon Validation</a>"
   chapter of <cite>HTTP Caching</cite>. <span data-anolis-ref>HTTP</span>

   <li><p>If <var>cachedResponse</var> is null (i.e., one cannot be selected), return a
   <span title=concept-network-error>network error</span>.

   <li><p>Update <var>cachedResponse</var>'s <span title=concept-header-list>header list</span>
   using <var>response</var>'s <span title=concept-header-list>header list</span>, as per the
   "<a href="https://tools.ietf.org/html/rfc7234#section-4.3.4">Freshening Stored Responses upon Validation</a>"
   chapter of <cite>HTTP Caching</cite>. <span data-anolis-ref>HTTP</span>

   <li>
    <p>Set <var>response</var> to the <var>cachedResponse</var>.

    <p class="note no-backref">This changes <var>response</var> entirely, including its
    <span title=concept-response-status>status</span> which is most likely <code>200</code> now.
  </ol>

 <li>
  <p>If <var>response</var>'s <span title=status>status</span> is <code>401</code>, <i>CORS flag</i>
  is unset, <i>credentials flag</i> is set, and <var>request</var>'s
  <span title=concept-request-window>window</span> is an
  <span data-anolis-spec=html>environment settings object</span>, then run these substeps:

  <ol>
   <li class=XXX><p>Needs testing: multiple `<code>WWW-Authenticate</code>` headers, missing,
   parsing issues.

   <li>
    <p>If <var>request</var>'s
    <span title=concept-request-use-url-credentials-flag>use-URL-credentials flag</span> is unset or
    <i>authentication-fetch flag</i> is set, then run these subsubsteps:

    <ol>
     <li><p>Let <var>username</var> and <var>password</var> be the result of prompting the end user
     for a username and password, respectively, in <var>request</var>'s
     <span title=concept-request-window>window</span>.

     <li><p><span data-anolis-spec=url>Set the username</span> given <var>request</var>'s
     <span title=concept-request-current-url>current url</span> and <var>username</var>.

     <li><p><span data-anolis-spec=url>Set the password</span> given <var>request</var>'s
     <span title=concept-request-current-url>current url</span> and <var>password</var>.
    </ol>

   <li><p>Set <var>response</var> to the result of performing an
   <span title=concept-http-network-or-cache-fetch>HTTP-network-or-cache fetch</span> using
   <var>request</var> with <i>authentication-fetch flag</i> set.
  </ol>

 <li>
  <p>If <var>response</var>'s <span title=status>status</span> is <code>407</code>, then run these
  substeps:

  <ol>
   <li><p>If <var>request</var>'s <span title=concept-request-window>window</span> is
   "<code>no-window</code>", then return a <span title=concept-network-error>network error</span>.

   <li class=XXX><p>Needs testing: multiple `<code>Proxy-Authenticate</code>` headers, missing,
   parsing issues.

   <li>
    <p>Prompt the end user as appropriate in <var>request</var>'s
    <span title=concept-request-window>window</span> and store the result as a
    <span>proxy-authentication entry</span>. <span data-anolis-ref>HTTP</span>

    <p class=note>Remaining details surrounding proxy authentication are defined by HTTP.

   <li><p>Set <var>response</var> to the result of performing an
   <span title=concept-http-network-or-cache-fetch>HTTP-network-or-cache fetch</span> using
   <var>request</var> with <i>CORS flag</i> if set.
  </ol>

 <li><p>If <i>authentication-fetch flag</i> is set, then create an <span>authentication entry</span>
 for <var>request</var> and the given realm.

 <li><p>Return <var>response</var>. <span class="note no-backref">Typically
 <var>response</var>'s <span title=concept-response-body>body</span>'s
 <span title=concept-body-stream>stream</span> is still being enqueued to after returning.</span>
</ol>


<h3 id=http-network-fetch>HTTP-network fetch</h3>

<p>To perform an <dfn title=concept-http-network-fetch>HTTP-network fetch</dfn> using
<var>request</var> with an optional <i>credentials flag</i>, run these steps:

<ol>
 <li><p>Let <var>credentials</var> be true if <i>credentials flag</i> is set, and false otherwise.

 <li>
  <p>Switch on <var>request</var>'s <span title=concept-request-mode>mode</span>:

  <dl>
   <dt>"<code title>websocket</code>"
   <dd><p>Let <var>connection</var> be the result of
   <span title=concept-websocket-connection-obtain>obtaining a WebSocket connection</span>, given
   <var>request</var>'s <span title=concept-request-current-url>current url</span>.

   <dt>Otherwise
   <dd><p>Let <var>connection</var> be the result of
   <span title=concept-connection-obtain>obtaining a connection</span>, given <var>request</var>'s
   <span title=concept-request-current-url>current url</span>'s
   <span data-anolis-spec=url title=concept-url-origin>origin</span> and <var>credentials</var>.
  </dl>

 <li><p>If <var>connection</var> is failure, return a
 <span title=concept-network-error>network error</span>.

 <li>
  <p>Let <var>response</var> be the result of making an HTTP request over <var>connection</var>
  using <var>request</var> with the following caveats:

  <ul>
   <li><p>Follow the relevant requirements from HTTP. <span data-anolis-ref>HTTP</span>

   <li><p>Wait until all the <span title=concept-header>headers</span> are transmitted or
   <span title=concept-fetch>fetch</span> is being
   <span title=concept-fetch-terminate>terminated</span> with reason <var>reason</var>. If
   <span title=concept-fetch>fetch</span> is being
   <span title=concept-fetch-terminate>terminated</span>, then set <var>response</var>'s
   <span title=concept-response-termination-reason>termination reason</span> to <var>reason</var>.

   <li>
    <p>Any <span title=concept-response>responses</span> whose
    <span title=concept-response-status>status</span> is in the range <code>100</code> to
    <code>199</code>, inclusive, and is not <code>101</code>, are to be ignored.

    <p class="note no-backref">These kind of <span title=concept-response>responses</span> are
    eventually followed by a "final" <span title=concept-response>response</span>.
  </ul>

  <p class="note">The exact layering between Fetch and HTTP still needs to be sorted through and
  therefore <var>response</var> represents both a <span title=concept-response>response</span> and
  an HTTP response here.

  <p>If the HTTP request results in a TLS client certificate dialog, run these substeps:

  <ol>
   <li><p>If <var>request</var>'s <span title=concept-request-window>window</span>
   is an <span data-anolis-spec=html>environment settings object</span>, make the dialog
   available in <var>request</var>'s
   <span title=concept-request-window>window</span>.

   <li><p>Otherwise, return a <span title=concept-network-error>network error</span>.
  </ol>

  <p>If <var>response</var> was retrieved over HTTPS, set its
  <span title=concept-response-https-state>HTTPS state</span> to either
  "<code title>deprecated</code>" or "<code title>modern</code>".
  <span data-anolis-ref>TLS</span>

  <p class="note no-backref">The exact determination here is up to user agents for the
  time being. User agents are strongly encouraged to only succeed HTTPS connections with
  strong security properties and return
  <span title=concept-network-error>network errors</span> otherwise. Using the
  "<code title>deprecated</code>" state value ought to be a temporary and last resort kind
  of option.

  <p><span title="Read a request">Read <var>request</var></span>.

 <li>
  <p>Let <var>strategy</var> be an object. The user agent may choose any object.

  <p class="note no-backref"><var>strategy</var> is used to control the queuing strategy of
  <var>stream</var> constructed below.

 <li><p>Let <var>pull</var> be an action that <span title=concept-fetch-resume>resumes</span> the
 ongoing fetch if it is <span title=concept-fetch-suspend>suspended</span>.

 <li><p>Let <var>cancel</var> be an action that
 <span title=concept-fetch-terminate>terminates</span> the ongoing fetch with reason
 <i title>end-user abort</i>.

 <li>
  <p>Let <var>stream</var> be the result of
  <span title=concept-construct-ReadableStream>constructing</span> a
  <code title=concept-ReadableStream>ReadableStream</code> object with <var>strategy</var>,
  <var>pull</var> and <var>cancel</var>.
  <p class="note no-backref">This construction operation will not throw an exception.

 <li><p>Set <var>response</var>'s <span title=concept-response-body>body</span> to a new
 <span title=concept-body>body</span> whose <span title=concept-body-stream>stream</span> is
 <var>stream</var>.

 <li><p>If <var>response</var> has a payload body length, then set <var>response</var>'s
 <span title=concept-response-body>body</span>'s
 <span title=concept-body-total-bytes>total bytes</span> to that payload body length.
 <!-- XXX xref payload body -->

 <li>
  <p><span title=concept-header-list-delete>Delete</span>
  `<code title>Content-Encoding</code>` from <var>response</var>'s
  <span title=concept-response-header-list>header list</span> if one of the following
  conditions is true:

  <ul class=brief>
   <li><span title=concept-header-parse>Parsing</span>
   `<code title>Content-Encoding</code>` in <var>response</var>'s
   <span title=concept-response-header-list>header list</span> returns
   `<code title>gzip</code>` and <span title=concept-header-parse>parsing</span>
   `<code title>Content-Type</code>` in <var>response</var>'s
   <span title=concept-response-header-list>header list</span> returns
   `<code title>application/gzip</code>`, `<code title>application/x-gunzip</code>`, or
   `<code title>application/x-gzip</code>`.
   <li><span title=concept-header-parse>Parsing</span>
   `<code title>Content-Encoding</code>` in <var>response</var>'s
   <span title=concept-response-header-list>header list</span> returns
   `<code title>compress</code>` and <span title=concept-header-parse>parsing</span>
   `<code title>Content-Type</code>` in <var>response</var>'s
   <span title=concept-response-header-list>header list</span> returns
   `<code title>application/compress</code>` or
   `<code title>application/x-compress</code>.
  </ul>

  <p class=note>This deals with broken Apache configurations. Ideally HTTP would define
  this.
  <!-- https://wiki.whatwg.org/wiki/HTTP -->

  <p class=XXX>Gecko
  <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1030660">bug 1030660</a> looks
  into whether this quirk can be removed.

 <li><p>Execute
 <a href=https://w3c.github.io/webappsec-csp/#set-response-csp-list>set <var>response</var>'s CSP list</a>
 on <var>response</var>. <span data-anolis-ref>CSP</span>

 <li><p>If <var>response</var> is not a
 <span title=concept-network-error>network error</span> and <var>request</var>'s
 <span title=concept-request-cache-mode>cache mode</span> is not "<code title>no-store</code>",
 update <var>response</var> in the HTTP cache for <var>request</var>.
 <!-- XXX xref HTTP cache -->

 <li>
  <p>If <i>credentials flag</i> is set and the user agent is not configured to block cookies for
  <var>request</var> (see <a href="https://tools.ietf.org/html/rfc6265#section-7">section 7</a> of
  <span data-anolis-ref>COOKIES</span>), then run the "set-cookie-string" parsing algorithm (see
  <a href="https://tools.ietf.org/html/rfc6265#section-5.2">section 5.2</a> of
  <span data-anolis-ref>COOKIES</span>) on the <span title=concept-header-value>value</span>
  of each <var>header</var> <span title=concept-header-name>named</span> `<code title>Set-Cookie</code>`
  in <var>response</var>'s <span title=concept-response-header-list>header list</span>, if any, and
  <var>request</var>'s <span title=concept-response-current-url>current url</span>.

  <p class=note>This is a fingerprinting vector.

 <li>
  <p>Run these substeps <span data-anolis-spec=html>in parallel</span>:

  <ol>
   <li>
    <p>Whenever one or more bytes are transmitted from <var>response</var>'s message body, let
    <var>bytes</var> be the transmitted bytes and run these subsubsteps:
    <!-- XXX xref message body -->

    <ol>
     <li><p>Increase <var>response</var>'s
     <span title=concept-response-body>body</span>'s
     <span title=concept-body-transmitted>transmitted bytes</span> with <var>bytes</var>'
     length.

     <li><p>Let <var>codings</var> be the result of
     <span title=concept-header-parse>parsing</span> `<code title>Content-Encoding</code>`
     in <var>response</var>'s
     <span title=concept-response-header-list>header list</span>.

     <li>
      <p>Set <var>bytes</var> to the result of <span title="handle content codings">handling
      content codings</span> given <var>codings</var> and <var>bytes</var>.

      <p class="note no-backref">This makes the `<code title>Content-Length</code>`
      <span title=concept-header>header</span> unreliable to the extent that it was reliable
      to begin with.

     <li>
      <p><span title=concept-enqueue-ReadableStream>Enqueue</span> a <code>Uint8Array</code>
      object wrapping an <code>ArrayBuffer</code> containing <var>bytes</var> to <var>stream</var>.
      If that threw an exception, <span title=concept-fetch-terminate>terminate</span> the ongoing
      fetch with <i>fatal</i>, <span title=concept-error-ReadableStream>error</span>
      <var>stream</var> with that exception and abort these subsubsteps.

     <li><p>If <var>stream</var> doesn't <span title=concept-ReadableStream-need-more-data>need more
     data</span> and <var>request</var>'s <span>synchronous flag</span> is unset, ask the user agent
     to <span title=concept-fetch-suspend>suspend</span> the ongoing fetch.
    </ol>

   <li><p>If at any point the bytes transmission for <var>response</var>'s message body is done
   normally and <var>stream</var> is <span title=concept-ReadableStream-readable>readable</span>,
   then <span title=concept-close-ReadableStream>close</span> <var>stream</var>.
   <!-- XXX xref message body -->

   <li>
    <p>If at any point <span title=concept-fetch>fetch</span> is
    <span title=concept-fetch-terminate>terminated</span> with reason <var>reason</var>,
    run these subsubsteps:

    <ol>
     <li><p>Set <var>response</var>'s <span title=concept-response-termination-reason>termination
     reason</span> to <var>reason</var>.

     <li><p>If <var>stream</var> is <span title=concept-ReadableStream-readable>readable</span>,
     <span title=concept-error-ReadableStream>error</span> <var>stream</var> with a
     <code>TypeError</code>.
    </ol>
  </ol>

  <p class="note no-backref">These are run <span data-anolis-spec=html>in parallel</span>
  as at this point it is unclear whether <var>response</var>'s
  <span title=concept-response-body>body</span> is relevant (<var>response</var>
  might be a redirect).

 <li><p>Return <var>response</var>. <span class="note no-backref">Typically
 <var>response</var>'s <span title=concept-response-body>body</span>'s
 <span title=concept-body-stream>stream</span> is still being enqueued to after returning.</span>
</ol>


<h3 id=cors-preflight-fetch>CORS-preflight fetch</h3>

<p class="note no-backref">This is effectively the user agent implementation of the check to see if
the <span>CORS protocol</span> is understood. The so-called <span>CORS-preflight request</span>. If
successful it populates the <span title=concept-cache>CORS-preflight cache</span> to minimize the
number of these <span title="CORS-preflight fetch">fetches</span>.

<p>To perform a <dfn>CORS-preflight fetch</dfn> using <var>request</var>, run these
steps:

<ol>
 <li><p>Let <var>preflight</var> be a new <span title=concept-request>request</span>
 whose <span title=concept-request-method>method</span> is `<code title>OPTIONS</code>`,
 <span title=concept-request-url>url</span> is <var>request</var>'s
 <span title=concept-request-current-url>current url</span>,
 <span title=concept-request-initiator>initiator</span> is <var>request</var>'s
 <span title=concept-request-initiator>initiator</span>,
 <span title=concept-request-type>type</span> is <var>request</var>'s
 <span title=concept-request-type>type</span>,
 <span title=concept-request-destination>destination</span> is <var>request</var>'s
 <span title=concept-request-destination>destination</span>,
 <span title=concept-request-origin>origin</span> is <var>request</var>'s
 <span title=concept-request-origin>origin</span>,
 <span title=concept-request-referrer>referrer</span> is <var>request</var>'s
 <span title=concept-request-referrer>referrer</span>, and
 <span title=concept-request-referrer-policy>referrer policy</span> is
 <var>request</var>'s
 <span title=concept-request-referrer-policy>referrer policy</span>.

 <li><p><span title=concept-header-list-set>Set</span>
 `<code title=http-access-control-request-method>Access-Control-Request-Method</code>` to
 <var>request</var>'s <span title=concept-request-method>method</span> in
 <var>preflight</var>'s <span title=concept-request-header-list>header list</span>.

 <li><p>Let <var>headers</var> be the <span title=concept-header-name>names</span> of
 <var>request</var>'s <span title=concept-request-header-list>header list</span>'s
 <span title=concept-header>headers</span>, excluding
 <span title="cors-safelisted request-header">CORS-safelisted request-headers</span> and duplicates,
 sorted lexicographically, and <span title="byte-lowercase">byte-lowercased</span>.

 <li><p>Let <var>value</var> be the items in <var>headers</var> separated from each other by 0x2C.

 <li><p><span title=concept-header-list-set>Set</span>
 `<code title=http-access-control-request-headers>Access-Control-Request-Headers</code>`
 to <var>value</var> in
 <var>preflight</var>'s <span title=concept-request-header-list>header list</span>.

 <li><p>Let <var>response</var> be the result of performing an
 <span title=concept-http-network-or-cache-fetch>HTTP-network-or-cache fetch</span> using
 <var>preflight</var>.

 <li>
  <p>If a <span title=concept-cors-check>CORS check</span> for <var>request</var>
  and <var>response</var> returns success and <var>response</var>'s
  <span title=concept-response-status>status</span> is an <span>ok status</span>, run these
  substeps:
  <!-- CORS said 200 here but nobody implemented that:
       https://lists.w3.org/Archives/Public/public-webappsec/2013Feb/0078.html -->

  <p class="note no-backref">The <span title=concept-cors-check>CORS check</span> is done
  on <var>request</var> rather than <var>preflight</var> to ensure the correct
  <span title=concept-request-credentials-mode>credentials mode</span> is used.

  <ol>
   <li><p>Let <var>methods</var> be the result of
   <span title=concept-header-parse>parsing</span>
   `<code title=http-access-control-allow-methods>Access-Control-Allow-Methods</code>` in
   <var>response</var>'s
   <span title=concept-response-header-list>header list</span>.

   <li><p>If <var>methods</var> is `<code>*</code>`, then set <var>methods</var> to a new list
   containing `<code>*</code>`.

   <li><p>Let <var>headerNames</var> be the result of
   <span title=concept-header-parse>parsing</span>
   `<code title=http-access-control-allow-headers>Access-Control-Allow-Headers</code>` in
   <var>response</var>'s
   <span title=concept-response-header-list>header list</span>.

   <li><p>If either <var>methods</var> or <var>headerNames</var> is failure,
   return a <span title=concept-network-error>network error</span>.

   <li><p>If <var>methods</var> or <var>headerNames</var> contains `<code>*</code>`, and
   <var>request</var>'s <span title=concept-request-credentials-mode>credentials mode</span> is
   "<code>include</code>", then return a <span title=concept-network-error>network error</span>.

   <li>
    <p>If <var>methods</var> is null and <var>request</var>'s <span>use-CORS-preflight flag</span>
    is set, then set <var>methods</var> to a new list containing <var>request</var>'s
    <span title=concept-request-method>method</span>.

    <p class="note no-backref">This ensures that a <span>CORS-preflight fetch</span> that
    happened due to <var>request</var>'s <span>use-CORS-preflight flag</span> being set is
    <span title=concept-cache>cached</span>.

   <li><p>If <var>request</var>'s <span title=concept-request-method>method</span> is not in
   <var>methods</var>, is not a <span>CORS-safelisted method</span>, and <var>methods</var> does
   <em>not</em> contain `<code>*</code>`, then return a
   <span title=concept-network-error>network error</span>.

   <li><p>If one of <var>request</var>'s
   <span title=concept-request-header-list>header list</span>'s
   <span title=concept-header-name>names</span> is a
   <span>CORS non-wildcard request-header name</span> and is not in <var>headerNames</var>, then
   return a <span title=concept-network-error>network error</span>.

   <li><p>If one of <var>request</var>'s
   <span title=concept-request-header-list>header list</span>'
   <span title=concept-header-name>names</span> is not in <var>headerNames</var>, its corresponding
   <span title=concept-header>header</span> is not a <span>CORS-safelisted request-header</span>,
   and <var>headerNames</var> does <em>not</em> contain `<code>*</code>`, then return a
   <span title=concept-network-error>network error</span>.

   <li><p>Let <var>max-age</var> be the result of
   <span title=concept-header-parse>parsing</span>
   `<code title=http-access-control-max-age>Access-Control-Max-Age</code>` in
   <var>response</var>'s
   <span title=concept-response-header-list>header list</span>.

   <li><p>If <var>max-age</var> is failure or null, then set <var>max-age</var> to zero.

   <li><p>If <var>max-age</var> is greater than an imposed limit on
   <span title=concept-cache-max-age>max-age</span>, then set <var>max-age</var> to the imposed
   limit.

   <li><p>If the user agent does not provide for a <span title=concept-cache>cache</span>, then
   return <var>response</var>.

   <li><p>For each <var>method</var> in <var>methods</var> for which there is
   a <span title=concept-cache-match-method>method cache match</span> using
   <var>request</var>, set matching entry's
   <span title=concept-cache-max-age>max-age</span> to <var>max-age</var>.

   <li><p>For each <var>method</var> in <var>methods</var> for which there is <em>no</em>
   <span title=concept-cache-match-method>method cache match</span> using <var>request</var>,
   <span title=concept-cache-create-entry>create a new entry</span> with <var>request</var>,
   <var>max-age</var>, <var>method</var>, and null.

   <li><p>For each <var>headerName</var> in <var>headerNames</var> for which
   there is a <span title=concept-cache-match-header>header-name cache match</span> using
   <var>request</var>, set matching entry's
   <span title=concept-cache-max-age>max-age</span> to <var>max-age</var>.

   <li><p>For each <var>headerName</var> in <var>headerNames</var> for which there is <em>no</em>
   <span title=concept-cache-match-header>header-name cache match</span> using <var>request</var>,
   <span title=concept-cache-create-entry>create a new entry</span> with <var>request</var>,
   <var>max-age</var>, null, and <var>headerName</var>.

   <li><p>Return <var>response</var>.
  </ol>

 <li><p>Otherwise, return a <span title=concept-network-error>network error</span>.
</ol>

<h3 id=cors-preflight-cache>CORS-preflight cache</h3>

<p>A <dfn title=concept-cache>CORS-preflight cache</dfn> consists of a collection of
entries where each entry has these fields:

<ul class=brief>
 <li><dfn title=concept-cache-origin>origin</dfn> (an <span data-anolis-spec=html>origin</span>)
 <li><dfn title=concept-cache-url>url</dfn> (a
 <span data-anolis-spec=url title=concept-url>URL</span>)
 <li><dfn title=concept-cache-max-age>max-age</dfn> (a number of seconds)
 <li><dfn title=concept-cache-credentials>credentials</dfn> (a boolean)
 <li><dfn title=concept-cache-method>method</dfn> (null, `<code>*</code>`, or a
 <span title=concept-method>method</span>)
 <li><dfn title=concept-cache-header-name>header name</dfn> (null, `<code>*</code>`, or a
 <span title=concept-header>header</span> <span title=concept-header-name>name</span>)
</ul>

<p>Entries must be removed after the seconds specified in the
<span title=concept-cache-max-age>max-age</span> field have passed since storing the entry.
Entries may be removed before that moment arrives.

<p>To <dfn title=concept-cache-create-entry>create a new entry</dfn> in the
<span title=concept-cache>CORS-preflight cache</span>, given <var>request</var>, <var>max-age</var>,
<var>method</var>, and <var>headerName</var>, do so as follows:

<dl>
 <dt><span title=concept-cache-origin>origin</span>
 <dd><var>request</var>'s <span title=concept-request-origin>origin</span>

 <dt><span title=concept-cache-url>url</span>
 <dd><var>request</var>'s <span title=concept-request-current-url>current url</span>

 <dt><span title=concept-cache-max-age>max-age</span>
 <dd><var>max-age</var>

 <dt><span title=concept-cache-credentials>credentials</span>
 <dd>True if <var>request</var>'s
 <span title=concept-request-credentials-mode>credentials mode</span> is
 "<code title>include</code>", and false otherwise

 <dt><span title=concept-cache-method>method</span></dt>
 <dd><var>method</var>

 <dt><span title=concept-cache-header-name>header name</span></dt>
 <dd><var>headerName</var>
</dl>

<p>To <dfn title=concept-cache-clear>clear cache entries</dfn>, given a
<var>request</var>, remove any entries in the
<span title=concept-cache>CORS-preflight cache</span> whose
<span title=concept-cache-origin>origin</span> is <var>request</var>'s
<span title=concept-request-origin>origin</span> and whose
<span title=concept-cache-url>url</span> is <var>request</var>'s
<span title=concept-request-current-url>current url</span>.

<p>There is a <dfn title=concept-cache-match>cache match</dfn> for
<var>request</var> if <span title=concept-cache-origin>origin</span> is
<var>request</var>'s <span title=concept-request-origin>origin</span>,
<span title=concept-cache-url>url</span> is <var>request</var>'s
<span title=concept-request-current-url>current url</span>, and one of

<ul class=brief>
 <li><span title=concept-cache-credentials>credentials</span> is true
 <li><span title=concept-cache-credentials>credentials</span> is false and <var>request</var>'s
 <span title=concept-request-credentials-mode>credentials mode</span> is <em>not</em>
 "<code title>include</code>"
</ul>

<p>is true.

<p>There is a <dfn title=concept-cache-match-method>method cache match</dfn> for
<var>method</var> using <var>request</var> when there is an entry in
<span title=concept-cache>CORS-preflight cache</span> for which there is a
<span title=concept-cache-match>cache match</span> for <var>request</var> and its
<span title=concept-cache-method>method</span> is <var>method</var> or `<code>*</code>`.

<p>There is a <dfn title=concept-cache-match-header>header-name cache match</dfn> for
<var>headerName</var> using <var>request</var> when there is an entry in
<span title=concept-cache>CORS-preflight cache</span> for which there is a
<span title=concept-cache-match>cache match</span> for <var>request</var> and one of

<ul class=brief>
 <li><span title=concept-cache-header-name>header name</span> is <var>headerName</var>
 <li><span title=concept-cache-header-name>header name</span> is `<code>*</code>` and
 <var>headerName</var> is <em>not</em> a <span>CORS non-wildcard request-header name</span>
</ul>

<p>is true.


<h3 id=cors-check>CORS check</h3>

<p>To perform a <dfn title=concept-cors-check>CORS check</dfn> for a
<var>request</var> and <var>response</var>, run these steps:

<ol>
 <li><p>Let <var>origin</var> be the result of
 <span title=concept-header-parse>parsing</span>
 `<code title=http-access-control-allow-origin>Access-Control-Allow-Origin</code>` in
 <var>response</var>'s <span title=concept-response-header-list>header list</span>.

 <li>
  <p>If <var>origin</var> is null or failure, return failure.

  <p class=note>Null is not `<code title>null</code>`.

 <li><p>If <var>request</var>'s
 <span title=concept-request-credentials-mode>credentials mode</span> is not
 "<code title>include</code>" and <var>origin</var> is `<code title>*</code>`, return success.

 <li><p>If <var>request</var>'s <span title=concept-request-origin>origin</span>,
 <span data-anolis-spec=html title="ASCII serialization of an origin">serialized</span>
 and <span data-anolis-spec=encoding title="utf-8 encode">utf-8 encoded</span>, is not
 <var>origin</var>, return failure.
 <!-- XXX concept-as-bytes -->

 <li><p>If <var>request</var>'s
 <span title=concept-request-credentials-mode>credentials mode</span> is not
 "<code title>include</code>", return success.

 <li><p>Let <var>credentials</var> be the result of
 <span title=concept-header-parse>parsing</span>
 `<code title=http-access-control-allow-credentials>Access-Control-Allow-Credentials</code>`
 in <var>response</var>'s
 <span title=concept-response-header-list>header list</span>.

 <li>
  <p>If <var>credentials</var> is `<code title>true</code>`, return success.

  <p class=XXX>It has been suggested to check for <var>origin</var> not being
  `<code title>null</code>` here as that would be equal to allowing credentials and
  `<code title>*</code>` which is also forbidden.

 <li><p>Return failure.
</ol>



<h2 id=fetch-api>Fetch API</h2>

<p class=no-backref>The <code title=dom-global-fetch>fetch()</code> method is relatively
low-level API for <span title=concept-fetch>fetching</span> resources. It covers slightly
more ground than <code data-anolis-spec=xhr>XMLHttpRequest</code>, although it is
currently lacking when it comes to request progression (not response progression).

<div id=fetch-blob-example class="example no-backref">
 <p>The <code title=dom-global-fetch>fetch()</code> method makes it quite straightforward
 to <span title=concept-fetch>fetch</span> a resource and extract its contents as a
 <code data-anolis-spec=fileapi>Blob</code>:

 <pre>fetch("/music/pk/altes-kamuffel.flac")
  .then(res => res.blob()).then(playBlob)</pre>

 <p>If you just care to log a particular response header:

 <pre>fetch("/", {method:"HEAD"})
  .then(res => log(res.headers.get("strict-transport-security")))</pre>

 <p>If you want to check a particular response header and then process the response of a
 cross-origin resources:

 <pre>fetch("https://pk.example/berlin-calling.json", {mode:"cors"})
  .then(res => {
    if(res.headers.get("content-type") &amp;&amp;
       res.headers.get("content-type").toLowerCase().indexOf("application/json") >= 0) {
      return res.json()
    } else {
      throw new TypeError()
    }
  }).then(processJSON)</pre>

 <p>If you want to work with URL query parameters:

 <pre>var url = new URL("https://geo.example.org/api"),
    params = {lat:35.696233, long:139.570431}
Object.keys(params).forEach(key => url.searchParams.append(key, params[key]))
fetch(url).then(/* &hellip; */)</pre>

 <p>If you want to receive the body data progressively:

 <pre>function consume(reader) {
  var total = 0
  return pump()
  function pump() {
    return reader.read().then(({done, value}) => {
      if (done) {
        return
      }
      total += value.byteLength
      log(`received ${value.byteLength} bytes (${total} bytes in total)`)
      return pump()
    })
  }
}

fetch("/music/pk/altes-kamuffel.flac")
  .then(res => consume(res.body.getReader()))
  .then(() => log("consumed the entire body without keeping the whole thing in memory!"))
  .catch(e => log("something went wrong: " + e))</pre>
</div>


<h3 id=headers-class>Headers class</h3>

<pre class=idl>typedef (<span>Headers</span> or sequence&lt;sequence&lt;ByteString>> or OpenEndedDictionary&lt;ByteString>) <dfn>HeadersInit</dfn>;</pre>

<div class=XXX>
 <p>OpenEndedDictionary&lt;T> is a future IDL construct. Expect it to be used as such:

 <pre>var meta = { "Content-Type": "text/xml", "Breaking-Bad": "&lt;3" }
new Headers(meta)</pre>

 <p>See <a href=https://github.com/whatwg/fetch/issues/164>issue #164</a> for discussion.
</div>

<pre class=idl>[<span title=dom-Headers>Constructor</span>(optional <span>HeadersInit</span> <var>init</var>),
 Exposed=(Window,Worker)]
interface <dfn data-export data-dfn-type=interface>Headers</dfn> {
  void <span title=dom-Headers-append>append</span>(ByteString <var>name</var>, ByteString <var>value</var>);
  void <span title=dom-Headers-delete>delete</span>(ByteString <var>name</var>);
  ByteString? <span title=dom-Headers-get>get</span>(ByteString <var>name</var>);
  boolean <span title=dom-Headers-has>has</span>(ByteString <var>name</var>);
  void <span title=dom-Headers-set>set</span>(ByteString <var>name</var>, ByteString <var>value</var>);
  iterable&lt;ByteString, ByteString>;
};</pre>

<p>A <code>Headers</code> object has an associated
<dfn title=concept-Headers-header-list data-export data-dfn-for=Headers>header list</dfn> (a
<span title=concept-header-list>header list</span>), which is initially empty. <span class=note>This
can be a pointer to the <span title=concept-header-list>header list</span> of something else, e.g.,
of a <span title=concept-request>request</span> as demonstrated by <code>Request</code>
objects.</span>

<p>A <code>Headers</code> object also has an associated
<dfn title=concept-Headers-guard data-export data-dfn-for=Headers>guard</dfn>, which is
"<code title>immutable</code>",
"<code title>request</code>",
"<code title>request-no-cors</code>",
"<code title>response</code>" or
"<code title>none</code>".

<p class="note no-backref">"<code title>immutable</code>" exists for service workers.
<span data-anolis-ref>SW</span>

<p>To <dfn title=concept-Headers-append data-export data-dfn-for=Headers>append</dfn> a
<span title=concept-header-name>name</span>/<span title=concept-header-value>value</span>
(<var>name</var>/<var>value</var>) pair to a
<code>Headers</code> object (<var>headers</var>), run these steps:

<ol>
 <li><p><span title=concept-header-value-normalize>Normalize</span>
 <var>value</var>.

 <li><p>If <var>name</var> is not a <span title=concept-header-name>name</span> or
 <var>value</var> is not a <span title=concept-header-value>value</span>,
 <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

 <li><p>If <span title=concept-Headers-guard>guard</span> is "<code title>immutable</code>",
 <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

 <li><p>Otherwise, if <span title=concept-Headers-guard>guard</span> is
 "<code title>request</code>" and <var>name</var> is a <span>forbidden header name</span>,
 return.

 <li><p>Otherwise, if <span title=concept-Headers-guard>guard</span> is
 "<code title>request-no-cors</code>" and <var>name</var>/<var>value</var> is not a
 <span>CORS-safelisted request-header</span>, return.

 <li><p>Otherwise, if <span title=concept-Headers-guard>guard</span> is
 "<code title>response</code>" and <var>name</var> is a
 <span>forbidden response-header name</span>, return.

 <li><p><span title=concept-header-list-append>Append</span>
 <var>name</var>/<var>value</var> to
 <span title=concept-Headers-header-list>header list</span>.
</ol>

<p>To <dfn title=concept-Headers-fill data-export data-dfn-for=Headers>fill</dfn> a
<code>Headers</code> object (<var>headers</var>) with a given object (<var>object</var>),
run these steps:

<ol>
 <li>
  <p>If <var>object</var> is a <code>Headers</code> object, then for each <var>header</var> in its
  <span title=concept-Headers-header-list>header list</span>, retaining order,
  <span title=concept-Headers-append>append</span>
  <var>header</var>'s <span title=concept-header-name>name</span>/<var>header</var>'s <span title=concept-header-value>value</span>
  to <var>headers</var>. Rethrow any exception.

  <p class=note>Once <code title>Headers.prototype[Symbol.iterator]</code> is defined this
  special casing will no longer be needed.

 <li>
  <p>Otherwise, if <var>object</var> is a sequence, then for each
  <var>header</var> in <var>object</var>, run these substeps:

  <ol>
   <li><p>If <var>header</var> does not contain exactly two items,
   <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

   <li><p><span title=concept-Headers-append>Append</span>
   <var>header</var>'s first item/<var>header</var>'s second item to
   <var>headers</var>. Rethrow any exception.
  </ol>

 <li>
  <p>Otherwise, if <var>object</var> is an open-ended dictionary, then for each
  <var>header</var> in <var>object</var>, run these substeps:

  <ol>
   <li><p>Set <var>header</var>'s key to <var>header</var>'s key,
   <span data-anolis-spec=webidl title=es-ByteString>converted to ByteString</span>.
   Rethrow any exception.

   <li><p><span title=concept-Headers-append>Append</span>
   <var>header</var>'s key/<var>header</var>'s value to
   <var>headers</var>. Rethrow any exception.
  </ol>
</ol>

<p>The
<dfn title=dom-Headers data-export data-dfn-for=Headers data-dfn-type=constructor><code>Headers(<var>init</var>)</code></dfn>
constructor, when invoked, must run these steps:

<ol>
 <li><p>Let <var>headers</var> be a new <code>Headers</code> object whose
 <span title=concept-Headers-guard>guard</span> is "<code title>none</code>".

 <li><p>If <var>init</var> is given, <span title=concept-Headers-fill>fill</span>
 <var>headers</var> with <var>init</var>. Rethrow any exception.

 <li><p>Return <var>headers</var>.
</ol>

<p>The
<dfn title=dom-Headers-append data-export data-dfn-for=Headers data-dfn-type=method><code>append(<var>name</var>, <var>value</var>)</code></dfn>
method, when invoked, must <span title=concept-Headers-append>append</span>
<var>name</var>/<var>value</var> to the
<span data-anolis-spec=dom>context object</span> and rethrow any exception.

<p>The <dfn title=dom-Headers-delete data-export data-dfn-for=Headers data-dfn-type=method><code>delete(<var>name</var>)</code></dfn>
method, when invoked, must run these steps:

<ol>
 <li><p>If <var>name</var> is not a <span title=concept-header-name>name</span>,
 <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

 <li><p>If <span title=concept-Headers-guard>guard</span> is "<code title>immutable</code>",
 <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

 <li><p>Otherwise, if <span title=concept-Headers-guard>guard</span> is
 "<code title>request</code>" and <var>name</var> is a <span>forbidden header name</span>,
 return.

 <li>
  <p>Otherwise, if <span title=concept-Headers-guard>guard</span> is "<code>request-no-cors</code>"
  and <var>name</var>/`<code>invalid</code>` is not a <span>CORS-safelisted request-header</span>,
  then return.

  <p class=note>`<code>invalid</code>` is used because
  <code title=dom-Headers-delete>delete()</code> is not passed a value as argument.

 <li><p>Otherwise, if <span title=concept-Headers-guard>guard</span> is
 "<code title>response</code>" and <var>name</var> is a
 <span>forbidden response-header name</span>, return.

 <li><p><span title=concept-header-list-delete>Delete</span> <var>name</var> from
 <span title=concept-Headers-header-list>header list</span>.
</ol>

<p>The <dfn title=dom-Headers-get data-export data-dfn-for=Headers data-dfn-type=method><code>get(<var>name</var>)</code></dfn> method, when
invoked, must run these steps:

<ol>
 <li><p>If <var>name</var> is not a <span title=concept-header-name>name</span>,
 <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

 <li><p>If there is <em>no</em> <span title=concept-header>header</span> in
 <span title=concept-Headers-header-list>header list</span> whose
 <span title=concept-header-name>name</span> is <var>name</var>, return null.

 <li><p>Return the <span title=concept-header-value-combined>combined value</span> given
 <var>name</var> and <span title=concept-Headers-header-list>header list</span>.
</ol>

<p>The <dfn title=dom-Headers-has data-export data-dfn-for=Headers data-dfn-type=method><code>has(<var>name</var>)</code></dfn> method,
when invoked, must run these steps:

<ol>
 <li><p>If <var>name</var> is not a <span title=concept-header-name>name</span>,
 <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

 <li><p>Return true if there is a <span title=concept-header>header</span> in
 <span title=concept-Headers-header-list>header list</span> whose
 <span title=concept-header-name>name</span> is <var>name</var>, and false
 otherwise.
</ol>

<p>The
<dfn title=dom-Headers-set data-export data-dfn-for=Headers data-dfn-type=method><code>set(<var>name</var>, <var>value</var>)</code></dfn>
method, when invoked, must run these steps:

<ol>
 <li><p><span title=concept-header-value-normalize>Normalize</span>
 <var>value</var>.

 <li><p>If <var>name</var> is not a <span title=concept-header-name>name</span> or
 <var>value</var> is not a <span title=concept-header-value>value</span>,
 <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

 <li><p>If <span title=concept-Headers-guard>guard</span> is "<code title>immutable</code>",
 <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

 <li><p>Otherwise, if <span title=concept-Headers-guard>guard</span> is
 "<code title>request</code>" and <var>name</var> is a <span>forbidden header name</span>,
 return.

 <li><p>Otherwise, if <span title=concept-Headers-guard>guard</span> is
 "<code title>request-no-cors</code>" and <var>name</var>/<var>value</var> is not a
 <span>CORS-safelisted request-header</span>, return.

 <li><p>Otherwise, if <span title=concept-Headers-guard>guard</span> is
 "<code title>response</code>" and <var>name</var> is a
 <span>forbidden response-header name</span>, return.

 <li><p><span title=concept-header-list-set>Set</span>
 <var>name</var>/<var>value</var> in
 <span title=concept-Headers-header-list>header list</span>.
</ol>

<p>The <span data-anolis-spec=webidl>value pairs to iterate over</span> are the return value of
running <span title=concept-header-list-sort-and-combine>sort and combine</span> with the
<span title=concept-Headers-header-list>header list</span>.


<h3 id=body-mixin>Body mixin</h3>

<pre class=idl>typedef (<span data-anolis-spec=fileapi>Blob</span> or BufferSource or <span data-anolis-spec=xhr>FormData</span> or <span data-anolis-spec=url>URLSearchParams</span> or USVString) <dfn>BodyInit</dfn>;
typedef (<span>BodyInit</span> or <span title=concept-ReadableStream>ReadableStream</span>) <dfn>ResponseBodyInit</dfn>;</pre>

<p>To <dfn title=concept-BodyInit-extract>extract</dfn> a <span title=concept-body>body</span> and a
`<code title>Content-Type</code>` <span title=concept-header-value>value</span> from
<var>object</var>, with an optional <var>keepalive flag</var>, run these steps:

<ol>
 <li><p>Let <var>stream</var> be the result of
 <span title=concept-construct-ReadableStream>constructing</span> a
 <code title=concept-ReadableStream>ReadableStream</code> object.

 <li><p>Let <var>Content-Type</var> be null.

 <li><p>Let <var>action</var> be null.

 <li>
  <p>Switch on <var>object</var>'s type:

  <dl class=switch>
   <dt><code data-anolis-spec=fileapi>Blob</code>
   <dd>
    <p>Set <var>action</var> to an action that reads <var>object</var>.

    <p>If <var>object</var>'s <code data-anolis-spec=fileapi title=dom-Blob-type>type</code>
    attribute is not the empty byte sequence, set <var>Content-Type</var> to its value.

   <dt><code title>BufferSource</code>
   <dd>
    <p><span title=concept-enqueue-ReadableStream>Enqueue</span> a <code>Uint8Array</code> object
    wrapping an <code>ArrayBuffer</code> containing a copy of the bytes held by <var>object</var>
    to <var>stream</var> and <span title=concept-close-ReadableStream>close</span>
    <var>stream</var>. If that threw an exception,
    <span title=concept-error-ReadableStream>error</span> <var>stream</var> with that exception.

   <dt><code data-anolis-spec=xhr>FormData</code>
   <dd>
    <p>Set <var>action</var> to an action that runs the
    <span data-anolis-spec=html><code>multipart/form-data</code> encoding algorithm</span>,
    with <var>object</var> as <var>form data set</var> and with
    <span data-anolis-spec=encoding>utf-8</span> as the explicit character encoding.
    <!-- need to provide explicit character encoding because otherwise the encoding of the
         document is used -->

    <p>Set <var>Content-Type</var> to `<code title>multipart/form-data;boundary=</code>`,
    followed by the
    <span data-anolis-spec=html><code>multipart/form-data</code> boundary string</span>
    generated by the
    <span data-anolis-spec=html><code>multipart/form-data</code> encoding algorithm</span>.

   <dt><code data-anolis-spec=url>URLSearchParams</code>
   <dd>
    <p>Set <var>action</var> to an action that runs the
    <span data-anolis-spec=url title=concept-urlencoded-serializer><code>application/x-www-form-urlencoded</code>
    serializer</span> with <var>object</var>'s
    <span data-anolis-spec=url title=concept-URLSearchParams-list>list</span>.
    <!-- utf-8 implied -->

    <p>Set <var>Content-Type</var> to
    `<code title>application/x-www-form-urlencoded;charset=UTF-8</code>`.

   <dt><code title>USVString</code>
   <dd>
    <p>Set <var>action</var> to an action that runs
    <span data-anolis-spec=encoding>utf-8 encode</span> on <var>object</var>.

    <p>Set <var>Content-Type</var> to `<code title>text/plain;charset=UTF-8</code>`.

   <dt><code title=concept-ReadableStream>ReadableStream</code>
   <dd><p>Set <var>stream</var> to <var>object</var>.
  </dl>

 <li><p>If <var>keepalive flag</var> is set and <var>object</var>'s type is a
 <code title=concept-ReadableStream>ReadableStream</code> object, then throw a
 <code title>TypeError</code>.

 <li>
  <p>If <var>action</var> is non-null, run <var>action</var>
  <span data-anolis-spec=html>in parallel</span>:

  <ol>
   <li><p>Whenever one or more bytes are available, let <var>bytes</var> be the bytes and
   <span title=concept-enqueue-ReadableStream>enqueue</span> a <code>Uint8Array</code> object
   wrapping an <code>ArrayBuffer</code> containing <var>bytes</var> to <var>stream</var>. If
   creating the <code>ArrayBuffer</code> threw an exception,
   <span title=concept-error-ReadableStream>error</span> <var>stream</var> with that exception
   and cancel running <var>action</var>.

   <li><p>When running <var>action</var> is done,
   <span title=concept-close-ReadableStream>close</span> <var>stream</var>.
  </ol>

 <li><p>Let <var>body</var> be a <span title=concept-body>body</span> whose
 <span title=concept-body-stream>stream</span> is <var>stream</var>.

 <li><p>Return <var>body</var> and <var>Content-Type</var>.
</ol>


<pre class=idl>[NoInterfaceObject,
 Exposed=(Window,Worker)]
interface <dfn>Body</dfn> {
  readonly attribute boolean <span title=dom-Body-bodyUsed>bodyUsed</span>;
  [NewObject] Promise&lt;ArrayBuffer> <span title=dom-Body-arrayBuffer>arrayBuffer</span>();
  [NewObject] Promise&lt;<span data-anolis-spec=fileapi>Blob</span>> <span title=dom-Body-blob>blob</span>();
  [NewObject] Promise&lt;<span data-anolis-spec=xhr>FormData</span>> <span title=dom-Body-formData>formData</span>();
  [NewObject] Promise&lt;any> <span title=dom-Body-json>json</span>();
  [NewObject] Promise&lt;USVString> <span title=dom-Body-text>text</span>();
};</pre>

<p class=note>Formats you would not want a network layer to be dependent upon, such as
HTML, will likely not be exposed here. Rather, an HTML parser API might accept a stream in
due course.
<!-- https://lists.w3.org/Archives/Public/public-whatwg-archive/2014Jun/thread.html#msg72 -->

<p>Objects implementing the <code>Body</code> mixin gain an associated
<dfn title=concept-Body-body>body</dfn> (null or a <span title=concept-body>body</span>) and
a <dfn title=concept-Body-MIME-type>MIME type</dfn> (initially the empty byte sequence).

<p>An object implementing the <code>Body</code> mixin is said to be
<dfn title=concept-Body-disturbed>disturbed</dfn> if <span title=concept-Body-body>body</span> is
non-null and its <span title=concept-body-stream>stream</span> is
<span title=concept-ReadableStream-disturbed>disturbed</span>.

<p>An object implementing the <code>Body</code> mixin is said to be
<dfn title=concept-Body-locked>locked</dfn> if <span title=concept-Body-body>body</span> is
non-null and its <span title=concept-body-stream>stream</span> is
<span title=concept-ReadableStream-locked>locked</span>.

<p>The <dfn title=dom-Body-bodyUsed><code>bodyUsed</code></dfn> attribute's getter must
return true if <span title=concept-Body-disturbed>disturbed</span>, and false otherwise.

<p>Objects implementing the <code>Body</code> mixin also have an associated
<dfn title=concept-Body-package-data>package data</dfn> algorithm, given
<var>bytes</var>, a <var>type</var> and a <var>MIME type</var>, switches on <var>type</var>, and
runs the associated steps:

<dl class=switch>
 <dt><i title>ArrayBuffer</i>
 <dd><p>Return an <code>ArrayBuffer</code> whose contents are <var>bytes</var>. Rethrow any
 exceptions.

 <dt><i title>Blob</i>
 <dd><p>Return a <code data-anolis-spec=fileapi>Blob</code> whose contents are
 <var>bytes</var> and <code data-anolis-spec=fileapi title=dom-Blob-type>type</code>
 is <var>MIME type</var>.

 <dt><i title>FormData</i>
 <dd>
  <p>If <var>MIME type</var> (ignoring parameters) is `<code>multipart/form-data</code>`,
  run these substeps:

  <ol>
   <li><p>Parse <var>bytes</var>, using the value of the
   `<code title>boundary</code>` parameter from <var>MIME type</var> and
   <span data-anolis-spec=encoding>utf-8</span> as encoding, per the rules set forth
   in <cite>Returning Values from Forms: multipart/form-data</cite>.
   <span data-anolis-ref>RFC2388</span>

   <li><p>If that fails for some reason, <span data-anolis-spec=webidl>throw</span> a
   <code title>TypeError</code>.

   <li><p>Return a new <code data-anolis-spec=xhr>FormData</code> object, appending each entry,
   resulting from the parsing operation, to
   <span data-anolis-spec=xhr title=concept-FormData-entry>entries</span>.
  </ol>

  <p class=XXX>The above is a rough approximation of what is needed for
  `<code>multipart/form-data</code>`, a more detailed parsing specification is to be
  written. Volunteers welcome.

  <p>Otherwise, if <var>MIME type</var> (ignoring parameters) is
  `<code>application/x-www-form-urlencoded</code>`, run these substeps:

  <ol>
   <li><p>Let <var>entries</var> be the result of
   <span data-anolis-spec=url title=concept-urlencoded-parser>parsing</span> <var>bytes</var>.

   <li><p>If <var>entries</var> is failure, <span data-anolis-spec=webidl>throw</span> a
   <code title>TypeError</code>.

   <li><p>Return a new <code data-anolis-spec=xhr>FormData</code> object whose
   <span data-anolis-spec=xhr title=concept-FormData-entry>entries</span> are <var>entries</var>.
  </ol>

  <p>Otherwise, <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

 <dt><i title>JSON</i>
 <dd>
  <p>Return the result of invoking the initial value of the <code title>parse</code> property of
  the <code title>JSON</code> object with the result of running
  <span data-anolis-spec=encoding>utf-8 decode</span> on <var>bytes</var> as argument.
  Rethrow any exceptions.

 <dt><i title>text</i>
 <dd><p>Return the result of running <span data-anolis-spec=encoding>utf-8 decode</span> on
 <var>bytes</var>.
</dl>

<p>Objects implementing the <code>Body</code> mixin also have an associated
<dfn title=concept-Body-consume-body>consume body</dfn> algorithm, given a <var>type</var>,
runs these steps:

<ol>
 <li><p>If this object is <span title=concept-Body-disturbed>disturbed</span>
 or <span title=concept-Body-locked>locked</span>, return a new promise rejected with a
 <code>TypeError</code>.

 <li><p>Let <var>stream</var> be <span title=concept-Body-body>body</span>'s
 <span title=concept-body-stream>stream</span> if <span title=concept-Body-body>body</span> is
 non-null, or an <span title=concept-empty-ReadableStream>empty</span>
 <code title=concept-ReadableStream>ReadableStream</code> object otherwise.

 <li><p>Let <var>reader</var> be the result of <span title=concept-get-reader>getting
 a reader</span> from <var>stream</var>. If that threw an exception, return a new promise rejected
 with that exception.

 <li><p>Let <var>promise</var> be the result of
 <span title=concept-read-all-bytes-from-ReadableStream>reading all bytes</span> from
 <var>stream</var> with <var>reader</var>.

 <li><p>Return the result of transforming <var>promise</var> by a fulfillment handler that
 returns the result of the <span title=concept-body-package-data>package data</span> algorithm
 with its first argument, <var>type</var> and this object's
 <span title=concept-body-mime-type>MIME type</span>.
 <!-- XXX IDL really needs to define "transforming". For now it is defined in
          https://www.w3.org/2001/tag/doc/promises-guide -->
</ol>

<p>The <dfn title=dom-Body-arrayBuffer><code>arrayBuffer()</code></dfn>
method, when invoked, must return the result of running
<span title=concept-Body-consume-body>consume body</span> with <i title>ArrayBuffer</i>.

<p>The <dfn title=dom-Body-blob><code>blob()</code></dfn> method, when
invoked, must return the result of running
<span title=concept-Body-consume-body>consume body</span> with <i title>Blob</i>.

<p>The <dfn title=dom-Body-formData><code>formData()</code></dfn> method,
when invoked, must return the result of running
<span title=concept-Body-consume-body>consume body</span> with <i title>FormData</i>.

<p>The <dfn title=dom-Body-json><code>json()</code></dfn> method, when
invoked, must return the result of running
<span title=concept-Body-consume-body>consume body</span> with <i title>JSON</i>.

<p>The <dfn title=dom-Body-text><code>text()</code></dfn> method, when
invoked, must return the result of running
<span title=concept-Body-consume-body>consume body</span> with <i title>text</i>.


<h3 id=request-class>Request class</h3>

<!-- No client member, see
  https://github.com/slightlyoff/ServiceWorker/issues/318
  https://github.com/slightlyoff/ServiceWorker/issues/575 -->

<pre class=idl>typedef (<span>Request</span> or USVString) <dfn>RequestInfo</dfn>;

[<span title=dom-Request>Constructor</span>(<span>RequestInfo</span> <var>input</var>, optional <span>RequestInit</span> <var>init</var>),
 Exposed=(Window,Worker)]
interface <dfn>Request</dfn> {
  readonly attribute ByteString <span title=dom-Request-method>method</span>;
  readonly attribute USVString <span title=dom-Request-url>url</span>;
  [SameObject] readonly attribute <span>Headers</span> <span title=dom-Request-headers>headers</span>;

  readonly attribute <span>RequestType</span> <span title=dom-Request-type>type</span>;
  readonly attribute <span>RequestDestination</span> <span title=dom-Request-destination>destination</span>;
  readonly attribute USVString <span title=dom-Request-referrer>referrer</span>;
  readonly attribute <span data-anolis-spec=referrer>ReferrerPolicy</span> <span title=dom-Request-referrerPolicy>referrerPolicy</span>;
  readonly attribute <span>RequestMode</span> <span title=dom-Request-mode>mode</span>;
  readonly attribute <span>RequestCredentials</span> <span title=dom-Request-credentials>credentials</span>;
  readonly attribute <span>RequestCache</span> <span title=dom-Request-cache>cache</span>;
  readonly attribute <span>RequestRedirect</span> <span title=dom-Request-redirect>redirect</span>;
  readonly attribute DOMString <span title=dom-Request-integrity>integrity</span>;
  readonly attribute boolean <span title=dom-Request-keepalive>keepalive</span>;

  [NewObject] <span>Request</span> <span title=dom-Request-clone>clone</span>();
};
<span>Request</span> implements <span>Body</span>;

<!--
  Careful: defaults can only be set in prose, otherwise the Request() constructor
           algorithm breaks down.
-->dictionary <dfn>RequestInit</dfn> {
  ByteString method;
  <span>HeadersInit</span> headers;
  <span>BodyInit</span>? body;
  USVString referrer;
  <span data-anolis-spec=referrer>ReferrerPolicy</span> referrerPolicy;
  <span>RequestMode</span> mode;
  <span>RequestCredentials</span> credentials;
  <span>RequestCache</span> cache;
  <span>RequestRedirect</span> redirect;
  DOMString integrity;
  boolean keepalive;
  any window; // can only be set to null
};

enum <dfn>RequestType</dfn> { "", "audio", "font", "image", "script", "style", "track", "video" };
enum <dfn>RequestDestination</dfn> { "", "document", "embed", "font", "image", "manifest", "media", "object", "report", "script", "serviceworker", "sharedworker", "style",  "worker", "xslt" };
enum <dfn>RequestMode</dfn> { "navigate", "same-origin", "no-cors", "cors" };
enum <dfn>RequestCredentials</dfn> { "omit", "same-origin", "include" };
enum <dfn>RequestCache</dfn> { "default", "no-store", "reload", "no-cache", "force-cache", "only-if-cached" };
enum <dfn>RequestRedirect</dfn> { "follow", "error", "manual" };</pre>

<p class="note no-backref">"<code>serviceworker</code>" is omitted from
<code>RequestDestination</code> as it cannot be observed from JavaScript. Implementations
will still need to support it as a
<span title=concept-request-destination>destination</span>. "<code title>websocket</code>" is
omitted from <code>RequestMode</code> as it cannot be used nor observed from JavaScript.

<p>A <code>Request</code> object has an associated <dfn title=concept-Request-request>request</dfn>
(a <span title=concept-request>request</span>).

<p>A <code>Request</code> object also has an associated <code>Headers</code> object which
is itself associated with <span title=concept-Request-request>request</span>'s
<span title=concept-request-header-list>header list</span>.

<p>A <code>Request</code> object's <span title=concept-Body-body>body</span> is its
<span title=concept-Request-request>request</span>'s
<span title=concept-request-body>body</span>.

<hr>

<p>The
<dfn title=dom-Request><code>Request(<var>input</var>, <var>init</var>)</code></dfn>
constructor must run these steps:

<ol>
 <li><p>Let <var>request</var> be null.

 <li><p>Let <var>fallbackMode</var> be null.

 <li><p>Let <var>fallbackCredentials</var> be null.

 <li><p>Let <var>baseURL</var> be <span data-anolis-spec=html>current settings object</span>'s
 <span data-anolis-spec=html>API base URL</span>.

 <li>
  <p>If <var>input</var> is a string, then run these substeps:

  <ol>
   <li><p>Let <var>parsedURL</var> be the result of
   <span data-anolis-spec=url title=concept-url-parser>parsing</span> <var>input</var> with
   <var>baseURL</var>.

   <li><p>If <var>parsedURL</var> is failure, then <span data-anolis-spec=webidl>throw</span> a
   <code title>TypeError</code>.

   <li><p>If <var>parsedURL</var>
   <span data-anolis-spec=url title="include credentials">includes credentials</span>, then
   <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

   <li><p>Set <var>request</var> to a new <span title=concept-request>request</span> whose
   <span title=concept-request-url>url</span> is <var>parsedURL</var>.

   <li><p>Set <var>fallbackMode</var> to "<code title>cors</code>".

   <li><p>Set <var>fallbackCredentials</var> to "<code title>omit</code>".
  </ol>

 <li>
  <p>Otherwise (<var>input</var> is a <code>Request</code> object), run these substeps:

  <ol>
   <li><p>If <var>input</var> is <span title=concept-Body-disturbed>disturbed</span> or
   <span title=concept-Body-locked>locked</span>, then <span data-anolis-spec=webidl>throw</span> a
   <code title>TypeError</code>.

   <li><p>Set <var>request</var> to <var>input</var>'s
   <span title=concept-Request-request>request</span>.
  </ol>

 <li><p>Let <var>origin</var> be <span data-anolis-spec=html>current settings object</span>'s
 <span data-anolis-spec=html>origin</span>.

 <li><p>Let <var>window</var> be "<code>client</code>".

 <li><p>If <var>request</var>'s <span title=concept-request-window>window</span> is
 an <span data-anolis-spec=html>environment settings object</span> and its
 <span data-anolis-spec=html>origin</span> is <span data-anolis-spec=html>same origin</span> with
 <var>origin</var>, set <var>window</var> to <var>request</var>'s
 <span title=concept-request-window>window</span>.

 <li><p>If <var>init</var>'s <code title>window</code> member is present and it is
 not null, <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

 <li><p>If <var>init</var>'s <code title>window</code> member is present, set
 <var>window</var> to "<code>no-window</code>".

 <li><p>Set <var>request</var> to a new <span title=concept-request>request</span>
 whose <span title=concept-request-url>url</span> is <var>request</var>'s
 <span title=concept-request-current-url>current url</span>,
 <span title=concept-request-method>method</span> is <var>request</var>'s
 <span title=concept-request-method>method</span>,
 <span title=concept-request-header-list>header list</span> is a copy of
 <var>request</var>'s <span title=concept-request-header-list>header list</span>,
 <span>unsafe-request flag</span> is set,
 <span title=concept-request-client>client</span> is
 <span data-anolis-spec=html>current settings object</span>,
 <span title=concept-request-window>window</span> is <var>window</var>,
 <span title=concept-request-origin>origin</span> is "<code>client</code>",
 <span>omit-<code>Origin</code>-header flag</span> is <var>request</var>'s
 <span>omit-<code>Origin</code>-header flag</span>,
 <span title=concept-request-referrer>referrer</span> is <var>request</var>'s
 <span title=concept-request-referrer>referrer</span>,
 <span title=concept-request-referrer-policy>referrer policy</span> is
 <var>request</var>'s
 <span title=concept-request-referrer-policy>referrer policy</span>,
 <span title=concept-request-mode>mode</span> is <var>request</var>'s
 <span title=concept-request-mode>mode</span>,
 <span title=concept-request-credentials-mode>credentials mode</span> is
 <var>request</var>'s
 <span title=concept-request-credentials-mode>credentials mode</span>,
 <span title=concept-request-cache-mode>cache mode</span> is
 <var>request</var>'s
 <span title=concept-request-cache-mode>cache mode</span>,
 <span title=concept-request-redirect-mode>redirect mode</span> is
 <var>request</var>'s
 <span title=concept-request-redirect-mode>redirect mode</span>,
 <span title=concept-request-integrity-metadata>integrity metadata</span> is
 <var>request</var>'s
 <span title=concept-request-integrity-metadata>integrity metadata</span>, and
 <span>keepalive flag</span> is <var>request</var>'s <span>keepalive flag</span>.

 <li>
  <p>If any of <var>init</var>'s members are present, run these substeps:

  <ol>
   <li><p>If <var>request</var>'s <span title=concept-request-mode>mode</span> is
   "<code title>navigate</code>", then set it to "<code>same-origin</code>".
   <!-- This works because we have reset request's client too. -->

   <li><p>Unset <var>request</var>'s <span>omit-<code>Origin</code>-header flag</span>.

   <li><p>Set <var>request</var>'s <span title=concept-request-referrer>referrer</span> to
   "<code>client</code>"

   <li><p>Set <var>request</var>'s
   <span title=concept-request-referrer-policy>referrer policy</span> to the empty string.
  </ol>

  <p class="note">This is done to ensure that when a service worker "redirects" a request, .e.g.,
  from an image in a cross-origin stylesheet, and makes modifications, it no longer appears to come
  from the original source (i.e., the cross-origin stylesheet), but instead from the service worker
  that "redirected" the request. This is important as the original source might not even be able to
  generate the same kind of requests as the service worker. Services that trust the original source
  could therefore be exploited were this not done, although that is somewhat farfetched.

 <li>
  <p>If <var>init</var>'s <code>referrer</code> member is present, run these
  substeps:

  <ol>
   <li><p>Let <var>referrer</var> be <var>init</var>'s <code>referrer</code>
   member.

   <li><p>If <var>referrer</var> is the empty string, set <var>request</var>'s
   <span title=concept-request-referrer>referrer</span> to "<code>no-referrer</code>" and
   terminate these substeps.

   <li><p>Let <var>parsedReferrer</var> be the result of
   <span data-anolis-spec=url title=concept-url-parser>parsing</span>
   <var>referrer</var> with <var>baseURL</var>.

   <li><p>If <var>parsedReferrer</var> is failure, then <span data-anolis-spec=webidl>throw</span> a
   <code title>TypeError</code>.

   <li>
    <p>If one of the following conditions is true, then set <var>request</var>'s
    <span title=concept-request-referrer>referrer</span> to "<code>client</code>":

    <ul class=brief>
     <li><var>parsedReferrer</var>'s <span data-anolis-spec=url>non-relative flag</span> is set,
     <span data-anolis-spec=url title=concept-url-scheme>scheme</span> is "<code>about</code>", and
     <span data-anolis-spec=url title=concept-url-path>path</span> contains a single string
     "<code>client</code>".

     <li><var>parsedReferrer</var>'s
     <span data-anolis-spec=url title=concept-url-origin>origin</span> is not
     <span data-anolis-spec=html>same origin</span> with <var>origin</var>
    </ul>
    <!-- This can happen when you create a fresh request with values from an older request. Throwing
         would be rather hostile as preventing it requires implementing the same-origin check in
         developer space. -->

   <li><p>Otherwise, set <var>request</var>'s <span title=concept-request-referrer>referrer</span>
   to <var>parsedReferrer</var>.
  </ol>

 <li><p>If <var>init</var>'s <code title>referrerPolicy</code> member is present, set
 <var>request</var>'s
 <span title=concept-request-referrer-policy>referrer policy</span> to it.

 <li><p>Let <var>mode</var> be <var>init</var>'s <code title>mode</code>
 member if it is present, and <var>fallbackMode</var> otherwise.

 <li><p>If <var>mode</var> is "<code title>navigate</code>",
 <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

 <li><p>If <var>mode</var> is non-null, set <var>request</var>'s
 <span title=concept-request-mode>mode</span> to <var>mode</var>.

 <li><p>Let <var>credentials</var> be <var>init</var>'s
 <code title>credentials</code> member if it is present, and
 <var>fallbackCredentials</var> otherwise.

 <li><p>If <var>credentials</var> is non-null, set <var>request</var>'s
 <span title=concept-request-credentials-mode>credentials mode</span> to
 <var>credentials</var>.

 <li><p>If <var>init</var>'s <code title>cache</code> member is present, set
 <var>request</var>'s <span title=concept-request-cache-mode>cache mode</span> to
 it.

 <li><p>If <var>request</var>'s <span title=concept-request-cache-mode>cache mode</span> is
 "<code title>only-if-cached</code>" and <var>request</var>'s
 <span title=concept-request-mode>mode</span> is <em>not</em> "<code title>same-origin</code>", then
 <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

 <li><p>If <var>init</var>'s <code title>redirect</code> member is present, set
 <var>request</var>'s <span title=concept-request-redirect-mode>redirect mode</span>
 to it.

 <li><p>If <var>init</var>'s <code title>integrity</code> member is present, set
 <var>request</var>'s
 <span title=concept-request-integrity-metadata>integrity metadata</span> to it.

 <li><p>If <var>init</var>'s <code>keepalive</code> member is present, then set <var>request</var>'s
 <span>keepalive flag</span> if <var>init</var>'s <code>keepalive</code> member is true, and unset
 it otherwise.

 <li>
  <p>If <var>init</var>'s <code title>method</code> member is present, let
  <var>method</var> be it and run these substeps:

  <ol>
   <li><p>If <var>method</var> is not a <span title=concept-method>method</span> or
   <var>method</var> is a <span>forbidden method</span>,
   <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

   <li><p><span title=concept-method-normalize>Normalize</span> <var>method</var>.

   <li><p>Set <var>request</var>'s <span title=concept-request-method>method</span>
   to <var>method</var>.
  </ol>

 <li><p>Let <var>r</var> be a new <code>Request</code> object associated with <var>request</var> and
 a new associated <code>Headers</code> object whose <span title=concept-Headers-guard>guard</span>
 is "<code title>request</code>".

 <li><p>Let <var>headers</var> be a copy of <var>r</var>'s <code>Headers</code> object and its
 associated <span title=concept-Headers-header-list>header list</span>.
 <!-- it might contain a header that is no longer allowed per the mode change -->

 <li><p>If <var>init</var>'s <code title>headers</code> member is present, set
 <var>headers</var> to <var>init</var>'s <code title>headers</code> member.

 <li><p>Empty <var>r</var>'s <code>Headers</code> object's
 <span title=concept-Headers-header-list>header list</span>.

 <li>
  <p>If <var>r</var>'s <span title=concept-Request-request>request</span>'s
  <span title=concept-request-mode>mode</span> is "<code title>no-cors</code>", run these
  substeps:

  <ol>
   <li><p>If <var>r</var>'s <span title=concept-Request-request>request</span>'s
   <span title=concept-request-method>method</span> is not a <span>CORS-safelisted method</span>,
   <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

   <li><p>If <var>request</var>'s
   <span title=concept-request-integrity-metadata>integrity metadata</span> is not
   the empty string, <span data-anolis-spec=webidl>throw</span> a
   <code title>TypeError</code>.

   <li><p>Set <var>r</var>'s <code>Headers</code> object's
   <span title=concept-Headers-guard>guard</span> to "<code title>request-no-cors</code>".
  </ol>

 <li><p><span title=concept-Headers-fill>Fill</span> <var>r</var>'s
 <code>Headers</code> object with <var>headers</var>. Rethrow any exceptions.

 <li><p>Let <var>inputBody</var> be <var>input</var>'s
 <span title=concept-Request-request>request</span>'s <span title=concept-request-body>body</span>
 if <var>input</var> is a <code>Request</code> object, and null otherwise.

 <li><p>If either <var>init</var>'s <code title>body</code> member is present and is non-null or
 <var>inputBody</var> is non-null, and <var>request</var>'s
 <span title=concept-request-method>method</span> is `<code title>GET</code>` or
 `<code title>HEAD</code>`, <span data-anolis-spec=webidl>throw</span> a
 <code title>TypeError</code>.

 <li>
  <p>If <var>init</var>'s <code title>body</code> member is present and is non-null, run these
  substeps:

  <ol>
   <li><p>Let <var>Content-Type</var> be null.

   <li><p>If <var>init</var>'s <code>keepalive</code> member is present and is true, then set
   <var>inputBody</var> and <var>Content-Type</var> to the result of
   <span title=concept-BodyInit-extract>extracting</span> <var>init</var>'s <code title>body</code>
   member, with <var>keepalive flag</var> set. Rethrow any exceptions.

   <li><p>Otherwise, set <var>inputBody</var> and <var>Content-Type</var> to the result of
   <span title=concept-BodyInit-extract>extracting</span> <var>init</var>'s
   <code title>body</code> member. Rethrow any exceptions.

   <li><p>If <var>Content-Type</var> is non-null and <var>r</var>'s <code>Headers</code> object's
   <span title=concept-Headers-header-list>header list</span> contains no
   <span title=concept-header>header</span> <span title=concept-header-name>named</span>
   `<code title>Content-Type</code>`, then <span title=concept-Headers-append>append</span>
   `<code title>Content-Type</code>`/<var>Content-Type</var> to <var>r</var>'s
   <code>Headers</code> object. Rethrow any exception.
  </ol>

 <li><p>Set <var>r</var>'s <span title=concept-Request-request>request</span>'s
 <span title=concept-request-body>body</span> to <var>inputBody</var>.
 <!-- Any steps after this must not throw. -->

 <li><p>Set <var>r</var>'s <span title=concept-Body-MIME-type>MIME type</span> to
 the result of <span title=concept-header-extract-MIME-type>extracting a MIME type</span>
 from <var>r</var>'s <span title=concept-Request-request>request</span>'s
 <span title=concept-request-header-list>header list</span>.

 <li>
  <p>If <var>input</var> is a <code>Request</code> object and
  <var>input</var>'s <span title=concept-Request-request>request</span>'s
  <span title=concept-request-body>body</span> is non-null, run these substeps:

  <ol>
   <li><p>Let <var>dummyStream</var> be an <span title=concept-empty-ReadableStream>empty</span>
   <code title=concept-ReadableStream>ReadableStream</code> object.

   <li><p>Set <var>input</var>'s <span title=concept-Request-request>request</span>'s
   <span title=concept-request-body>body</span> to a new <span title=concept-body>body</span> whose
   <span title=concept-body-stream>stream</span> is <var>dummyStream</var>.

   <li>
    <p>Let <var>reader</var> be the result of <span title=concept-get-reader>getting a reader</span>
    from <var>dummyStream</var>.
    <p class="note no-backref">This operation will not throw an exception.

   <li>
    <p><span title=concept-read-all-bytes-from-ReadableStream>Read all bytes</span> from
    <var>dummyStream</var> with <var>reader</var>.
    <p class="note no-backref">This operation makes <var>dummyStream</var> disturbed.
  </ol>

  <p class="note no-backref">These substeps are meant to produce the observable equivalent of
  "piping" <var>input</var>'s <span title=concept-Body-body>body</span>'s
  <span title=concept-body-stream>stream</span> into <var>r</var>. That is, <var>input</var> is
  left with a <span title=concept-body>body</span> with a
  <code title=concept-ReadableStream>ReadableStream</code> object that is
  <span title=concept-ReadableStream-disturbed>disturbed</span> and
  <span title=concept-ReadableStream-locked>locked</span>, while the data readable from
  <var>r</var>'s <span title=concept-Body-body>body</span>'s
  <span title=concept-body-stream>stream</span> is now equal to what used to be <var>input</var>'s,
  if <var>input</var>'s original <span title=concept-Body-body>body</span> is non-null.

 <li><p>Return <var>r</var>.
</ol>

<p>The <dfn title=dom-Request-method><code>method</code></dfn> attribute's getter must
return <span title=concept-Request-request>request</span>'s
<span title=concept-request-method>method</span>.

<p>The <dfn title=dom-Request-url><code>url</code></dfn> attribute's getter must
return <span title=concept-Request-request>request</span>'s
<span title=concept-request-url>url</span>,
<span data-anolis-spec=url title=concept-url-serializer>serialized</span>.

<p>The <dfn title=dom-Request-headers><code>headers</code></dfn> attribute's getter must
return the associated <code>Headers</code> object.

<p>The <dfn title=dom-Request-type><code>type</code></dfn> attribute's getter must return
<span title=concept-Request-request>request</span>'s
<span title=concept-Request-type>type</span>.

<p>The <dfn title=dom-Request-destination><code>destination</code></dfn> attribute's
getter must return <span title=concept-Request-request>request</span>'s
<span title=concept-Request-destination>destination</span>.

<p>The <dfn title=dom-Request-referrer><code>referrer</code></dfn> attribute's getter must
return the empty string if <span title=concept-Request-request>request</span>'s
<span title=concept-Request-referrer>referrer</span> is "<code>no-referrer</code>",
"<code title>about:client</code>" if <span title=concept-Request-request>request</span>'s
<span title=concept-Request-referrer>referrer</span> is "<code>client</code>", and
<span title=concept-Request-request>request</span>'s
<span title=concept-Request-referrer>referrer</span>,
<span data-anolis-spec=url title=concept-url-serializer>serialized</span>, otherwise.

<p>The <dfn title=dom-Request-referrerPolicy><code>referrerPolicy</code></dfn> attribute's
getter must return <span title=concept-Request-request>request</span>'s
<span title=concept-Request-referrer-policy>referrer policy</span>.

<p>The <dfn title=dom-Request-mode><code>mode</code></dfn> attribute's getter must return
<span title=concept-Request-request>request</span>'s <span title=concept-request-mode>mode</span>.

<p>The <dfn title=dom-Request-credentials><code>credentials</code></dfn> attribute's
getter must return <span title=concept-Request-request>request</span>'s
<span title=concept-request-credentials-mode>credentials mode</span>.

<p>The <dfn title=dom-Request-cache><code>cache</code></dfn> attribute's getter must
return <span title=concept-Request-request>request</span>'s
<span title=concept-request-cache-mode>cache mode</span>.

<p>The <dfn title=dom-Request-redirect><code>redirect</code></dfn> attribute's getter must
return <span title=concept-Request-request>request</span>'s
<span title=concept-request-redirect-mode>redirect mode</span>.

<p>The <dfn title=dom-Request-integrity><code>integrity</code></dfn> attribute's getter
must return <span title=concept-Request-request>request</span>'s
<span title=concept-request-integrity-metadata>integrity metadata</span>.

<p>The <dfn title=dom-Request-keepalive><code>keepalive</code></dfn> attribute's getter
must return true if <span title=concept-Request-request>request</span>'s <span>keepalive flag</span>
is set, and false otherwise.

<hr>

<p>The <dfn title=dom-Request-clone><code>clone()</code></dfn> method, when invoked, must
run these steps:

<ol>
 <li><p>If this <code>Request</code> object is <span title=concept-Body-disturbed>disturbed</span>
 or <span title=concept-Body-locked>locked</span>,
 <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

 <li><p>Return a new <code>Request</code> object associated with the result of
 <span title=concept-request-clone>cloning</span> <span title=concept-Request-request>request</span>
 and a new associated <code>Headers</code> object whose
 <span title=concept-Headers-guard>guard</span> is
 <span data-anolis-spec=dom>context object</span>'s <code>Headers</code> object's
 <span title=concept-Headers-guard>guard</span>.
</ol>


<h3 id=response-class>Response class</h3>

<pre class=idl>[<span title=dom-Response>Constructor</span>(optional <span>ResponseBodyInit</span>? <var>body</var> = null, optional <span>ResponseInit</span> <var>init</var>),
 Exposed=(Window,Worker)]
interface <dfn>Response</dfn> {
  [NewObject] static <span>Response</span> <span title=dom-Response-error>error</span>();
  [NewObject] static <span>Response</span> <span title=dom-Response-redirect>redirect</span>(USVString <var>url</var>, optional unsigned short <var>status</var> = 302);

  readonly attribute <span>ResponseType</span> <span title=dom-Response-type>type</span>;

  readonly attribute USVString <span title=dom-Response-url>url</span>;
  readonly attribute boolean <span title=dom-Response-redirected>redirected</span>;
  readonly attribute unsigned short <span title=dom-Response-status>status</span>;
  readonly attribute boolean <span title=dom-Response-ok>ok</span>;
  readonly attribute ByteString <span title=dom-Response-statusText>statusText</span>;
  [SameObject] readonly attribute <span>Headers</span> <span title=dom-Response-headers>headers</span>;
  readonly attribute <span title=concept-ReadableStream>ReadableStream</span>? <span title=dom-Response-body>body</span>;
  [SameObject] readonly attribute Promise&lt;<span>Headers</span>> <span title=dom-Response-trailer>trailer</span>;

  [NewObject] <span>Response</span> <span title=dom-Response-clone>clone</span>();
};
<span>Response</span> implements <span>Body</span>;

dictionary <dfn>ResponseInit</dfn> {
  unsigned short status = 200;
  ByteString statusText = "OK";
  <span>HeadersInit</span> headers;
};

enum <dfn>ResponseType</dfn> { "basic", "cors", "default", "error", "opaque", "opaqueredirect" };</pre>

<p>A <code>Response</code> object has an associated
<dfn title=concept-Response-response>response</dfn> (a
<span title=concept-response>response</span>).

<p>A <code>Response</code> object also has an associated <code>Headers</code> object which
is itself associated with <span title=concept-Response-response>response</span>'s
<span title=concept-response-header-list>header list</span>.

<p>A <code>Response</code> object also has an associated
<dfn title=concept-Response-trailer-promise>trailer promise</dfn> (a promise). <span class=note>Used
for the <code title=dom-Response-trailer>trailer</code> attribute.</span>

<p>A <code>Response</code> object's <span title=concept-Body-body>body</span> is its
<span title=concept-Response-response>response</span>'s <span title=concept-response-body>body</span>.

<p>The
<dfn title=dom-Response><code>Response(<var>body</var>, <var>init</var>)</code></dfn>
constructor, when invoked, must run these steps:

<ol>
 <li><p>If <var>init</var>'s <code title>status</code> member is not in the range
 <code>200</code> to <code>599</code>, inclusive, <span data-anolis-spec=webidl>throw</span> a
 <code title>RangeError</code>.

 <li><p>If <var>init</var>'s <code title>statusText</code> member does not match the
 <span data-anolis-spec=http>reason-phrase</span> token production,
 <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

 <li><p>Let <var>r</var> be a new <code>Response</code> object, associated with a new
 <span title=concept-response>response</span> and a new associated <code>Headers</code> object whose
 <span title=concept-Headers-guard>guard</span> is "<code title>response</code>".

 <li><p>Set <var>r</var>'s <span title=concept-Response-response>response</span>'s
 <span title=concept-response-status>status</span> to <var>init</var>'s
 <code title>status</code> member.

 <li><p>Set <var>r</var>'s <span title=concept-Response-response>response</span>'s
 <span title=concept-response-status-message>status message</span> to
 <var>init</var>'s <code title>statusText</code> member.

 <li>
  <p>If <var>init</var>'s <code title>headers</code> member is present, run these
  substeps:

  <ol>
   <li><p>Empty <var>r</var>'s
   <span title=concept-Response-response>response</span>'s
   <span title=concept-response-header-list>header list</span>.

   <li><p><span title=concept-Headers-fill>Fill</span> <var>r</var>'s
   <code>Headers</code> object with <var>init</var>'s <code title>headers</code>
   member. Rethrow any exceptions.
  </ol>

 <li>
  <p>If <var>body</var> is non-null, run these substeps:

  <ol>
   <li>
    <p>If <var>init</var>'s <code title>status</code> member is a
    <span>null body status</span>, <span data-anolis-spec=webidl>throw</span> a
    <code title>TypeError</code>.

    <p class="note no-backref"><code title>101</code> is included in
    <span>null body status</span> due to its use elsewhere. It does not affect this step.

   <li><p>Let <var>Content-Type</var> be null.

   <li><p>Set <var>r</var>'s <span title=concept-Response-response>response</span>'s
   <span title=concept-response-body>body</span> and <var>Content-Type</var> to the result of
   <span title=concept-BodyInit-extract>extracting</span> <var>body</var>. Rethrow any exceptions.

   <li><p>If <var>Content-Type</var> is non-null and <var>r</var>'s
   <span title=concept-Response-response>response</span>'s
   <span title=concept-response-header-list>header list</span> contains no
   <span title=concept-header>header</span> <span title=concept-header-name>named</span>
   `<code title>Content-Type</code>`, <span title=concept-header-list-append>append</span>
   `<code title>Content-Type</code>`/<var>Content-Type</var> to
   <var>r</var>'s <span title=concept-Response-response>response</span>'s
   <span title=concept-response-header-list>header list</span>.
  </ol>

 <li><p>Set <var>r</var>'s <span title=concept-Body-MIME-type>MIME type</span> to
 the result of <span title=concept-header-extract-MIME-type>extracting a MIME type</span>
 from <var>r</var>'s <span title=concept-Response-response>response</span>'s
 <span title=concept-response-header-list>header list</span>.

 <li><p>Set <var>r</var>'s <span title=concept-Response-response>response</span>'s
 <span title=concept-response-https-state>HTTPS state</span> to
 <span data-anolis-spec=html>current settings object</span>'s
 <span data-anolis-spec=html>HTTPS state</span>.

 <li><p>Resolve <var>r</var>'s <span title=concept-Response-trailer-promise>trailer promise</span>
 with a new <code>Headers</code> object whose <span title=concept-Headers-guard>guard</span> is
 "<code>immutable</code>".

 <li><p>Return <var>r</var>.
</ol>

<p>The static <dfn title=dom-Response-error><code>error()</code></dfn> method, when invoked, must
return a new <code>Response</code> object, associated with a new
<span title=concept-network-error>network error</span> and a new associated <code>Headers</code>
object whose <span title=concept-Headers-guard>guard</span> is "<code title>immutable</code>".

<p>The static
<dfn title=dom-Response-redirect><code>redirect(<var>url</var>, <var>status</var>)</code></dfn>
method, when invoked, must run these steps:

<ol>
 <li><p>Let <var>parsedURL</var> be the result of
 <span data-anolis-spec=url title=concept-url-parser>parsing</span> <var>url</var> with
 <span data-anolis-spec=html>current settings object</span>'s
 <span data-anolis-spec=html>API base URL</span>.

 <li><p>If <var>parsedURL</var> is failure,
 <span data-anolis-spec=webidl>throw</span> a <code title>TypeError</code>.

 <li><p>If <var>status</var> is not a <span>redirect status</span>,
 <span data-anolis-spec=webidl>throw</span> a <code title>RangeError</code>.

 <li><p>Let <var>r</var> be a new <code>Response</code> object, associated with a new
 <span title=concept-response>response</span> and a new associated <code>Headers</code> object whose
 <span title=concept-Headers-guard>guard</span> is "<code title>immutable</code>".

 <li><p>Set <var>r</var>'s <span title=concept-Response-response>response</span>'s
 <span title=concept-response-status>status</span> to <var>status</var>.

 <li><p><span title=concept-header-list-set>Set</span> `<code title>Location</code>` to
 <var>parsedURL</var>,
 <span data-anolis-spec=url title=concept-url-serializer>serialized</span> and
 <span data-anolis-spec=encoding title="utf-8 encode">utf-8 encoded</span>, in
 <var>r</var>'s <span title=concept-Response-response>response</span>'s
 <span title=concept-response-header-list>header list</span>.

 <li><p>Return <var>r</var>.
</ol>

<p>The <dfn title=dom-Response-type><code>type</code></dfn> attribute's getter must return
<span title=concept-Response-response>response</span>'s
<span title=concept-response-type>type</span>.

<p>The <dfn title=dom-Response-url><code>url</code></dfn> attribute's getter must return
the empty string if <span title=concept-Response-response>response</span>'s
<span title=concept-response-url>url</span> is null and
<span title=concept-Response-response>response</span>'s
<span title=concept-response-url>url</span>,
<span data-anolis-spec=url title=concept-url-serializer>serialized</span> with the
<i title>exclude-fragment flag</i> set, otherwise.
<span data-anolis-ref>URL</span>

<p>The <dfn title=dom-Response-redirected><code>redirected</code></dfn> attribute's getter must
return true if <span title=concept-Response-response>response</span>'s
<span title=concept-response-url-list>url list</span> has more than one item, and false otherwise.

<p class=note>To filter out <span title=concept-response>responses</span> that are the result of a
redirect, do this directly through the API, e.g., <code>fetch(url, { redirect:"error" })</code>.
This way a potentially unsafe <span title=concept-response>response</span> cannot accidentally leak.

<p>The <dfn title=dom-Response-status><code>status</code></dfn> attribute's getter must
return <span title=concept-Response-response>response</span>'s
<span title=concept-response-status>status</span>.

<p>The <dfn title=dom-Response-ok><code>ok</code></dfn> attribute's getter must
return true if <span title=concept-Response-response>response</span>'s
<span title=concept-response-status>status</span> is an <span>ok status</span>, and false otherwise.

<p>The <dfn title=dom-Response-statusText><code>statusText</code></dfn> attribute's getter
must return <span title=concept-Response-response>response</span>'s
<span title=concept-response-status-message>status message</span>.

<p>The <dfn title=dom-Response-headers><code>headers</code></dfn> attribute's getter must
return the associated <code>Headers</code> object.

<p>The <dfn title=dom-Response-body><code>body</code></dfn> attribute's getter must return null if
the associated <span title=concept-Body-body>body</span> is null and the associated
<span title=concept-Body-body>body</span>'s <span title=concept-body-stream>stream</span> otherwise.

<p>The <dfn title=dom-Response-trailer><code>trailer</code></dfn> attribute's getter must return the
associated <span title=concept-Response-trailer-promise>trailer promise</span>.

<hr>

<p>The <dfn title=dom-Response-clone><code>clone()</code></dfn> method, when invoked, must
run these steps:

<ol>
 <li><p>If <span data-anolis-spec=dom>context object</span> is
 <span title=concept-Body-disturbed>disturbed</span> or
 <span title=concept-Body-locked>locked</span>, then <span data-anolis-spec=webidl>throw</span> a
 <code title>TypeError</code>.

 <li><p>Let <var>clonedResponse</var> be a new <code>Response</code> object associated with the
 result of <span title=concept-response-clone>cloning</span>
 <span data-anolis-spec=dom>context object</span>'s
 <span title=concept-Response-response>response</span> and a new associated <code>Headers</code>
 object whose <span title=concept-Headers-guard>guard</span> is
 <span data-anolis-spec=dom>context object</span>'s <code>Headers</code> object's
 <span title=concept-Headers-guard>guard</span>.

 <li><p>Upon fulfillment of <span data-anolis-spec=dom>context object</span>'s
 <span title=concept-Response-trailer-promise>trailer promise</span>, resolve
 <var>clonedResponse</var>'s <span title=concept-Response-trailer-promise>trailer promise</span>
 with a new <code>Headers</code> object whose <span title=concept-Headers-guard>guard</span> is
 "<code>immutable</code>" that is associated with <var>clonedResponse</var>'s
 <span title=concept-response-trailer>trailer</span>.

 <li><p>Return <var>clonedResponse</var>.
</ol>


<h3 id=fetch-method>Fetch method</h3>

<pre class=idl>partial interface <span data-anolis-spec=html>WindowOrWorkerGlobalScope</span> {
  [NewObject] Promise&lt;<span>Response</span>> <span title=dom-global-fetch>fetch</span>(<span>RequestInfo</span> <var>input</var>, optional <span>RequestInit</span> <var>init</var>);
};</pre>

<p>The
<dfn title=dom-global-fetch><code>fetch(<var>input</var>, <var>init</var>)</code></dfn>
method, must run these steps:

<ol>
 <li><p>Let <var>p</var> be a new promise.

 <li><p>Let <var>request</var> be the associated
 <span title=concept-request>request</span> of the result of invoking the initial value of
 <code title=dom-Request>Request</code> as constructor with <var>input</var> and
 <var>init</var> as arguments. If this throws an exception, reject
 <var>p</var> with it and return <var>p</var>.

 <li><p>Let <var>responseObject</var> be a new <code>Response</code> object and a new associated
 <code>Headers</code> object whose <span title=concept-Headers-guard>guard</span> is
 "<code>immutable</code>".

 <li>
  <p>Run the following <span data-anolis-spec=html>in parallel</span>:

  <p><span title=concept-fetch>Fetch</span> <var>request</var>.

  <p>To <span>process response</span> for <var>response</var>, run these substeps:

  <ol>
   <li><p>If <var>response</var>'s <span title=concept-response-type>type</span> is
   "<code title>error</code>", reject <var>p</var> with a <code title>TypeError</code> and terminate
   these substeps.

   <li><p>Associate <var>responseObject</var> with <var>response</var>.

   <li><p>Resolve <var>p</var> with <var>responseObject</var>.
  </ol>

  <p>To <span>process response done</span> for <var>response</var>, run these substeps:

  <ol>
   <li><p>Let <var>trailerObject</var> be a new <code>Headers</code> object whose
   <span title=concept-Headers-guard>guard</span> is "<code>immutable</code>".

   <li><p>Associate <var>trailerObject</var> with <var>response</var>'s
   <span title=concept-response-trailer>trailer</span>.

   <li><p>Resolve <var>responseObject</var>'s
   <span title=concept-Response-trailer-promise>trailer promise</span> with
   <var>trailerObject</var>.
  </ol>

 <li><p>Return <var>p</var>.
</ol>


<h3 id=garbage-collection>Garbage collection</h3>

<p>The user agent may <span title=concept-fetch-terminate>terminate</span> an ongoing fetch with
reason <i title>garbage collection</i> if that termination is not observable through script.

<p class="note no-backref">"Observable through script" means observable through
<code title=dom-global-fetch>fetch()</code>'s arguments and return value. Other ways, such as
communicating with the server through a side-channel are not included.

<p class="note no-backref">The server being able to observe garbage collection has precedent, e.g.,
with <code>WebSocket</code> and <code>XMLHttpRequest</code> objects.

<div id=terminate-examples class="example no-backref">
 <p>The user agent can terminate the fetch because the termination cannot be observed.
 <pre>fetch("https://www.example.com/")</pre>

 <p>The user agent cannot terminate the fetch because the termination can be observed through
 the promise.
 <pre>window.promise = fetch("https://www.example.com/")</pre>

 <p>The user agent can terminate the fetch because the associated body is not observable.
 <pre>window.promise = fetch("https://www.example.com/").then(res => res.headers)</pre>

 <p>The user agent can terminate the fetch because the termination cannot be observed.
 <pre>fetch("https://www.example.com/").then(res => res.body.getReader().closed)</pre>

 <p>The user agent cannot terminate the fetch because one can observe the termination by registering
 a handler for the promise object.
 <pre>window.promise = fetch("https://www.example.com/")
  .then(res => res.body.getReader().closed)</pre>

 <p>The user agent cannot terminate the fetch as termination would be observable via the registered
 handler.
 <pre>fetch("https://www.example.com/")
  .then(res => {
    res.body.getReader().closed.then(() => console.log("stream closed!"))
  })</pre>
</div>



<h2 id=websocket-protocol>WebSocket protocol alterations</h2>

<div class="note">
 <p>This section replaces part of the WebSocket protocol opening handshake client requirement to
 integrate it with algorithms defined in Fetch. This way CSP, cookies, HSTS, and other Fetch-related
 protocols are handled in a single location. Ideally the RFC would be updated with this language,
 but it is never that easy. The WebSocket API, defined in the HTML Standard, has been updated to use
 this language. <span data-anolis-ref>WSP</span> <span data-anolis-ref>HTML</span>

 <p>The way this works is by replacing The WebSocket Protocol's "establish a WebSocket connection"
 algorithm with a new one that integrates with Fetch. "Establish a WebSocket connection" consists of
 three algorithms: setting up a connection, creating and transmiting a handshake request, and
 validating the handshake response. That layering is different from Fetch, which first creates a
 handshake, then sets up a connection and transmits the handshake, and finally validates the
 response. Keep that in mind while reading these alterations.
</div>


<h3 id=websocket-connections>Connections</h3>

<p>To <dfn title=concept-websocket-connection-obtain>obtain a WebSocket connection</dfn>, given a
<var>url</var>, run these steps:

<ol>
 <li><p>Let <var>host</var> be <var>url</var>'s
 <span data-anolis-spec=url title=concept-url-host>host</span>.

 <li><p>Let <var>port</var> be <var>url</var>'s
 <span data-anolis-spec=url title=concept-url-port>port</span>.

 <li><p>Let <var>secure</var> be false, if <var>url</var>'s
 <span title=concept-url-scheme>scheme</span> is "<code title>http</code>", and true otherwise.

 <li><p>Follow the requirements stated in step 2 to 5, inclusive, of the first set of steps in
 <a href="http://tools.ietf.org/html/rfc6455#section-4.1">section 4.1</a> of The WebSocket Protocol
 to establish a <span title=concept-websocket-connection>WebSocket connection</span>.
 <span data-anolis-ref>WSP</span>

 <li><p>If that established a connection, return it, and return failure otherwise.
</ol>

<p class="note">Although structured a little differently, carrying different properties, and
therefore not shareable, a WebSocket connection is very close to identical to an "ordinary"
<span title=concept-connection>connection</span>.


<h3 id=websocket-opening-handshake>Opening handshake</h3>

<p>To <dfn title=concept-websocket-establish>establish a WebSocket connection</dfn>, given a
<var>url</var>, <var>protocols</var>, and <var>client</var>, run these steps:

<ol>
 <li>
  <p>Let <var>requestURL</var> be a copy of <var>url</var>, with its
  <span data-anolis-spec=url title=concept-url-scheme>scheme</span> set to
  "<code title>http</code>", if <var>url</var>'s
  <span data-anolis-spec=url title=concept-url-scheme>scheme</span> is "<code title>ws</code>", and
  to "<code title>https</code>" otherwise.

  <p class="note no-backref">This change of scheme is essential to integrate well with
  <span title=concept-fetch>fetching</span>. E.g., HSTS would not work without it. There is no real
  reason for WebSocket to have distinct schemes, it's a legacy artefact.
  <span data-anolis-ref>HSTS</span>

 <li><p>Let <var>request</var> be a new <span title=concept-request>request</span>, whose
 <span title=concept-request-url>url</span> is <var>url</var>,
 <span title=concept-request-client>client</span> is <var>client</var>,
 <span>skip-service-worker flag</span> is set,
 <span>synchronous flag</span> is set,
 <span title=concept-request-mode>mode</span> is "<code title>websocket</code>",
 <span title=concept-request-credentials-mode>credentials mode</span> is
 "<code title>include</code>",
 <span title=concept-cache-mode>cache mode</span> is "<code title>no-store</code>", and
 <span title=concept-request-redirect-mode>redirect mode</span> is "<code title>error</code>".

 <li><p><span title=concept-header-list-append>Append</span>
 `<code title=http-upgrade>Upgrade</code>`/`<code title>websocket</code>` to
 <var>request</var>'s <span title=concept-request-header-list>header list</span>.

 <li><p><span title=concept-header-list-append>Append</span>
 `<code title=http-connection>Connection</code>`/`<code title>Upgrade</code>` to
 <var>request</var>'s <span title=concept-request-header-list>header list</span>.

 <li>
  <p>Let <var>keyValue</var> be a nonce consisting of a randomly selected 16-byte value that has
  been base64-encoded (see <a href="https://tools.ietf.org/html/rfc4648#section-4">section 4</a> of
  <span data-anolis-ref>RFC4648</span>).

  <p id=example-random-value class=example>If the randomly selected value was the byte sequence 0x01
  0x02 0x03 0x04 0x05 0x06 0x07 0x08 0x09 0x0a 0x0b 0x0c 0x0d 0x0e 0x0f 0x10, <var>keyValue</var>
  would be `<code title>AQIDBAUGBwgJCgsMDQ4PEC==</code>`.

 <li><p><span title=concept-header-list-append>Append</span>
 `<code title=http-sec-websocket-key>Sec-WebSocket-Key</code>`/<var>keyValue</var> to
 <var>request</var>'s <span title=concept-request-header-list>header list</span>.

 <li><p><span title=concept-header-list-append>Append</span>
 `<code title=http-sec-websocket-version>Sec-WebSocket-Version</code>`/`<code title>13</code>` to
 <var>request</var>'s <span title=concept-request-header-list>header list</span>.

 <li><p>For each <var>protocol</var> in <var>protocols</var>,
 <span title=concept-header-list-combine>combine</span>
 `<code title=http-sec-websocket-protocol>Sec-WebSocket-Protocol</code>`/<var>protocol</var> in
 <var>request</var>'s <span title=concept-request-header-list>header list</span>.

 <li>
  <p>Let <var>permessageDeflate</var> be a user-agent defined
  "<code title>permessage-deflate</code>" extension <span title="concept-header">header</span>
  <span title="concept-header-value">value</span>. <span data-anolis-ref>WSP</span>

  <p id=example-permessage-deflate class=example>`<code title>permessage-deflate; client_max_window_bits</code>`

 <li><p><span title=concept-header-list-append>Append</span>
 `<code title=http-sec-websocket-extensions>Sec-WebSocket-Extensions</code>`/<var>permessageDeflate</var>
 to <var>request</var>'s <span title=concept-request-header-list>header list</span>.

 <li><p>Let <var>response</var> be the result of <span title=concept-fetch>fetching</span>
 <var>request</var>.

 <li><p>If <var>response</var> is a <span title=concept-network-error>network error</span> or its
 <span title=concept-response-status>status</span> is not <code title>101</code>,
 <span>fail the WebSocket connection</span>.

 <li>
  <p>If <var>protocols</var> is not the empty list and
  <span title="concept-header-parse">parsing</span>
  `<code title=http-sec-websocket-protocol>Sec-WebSocket-Protocol</code>` in <var>response</var>'s
  <span title=concept-request-header-list>header list</span> results in null, failure, or the empty
  byte sequence, <span>fail the WebSocket connection</span>.

  <p class="note">This is different from the check on this header defined by The WebSocket Protocol.
  That only covers a subprotocol not requested by the client. This covers a subprotocol requested by
  the client, but not acknowledged by the server.

 <li><p>Follow the requirements stated step 2 to step 6, inclusive, of the last set of steps in
 <a href="http://tools.ietf.org/html/rfc6455#section-4.1">section 4.1</a> of The WebSocket Protocol
 to validate <var>response</var>. This either results in <span>fail the WebSocket connection</span>
 or <span>the WebSocket connection is established</span>.
</ol>

<p><dfn>Fail the WebSocket connection</dfn> and <dfn>the WebSocket connection is established</dfn>
are defined by The WebSocket Protocol. <span data-anolis-ref>WSP</span>

<p class="warning">The reason redirects are not followed, HTTP authentication will not function, and
this handshake is generally restricted is because that could introduce serious security problems in
a web browser context. For example, consider a host with a WebSocket server at one path and an open
HTTP redirector at another. Suddenly, any script that can be given a particular WebSocket URL can be
tricked into communicating to (and potentially sharing secrets with) any host on the internet, even
if the script checks that the URL has the right hostname.
<!-- https://www.ietf.org/mail-archive/web/hybi/current/msg06951.html -->



<h2 id=background-reading class=no-num>Background reading</h2>

<p><em>This section and its subsections are informative only.</em>

<h3 class=no-num><dfn>HTTP header layer division</dfn></h3>

<p>For the purposes of fetching, there is an API layer (HTML's
<code title>img</code>, CSS' <code title>background-image</code>), early fetch layer,
service worker layer, and network &amp; cache layer.
`<code title=http-accept>Accept</code>` and
`<code title=http-accept-language>Accept-Language</code>` are set in the early fetch layer
(typically by the user agent). Most other headers controlled by the user agent, such as
`<code title=http-accept-encoding>Accept-Encoding</code>`,
`<code title=http-host>Host</code>`, and `<code title=http-referer>Referer</code>`, are
set in the network &amp; cache layer. Developers can set headers either at the API layer
or in the service worker layer (typically through a <code>Request</code> object).
Developers have almost no control over
<span title="forbidden header name">forbidden headers</span>, but can control
`<code title=http-accept>Accept</code>` and have the means to constrain and omit
`<code title=http-referer>Referer</code>` for instance.


<h3 id=atomic-http-redirect-handling class=no-num><dfn>Atomic HTTP redirect handling</dfn></h3>

<p>Redirects (a <span title=concept-response>response</span> whose
<span title=concept-response-status>status</span> or
<span title=concept-internal-response>internal response</span>'s (if any)
<span title=concept-response-status>status</span> is a <span>redirect status</span>) are not exposed
to APIs. Exposing redirects might leak information not otherwise available through a cross-site
scripting attack.

<p id=example-xss-redirect class=example>A fetch to <code>https://example.org/auth</code> that
includes a `<code title>Cookie</code>` marked `<code title>HttpOnly</code>` could result in a
redirect to <code>https://other-origin.invalid/4af955781ea1c84a3b11</code>. This new URL contains a
secret. If we expose redirects that secret would be available through a cross-site scripting attack.


<h3 id=basic-safe-cors-protocol-setup class=no-num>Basic safe CORS protocol setup</h3>

<p>For resources where data is protected through IP authentication or a firewall
(unfortunately relatively common still), using the <span>CORS protocol</span> is
<strong>unsafe</strong>. (This is the reason why the <span>CORS protocol</span> had to be
invented.)

<p>However, otherwise using the following <span title=concept-header>header</span> is
<strong>safe</strong>:

<pre>Access-Control-Allow-Origin: *</pre>

<p>Even if a resource exposes additional information based on cookie or HTTP
authentication, using the above <span title=concept-header>header</span> will not reveal
it. It will share the resource with APIs such as
<code data-anolis-spec=xhr>XMLHttpRequest</code>, much like it is already shared with
<code title>curl</code> and <code title>wget</code>.

<p>Thus in other words, if a resource cannot be accessed from a random device connected to
the web using <code title>curl</code> and <code title>wget</code> the aforementioned
<span title=concept-header>header</span> is not to be included. If it can be accessed
however, it is perfectly fine to do so.


<h3 id=cors-protocol-and-http-caches class=no-num>CORS protocol and HTTP caches</h3>

<p>If <span>CORS protocol</span> requirements are more complicated than setting
`<code title=http-access-control-allow-origin>Access-Control-Allow-Origin</code>` to
<code title>*</code> or a static <span data-anolis-spec=html>origin</span>,
`<code title>Vary</code>` is to be used.
<span data-anolis-ref>HTML</span>
<span data-anolis-ref>HTTP</span>

<pre id=example-vary-origin class=example>Vary: Origin</pre>



<h2 class=no-num>References</h2>
<div id=anolis-references></div>



<h2 id=acknowledgments class=no-num>Acknowledgments</h2>

<p>Thanks to
Adam Barth,
Adam Lavin,
Alexey Proskuryakov,
Andrew Sutherland,
Ángel González,
Anssi Kostiainen,
Arkadiusz Michalski,
Arne Johannessen,
Arthur Barstow,
Axel Rauschmayer,
Ben Kelly,
Benjamin Hawkes-Lewis,
Bert Bos,
Bj&ouml;rn H&ouml;hrmann,
Boris Zbarsky,
Brad Hill,
Brad Porter,
Bryan Smith,
Caitlin Potter,
Cameron McCormack,
Clement Pellerin,
Collin Jackson,
Daniel Robertson,
Daniel Veditz,
David H&aring;s&auml;ther,
David Orchard,
Domenic Denicola,
Dean Jackson,
Doug Turner,
Ehsan Akhgari,
Emily Stark,
Eric Lawrence,
Fran&ccedil;ois Marier,
Frank Ellerman,
Frederick Hirsch,
Gavin Carothers,
Glenn Maynard,
Graham Klyne,
Hal Lockhart,
Hallvord R. M. Steen,
Henri Sivonen,
Hiroshige Hayashizaki,
Honza Bambas,
Ian Hickson,
Ilya Grigorik,
Jake Archibald<!-- technically B.J. Archibald -->,
James Graham,
Janusz Majnert,
Jeena Lee,
Jeff Carpenter,
Jeff Hodges,
Jeffrey Yasskin,
Jesse M. Heines,
Jochen Eisinger,
Jonas Sicking,
Jonathan Kingston,
Jonathan Watt,
최종찬 (Jongchan Choi),
Jörn Zaefferer,
Josh Matthews,
Julian Krispel-Samsel,
Julian Reschke,
송정기 (Jungkee Song),
Jussi Kalliokoski,
Jxck,
Keith Yeung,
Kenji Baheux,
Lachlan Hunt,
Liam Brummitt,
Louis Ryan,
Lucas Gonze,
呂康豪 (Kang-Hao Lu),
Maciej Stachowiak,
Malisa<!-- malisas; GitHub -->,
Manfred Stock,
Manish Goregaokar,
Marc Silbey,
Marcos Caceres,
Marijn Kruisselbrink,
Mark Nottingham,
Mark S. Miller,
Martin D&uuml;rst,
Matt Andrews,
Matt Falkenhagen,
Matt Oshry,
Matt Womer,
Mhano Harkness,
Michael Kohler,
Michael™ Smith,
Mike West,
Mohamed Zergaoui,
Ms2ger,
Nico Schlömer,
Nikhil Marathe,
Nikki Bee,
Nikunj Mehta,
Odin H&oslash;rthe Omdal,
Ondřej Žára,
Philip Jägenstedt,
R. Auburn,
Ryan Sleevi,
Rory Hewitt,
Sébastien Cevey,
Sendil Kumar N,
Shao-xuan Kang,
Sharath Udupa,
Shivakumar Jagalur Matt,
Simon Pieters,
Srirama Chandra Sekhar Mogali,
Steven Salat,
Sunava Dutta,
Surya Ismail,
吉野剛史 (Takeshi Yoshino),
Thomas Roessler,
Thomas Wisniewski,
Tobie Langel,
Tom Schuster,
Tomás Aparicio,
保呂毅 (Tsuyoshi Horo),
Tyler Close,
Vignesh Shanmugam,
Vladimir Dzhuvinov,
Wayne Carr,
Xabier Rodríguez,
Yoav Weiss,
Youenn Fablet<!-- youennf; GitHub -->,
平野裕 (Yutaka Hirano), and
Zhenbin Xu
for being awesome.

<p>This standard is written by
<a lang=nl href=https://annevankesteren.nl/>Anne van Kesteren</a>
(<a href=https://www.mozilla.org/>Mozilla</a>,
<a href=mailto:annevk@annevk.nl>annevk@annevk.nl</a>).

<p>Per <a rel=license href=https://creativecommons.org/publicdomain/zero/1.0/>CC0</a>, to
the extent possible under law, the editor has waived all copyright and related or
neighboring rights to this work.
