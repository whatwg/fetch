<!doctype html>
<html lang="en-US">
 <head>
  <meta charset=utf-8>
  <title>Cross-Origin Resource Sharing Standard</title>
  <link rel=stylesheet href=//www.whatwg.org/style/specification>
  <link rel=icon href=//www.whatwg.org/images/icon>
 </head>
 <body>
  <div class="head">

   <h1 id="cors">Cross-Origin Resource Sharing</h1>

   <h2 class="no-num no-toc">Living Standard &mdash; Last Updated [DATE: 3 August 2002]</h2>

   <dl>
    <dt>This Version:</dt>
    <dd><a href=//fetch.spec.whatwg.org/>http://fetch.spec.whatwg.org/</a></dd>
    <dd class=publish><a href="[VERSION]">[VERSION]</a></dd>

  <dt>Participate:</dt>
  <dd>Send feedback to <a href="mailto:public-webappsec@w3.org?subject=[cors]%20">public-webappsec@w3.org</a>
  (<a href="http://lists.w3.org/Archives/Public/public-webappsec/">archives</a>) or
  <a href="https://www.w3.org/Bugs/Public/enter_bug.cgi?product=WebAppsSec&amp;component=CORS">file a bug</a>
  (<a href="https://www.w3.org/Bugs/Public/buglist.cgi?product=WebAppsSec&amp;component=CORS&amp;resolution=---">open bugs</a>)
  <dd class=dontpublish><a href=//wiki.whatwg.org/wiki/IRC>IRC: #whatwg on Freenode</a>

  <dt>Version History:
  <dd><a href=https://github.com/whatwg/fetch/commits>https://github.com/whatwg/fetch/commits</a>

    <dt>Editor:</dt>
    <dd><a href="http://annevankesteren.nl/">Anne van Kesteren</a>
    &lt;<a href="mailto:annevk@annevk.nl">annevk@annevk.nl</a>></dd>
   </dl>

<script src=//dvcs.w3.org/hg/quirks-mode/raw-file/tip/file-bug.js async></script>

<p class=copyright><a rel=license href="http://creativecommons.org/publicdomain/zero/1.0/"><img src="http://i.creativecommons.org/p/zero/1.0/80x15.png" alt=CC0></a>
To the extent possible under law, the editor has waived all copyright and
related or neighboring rights to this work. In addition, as of
[DATE: 01 Jan 1901], the editor has made this specification available
under the
<a rel=license
href="http://www.openwebfoundation.org/legal/the-owf-1-0-agreements/owfa-1-0">Open Web Foundation Agreement Version 1.0</a>,
which is available at
http://www.openwebfoundation.org/legal/the-owf-1-0-agreements/owfa-1-0.

</div>



<p class=XXX>This specification ought to be merged with
<span data-anolis-spec=html title=fetch>HTML fetch</span>. If you are
interested in making that happen please contact the editor.



<h2 class="no-num no-toc" id="abstract">Abstract</h2>

  <p>This document defines a mechanism to enable client-side cross-origin
  requests. Specifications that enable an API to make cross-origin requests
  to resources can use the algorithms defined by this specification. If
  such an API is used on <code>http://example.org</code> resources, a
  resource on <code>http://hello-world.example</code> can opt in using the
  mechanism described by this specification (e.g., specifying
  <code>Access-Control-Allow-Origin: http://example.org</code> as response
  header), which would allow that resource to be fetched cross-origin from
  <code>http://example.org</code>.</p>



  <h2 class="no-num no-toc" id="toc">Table of Contents</h2>

  <!-- toc -->




  <h2 id="introduction">Introduction</h2>

  <p><em>This section is non-normative.</em></p>

  <p>User agents commonly apply same-origin restrictions to network
  requests. These restrictions prevent a client-side Web application
  running from one origin from obtaining data retrieved from another origin,
  and also limit unsafe HTTP requests that can be automatically launched
  toward destinations that differ from the running application's origin.</p>

  <p>In user agents that follow this pattern, network requests typically use
  ambient authentication and session management information, including HTTP
  authentication and cookie information.</p>

  <p>This specification extends this model in several ways:

  <ul>
   <li>
    <p>A response can include an
    <code title=http-access-control-allow-origin>Access-Control-Allow-Origin</code>
    header, with the origin of where the request originated from as the
    value, to allow access to the resource's contents.</p>

    <p>The user agent validates that the value and origin of where the
    request originated match.</p>
   </li>

   <li>
    <p>User agents can discover via a <span>preflight request</span> whether
    a cross-origin resource is prepared to accept requests, using a
    non-<span>simple method</span>, from a given origin.</p>

    <p>This is again validated by the user agent.</p>
   </li>

   <li>
    <p>Server-side applications are enabled to discover that an HTTP request
    was deemed a cross-origin request by the user agent, through the
    <code title="http-origin">Origin</code> header.</p>

    <p>This extension enables server-side applications to enforce
    limitations (e.g. returning nothing) on the cross-origin requests that
    they are willing to service.</p>
   </li>
  </ul>

  <p>This specification is a building block for other specifications,
  so-called CORS API specifications, which define how this specification is
  used. Examples are Server-Sent Events and XMLHttpRequest.
  <span data-anolis-ref class=informative>EVENTSOURCE</span>
  <span data-anolis-ref class=informative>XHR</span>

  <p>The <a href="http://www.w3.org/wiki/CORS">CORS wiki page</a> provides
  more background information about this document.</p>

  <div class="example">
   <p>If a resource author has a simple text resource residing at
   <code>http://example.com/hello</code> which contains the string
   "Hello World!" and would like <code>http://hello-world.example</code> to
   be able to access it, the response combined with a header
   introduced by this specification could look as follows:</p>

   <pre><code>Access-Control-Allow-Origin: http://hello-world.example

Hello World!</code></pre>

   <p>Using <code data-anolis-spec=xhr>XMLHttpRequest</code> a client-side
   Web application on <code>http://hello-world.example</code> can access
   this resource as follows:

   <pre><code>var client = new XMLHttpRequest()
client.open("GET", "http://example.com/hello")
client.onreadystatechange = function() { /* do something */ }
client.send()</code></pre>

   <p>It gets slightly more complicated if the resource author wants to be
   able to handle cross-origin requests using methods other than
   <span title="simple method">simple methods</span>. In that case
   the author needs to reply to a preflight request that uses the
   <code>OPTIONS</code> method and then needs to handle the actual request
   that uses the desired method (<code>DELETE</code> in this example) and
   give an appropriate response. The response to the preflight request could
   have the following headers specified:</p>

   <pre><code>Access-Control-Allow-Origin: http://hello-world.example
Access-Control-Max-Age: 3628800
Access-Control-Allow-Methods: PUT, DELETE</code></pre>

   <p>The
   <code title=http-access-control-max-age>Access-Control-Max-Age</code>
   header indicates how long the response can be cached, so that for
   subsequent requests, within the specified time, no preflight request has
   to be made. The
   <code title=http-access-control-allow-methods>Access-Control-Allow-Methods</code>
   header indicates the methods that can be used in the actual request. The
   response to the actual request can simply contain this header:</p>

   <pre><code>Access-Control-Allow-Origin: http://hello-world.example</code></pre>

   <p>The complexity of invoking the additional preflight request is
   the task of the user agent. Using
   <code data-anolis-spec=xhr>XMLHttpRequest</code> again and assuming the
   application were hosted at <code>http://calendar.example/app</code> the
   author could use the following ECMAScript snippet:

   <pre><code>function deleteItem(itemId, updateUI) {
  var client = new XMLHttpRequest()
  client.open("DELETE", "http://calendar.example/app")
  client.onload = updateUI
  client.onerror = updateUI
  client.onabort = updateUI
  client.send("id=" + itemId)
}</code></pre>
  </div>




  <h2 id="conformance">Conformance</h2>

  <p>This specification is written for resource authors and user agents. It
  includes advice for specifications that define APIs that use the
  <span>cross-origin request</span> algorithm defined in this specification
  &mdash; CORS API specifications &mdash; and the general
  <a href="#security">security considerations</a> section includes some
  advice for client-side Web application authors.</p>

  <p>As well as sections and appendices marked as non-normative, all
  diagrams, examples, and notes in this specification are non-normative.
  Everything else in this specification is normative.</p>

  <p>In this specification, The words must and
  may are to be interpreted as described in RFC 2119.
  <span data-anolis-ref>RFC2119</span></p>

  <p>Requirements phrased in the imperative as part of algorithms (e.g.
  "terminate the algorithm") are to be interpreted with the meaning of the
  key word (e.g. must) used in introducing the
  algorithm.</p>

  <p>A conformant resource is one that implements all the requirements
  listed in this specification that are applicable to resources.</p>

  <p>A conformant user agent is one that implements all the requirements
  listed in this specification that are applicable to user agents.</p>

  <p>User agents and resource authors may employ any
  algorithm to implement this specification, so long as the end result is
  indistinguishable from the result that would be obtained by the
  specification's algorithms.</p>


  <h2>Terminology</h2>

  <p>Some terminology in this specification is from
  <cite>The Web Origin Concept</cite>
  <cite>HTML</cite>,<!--fetch-->
  <cite>HTTP</cite>
  and
  <cite>URI</cite>.
  <span data-anolis-ref>ORIGIN</span>
  <span data-anolis-ref>HTML</span>
  <span data-anolis-ref>HTTP</span>
  <span data-anolis-ref>URI</span>

  <p>Terminology is generally defined throughout the specification. However,
  the few definitions that did not really fit anywhere else are defined here
  instead.</p>

  <!-- These definitions are copies of those in HTML and DOM Core.
       XXX should they be in a separate document? -->

  <p>Comparing two strings in a
  <dfn id="case-sensitive">case-sensitive</dfn> manner means comparing them
  exactly, codepoint for codepoint.</p>

  <p>Comparing two strings in an
  <dfn id="ascii-case-insensitive">ASCII case-insensitive</dfn> manner means
  comparing them exactly, codepoint for codepoint, except that the
  characters in the range U+0041 LATIN CAPITAL LETTER A to U+005A
  LATIN CAPITAL LETTER Z and the corresponding characters in the range
  U+0061 LATIN SMALL LETTER A to U+007A LATIN SMALL LETTER Z are
  considered to also match.</p>

  <p><dfn id="converted-to-ascii-lowercase" title="converted to ASCII lowercase">Converting a string to ASCII lowercase</dfn>
  means replacing all characters in the range U+0041 LATIN CAPITAL LETTER A
  to U+005A LATIN CAPITAL LETTER Z with the corresponding characters in the
  range U+0061 LATIN SMALL LETTER A to U+007A LATIN SMALL LETTER Z).</p>

  <p>The term <dfn>user credentials</dfn> for the purposes of this
  specification means cookies, HTTP authentication, and client-side SSL
  certificates. Specifically it does not refer to proxy authentication or
  the <code title="http-origin">Origin</code> header.
  <span data-anolis-ref>COOKIES</span><!-- XXX ref? --></p>

  <p>The term <dfn id="cross-origin">cross-origin</dfn> is used to mean non
  <span data-anolis-spec=origin>same origin</span>.</p>

  <p>A <var title>method</var> is said to be a
  <dfn id="simple-method">simple method</dfn> if it is a
  <span>case-sensitive</span> match for one of the following:</p>

  <ul>
   <li><code>GET</code></li>
   <li><code>HEAD</code></li>
   <li><code>POST</code></li>
  </ul>

  <p>A <var title>header</var> is said to be a
  <dfn>simple header</dfn> if the header field name is an
  <span>ASCII case-insensitive</span> match for <code>Accept</code>,
  <code>Accept-Language</code>, or <code>Content-Language</code>, or if it
  is an <span>ASCII case-insensitive</span> match for
  <code>Content-Type</code> and the header field value media type (excluding
  parameters) is an <span>ASCII case-insensitive</span> match for
  <code>application/x-www-form-urlencoded</code>,
  <code>multipart/form-data</code>, or <code>text/plain</code>.</p>

  <!-- XXX there is an email complaining about the parameters -->

  <p>A <var title>header</var> is said to be a
  <dfn>simple response header</dfn> if the
  header field name is an <span>ASCII case-insensitive</span> match for one
  of the following:</p>

  <ul>
   <li><code>Cache-Control</code></li>
   <li><code>Content-Language</code></li>
   <li><code>Content-Type</code></li>
   <li><code>Expires</code></li>
   <li><code>Last-Modified</code></li>
   <li><code>Pragma</code></li>
  </ul>

  <p>When
  <dfn title="header parsing">parsing a header</dfn> the
  header must be parsed per the corresponding ABNF
  production in the <a href="#syntax">syntax</a> section. If the header does
  not match the production it is said that
  <dfn>header parsing failed</dfn>.</p>




  <h2 id="security">Security Considerations</h2>

  <p><em>This section is non-normative.</em></p>

  <p>Security requirements and considerations are listed throughout this
  specification. This section lists advice that did not fit anywhere
  else.</p>

  <hr>

<p>A <span>simple cross-origin request</span> has been defined as congruent
with those which may be generated by currently deployed user agents that do
not conform to this specification. Simple cross-origin requests generated
outside this specification (such as cross-origin form submissions using
<code>GET</code> or <code>POST</code> or cross-origin <code>GET</code>
requests resulting from <code>script</code> elements) typically include
<span>user credentials</span>, so resources conforming to this specification
must always be prepared to expect simple cross-origin requests with
credentials.

<p>Because of this, resources for which simple requests have significance
other than retrieval must protect themselves from Cross-Site Request Forgery
(CSRF)
by requiring the inclusion of an unguessable token in the explicitly
provided content of the request.
<span data-anolis-ref class=informative>CSRF</span>

<p>This specification defines how to authorize an instance of an application
from a foreign origin, executing in the user agent, to access the
representation of the resource in an HTTP response. Certain types of
resources should not attempt to specify particular authorized origins, but
instead either deny or allow all origins.

<ol>
 <li><p>A resource that is not useful to applications from other origins, such as a login page, ought not to return an
 <code title=http-access-control-allow-origin>Access-Control-Allow-Origin</code>
 header. The resource still must protect itself against CSRF attacks, such
 as by requiring the inclusion of an unguessable token in the explicitly
 provided content of the request. The security properties of such resources
 are unaffected by user-agents conformant to this specification.

 <li>
  <p>A resource that is publicly accessible, with no access control checks,
  can always safely return an
  <code title=http-access-control-allow-origin>Access-Control-Allow-Origin</code>
  header whose value is "<code>*</code>".

 <li><p>A <code>GET</code> response whose entity body happens to parse as
 ECMAScript can return an
 <code title=http-access-control-allow-origin>Access-Control-Allow-Origin</code>
 header whose value is "<code>*</code>" provided there are no sensitive
 comments as it can be accessed cross-origin using an HTML
 <code>script</code> element. If needed, such resources can implement access
 control and CSRF protections as described above.
</ol>

<p>Care must always be taken by applications when making cross-origin
requests with <span>user credentials</span>, and servers processing such
requests must take care in the use of credentials, including the
<code title=http-origin>Origin</code> header.

<ol>
 <li>
  <p>When requests have significance other than retrieval, and when relying on the <code title=http-origin>Origin</code> header as a credential, servers must be careful to distinguish between authorizing a request and authorizing access to the representation of that resource in the response.

  <ol>
   <li><p>Authorization for a request should be performed using only the intersection of the authority of the user and the requesting origin(s).  In the case of redirects, more than one value for
   <code title=http-origin>Origin</code> may be present and all must be authorized.

   <li><p>Servers using the <code title=http-origin>Origin</code> header to
   authorize requests are encouraged to also verify that the
   <code title=http-host>Host</code> header matches its expected value to
   prevent forwarding attacks. Consider two sites, <code>corp.example</code>
   and <code>corp.invalid</code>. A web application at
   <code>corp.example</code> makes a cross-origin request to
   <code>corp.invalid</code>, and the user agent sends the
   <code title=http-origin>Origin</code> header <code>corp.example</code>.
   If <code>corp.invalid</code> or the network is malicious, it may cause
   the request to be delivered to <code>corp.example</code>, with the result
   that <code>corp.example</code> would receive a request that appears to
   originate from itself.  Verifying the <code title=http-host>Host</code>
   header would reveal that the user agent intended the request for
   <code>corp.invalid</code> and it can be discarded. Even better would be
   to exclusively use secure connections for cross-origin requests to enable
   user agents to detect such misdirections.

   <li><p>It is often appropriate for servers to require an authorization ceremony asking a user to consent that cross-origin requests with credentials be honored from a given origin.  In such cases, passing security tokens explicitly as part of the cross-origin request can remove any ambiguity as to the scope of authorization. OAuth is an example of this pattern.
   <span data-anolis-ref class=informative>OAUTH</span>
  </ol>

 <li>
  <p>Use of <span>user credentials</span> in a cross-origin request is
  appropriate when:

  <ol>
   <li>
    <p>A cross-origin request with credentials as defined in this
    specification is used to substitute for alternate methods of
    authenticated resource sharing, such as server-to-server back channels,
    JSONP, or cross-document messaging.
    <span data-anolis-ref class=informative>JSONP</span>
    <span data-anolis-ref class=informative>HTML</span>

    <p>This substitution can expose additional attack surface in some cases,
    as a cross-site scripting vulnerability in the requesting origin can
    allow elevation of privileges against the requested resource when
    compared to a server-to-server back channel.

    <p>As a substitute for JSONP-style cross-origin credentialed requests,
    use of this specification significantly improves the security posture of
    the requesting application, as it provides cross-origin data access
    whereas JSONP operates via cross-origin code-injection. The requesting
    application has to validate that data received from origins that are not
    completely trusted conforms to expected formats and authorized values.

    <p>As a substitute for cross-origin communication techniques relying on loading a resource, with credentials, into an HTML <code>iframe</code> element, and subsequently employing cross-document messaging or other cross-origin side channels, this specification provides a roughly equivalent security posture. Again, data received from origins that are not completely trusted has to be validated to conform to expected formats and authorized values.

   <li><p>For resources that are safe and idempotent per HTTP, and where the credentials are used only to provide user-specific customization for otherwise publicly accessible information. In this case, restricting access to certain origins may protect user privacy by preventing customizations from being used to identify a user, except at authorized origins.
  </ol>

 <li>
  <p>When this specification is used for requests which have significance
  other than retrieval and which involve coordination between or data
  originating from more than two origins, (e.g. between resources enabling
  editing, printing and storage, each at distinct origins) requests ought to
  set the <span>omit credentials flag</span> and servers ought to
  perform authorization using security tokens explicitly provided in the
  content of the request, especially if the origins are not all mutually and
  completely trusted.

  <p>In such multi-origin scenarios, a malicious resource at one of the
  origins may be able to enlist the user-agent as a confused deputy and
  elevate its privileges by abusing the user's ambient authority. Avoiding
  such attacks requires that the coordinating applications have explicit
  knowledge of the scope of privilege for each origin and that all
  parameters and instructions received are carefully validated at each step
  in the coordination to ensure that effects implied do not exceed the
  authority of the originating principal.
  <span data-anolis-ref class=informative>CONFUSED</span>

  <p>Given the difficulty of avoiding such vulnerabilities in multi-origin
  interactions it is recommended that, instead of using implicit
  credentials, security tokens which specify the particular capabilities and
  resources authorized be passed explicitly as part of each request.
  OAuth again provides an example of such a pattern.
</ol>

  <hr>

  <p>Authors of client-side Web applications are strongly encouraged to
  validate content retrieved from a <span>cross-origin</span> resource as it
  might be harmful.</p>

  <p>Authors of client-side Web applications using a URL of the type
  <code>people.example.org/~<var>author-name</var>/</code> are to be aware
  that security is only provided <span>cross-origin</span> and that
  therefore using a distinct <span data-anolis-spec=origin>origin</span>
  rather than distinct path is vital for secure client-side Web
  applications.</p>




  <h2 id="syntax">Syntax</h2>

  <p>This section defines the syntax of the new headers this specification
  introduces. It also provides a short description of the function of each
  header.</p>

  <p>The <a href="#resource-processing-model">resource processing model</a>
  section details how resources are to use these headers in a response.
  Likewise, the
  <a href="#user-agent-processing-model">user agent processing model</a>
  section details how user agents are to use these headers.</p>

  <p>The ABNF syntax used in this section is from HTTP/1.1.
  <span data-anolis-ref>HTTP</span></p>

  <p class=note>HTTP/1.1 is used as ABNF basis to ensure that the new
  headers have equivalent parsing rules to those introduced in that
  specification.</p>

  <p class="XXX">HTTP/1.1 currently does not make leading OWS implied in
  header value definitions so please assume it is for now.</p>

  <h3><code title>Access-Control-Allow-Origin</code> Response Header</h3>

  <p>The
  <dfn title=http-access-control-allow-origin><code>Access-Control-Allow-Origin</code></dfn>
  header indicates whether a resource can be shared based by returning the
  value of the <code title="http-origin">Origin</code> request header in the
  response. ABNF:</p>

  <pre>Access-Control-Allow-Origin = "Access-Control-Allow-Origin" ":" <span data-anolis-spec=origin>origin-list-or-null</span> | "*"</pre>

  <p class=note>In practice the
  <code data-anolis-spec=origin>origin-list-or-null</code> production is
  more constrained. Rather than allowing a space-separated list of
  <span data-anolis-spec=origin title=origin>origins</span>, it is either a
  single <span data-anolis-spec=origin>origin</span> or the string
  "<code title>null</code>".
  <!-- serialized-origin / %x6E %x75 %x6C %x6C / "*" -->


  <h3><code title>Access-Control-Allow-Credentials</code> Response Header</h3>

  <p>The
  <dfn title=http-access-control-allow-credentials><code>Access-Control-Allow-Credentials</code></dfn>
  header indicates whether the response to request can be
  exposed when the <span>omit credentials flag</span> is unset. When part
  of the response to a <span>preflight request</span> it indicates that the
  <span>actual request</span> can include <span>user credentials</span>.
  ABNF:</p>

  <pre>Access-Control-Allow-Credentials: "Access-Control-Allow-Credentials" ":" true
                            true: %x74.72.75.65 ; "true", case-sensitive</pre>


  <h3><code title>Access-Control-Expose-Headers</code> Response Header</h3>

  <p>The
  <dfn title=http-access-control-expose-headers><code>Access-Control-Expose-Headers</code></dfn>
  header indicates which headers are safe to expose to the API of a
  CORS API specification. ABNF:</p>

  <pre>Access-Control-Expose-Headers = "Access-Control-Expose-Headers" ":" #<span data-anolis-spec=http>field-name</span></pre>


  <h3><code title>Access-Control-Max-Age</code> Response Header</h3>

  <p>The
  <dfn title=http-access-control-max-age><code>Access-Control-Max-Age</code></dfn>
  header indicates how long the results of a <span>preflight request</span>
  can be cached in a <span>preflight result cache</span>. ABNF:</p>

  <pre>Access-Control-Max-Age = "Access-Control-Max-Age" ":" <span data-anolis-spec=http>delta-seconds</span></pre>


  <h3><code title>Access-Control-Allow-Methods</code> Response Header</h3>

  <p>The
  <dfn title=http-access-control-allow-methods><code>Access-Control-Allow-Methods</code></dfn>
  header indicates, as part of the response to a
  <span>preflight request</span>, which methods can be used during the
  <span>actual request</span>. ABNF:</p>

  <pre>Access-Control-Allow-Methods: "Access-Control-Allow-Methods" ":" #<span data-anolis-spec=http>Method</span></pre>



  <h3><code title>Access-Control-Allow-Headers</code> Response Header</h3>

  <p>The
  <dfn title=http-access-control-allow-headers><code>Access-Control-Allow-Headers</code></dfn>
  header indicates, as part of the response to a
  <span>preflight request</span>, which header field names can be used
  during the <span>actual request</span>. ABNF:</p>

  <pre>Access-Control-Allow-Headers: "Access-Control-Allow-Headers" ":" #<span data-anolis-spec=http>field-name</span></pre>


  <h3><code title>Origin</code> Request Header</h3>

  <p>The
  <dfn title="http-origin"><code>Origin</code></dfn>
  header indicates where the <span>cross-origin request</span> or
  <span>preflight request</span> originates from.
  <span data-anolis-ref>ORIGIN</span></p>


  <h3><code title>Access-Control-Request-Method</code> Request Header</h3>

  <p>The
  <dfn title=http-access-control-request-method><code>Access-Control-Request-Method</code></dfn>
  header indicates which method will be used in the
  <span>actual request</span> as part of the
  <span>preflight request</span>. ABNF:</p>

  <pre>Access-Control-Request-Method: "Access-Control-Request-Method" ":" <span data-anolis-spec=http>Method</span></pre>


  <h3><code title>Access-Control-Request-Headers</code> Request Header</h3>

  <p>The
  <dfn title=http-access-control-request-headers><code>Access-Control-Request-Headers</code></dfn>
  header indicates which headers will be used in the
  <span>actual request</span> as part of the
  <span>preflight request</span>. ABNF:</p>

  <pre>Access-Control-Request-Headers: "Access-Control-Request-Headers" ":" #<span data-anolis-spec=http>field-name</span></pre>




  <h2 id="resource-processing-model">Resource Processing Model</h2>

  <!-- XXX
  <p><em>This section only applies to servers.</em></p>
  -->

  <p>This section describes the processing models that resources have to
  implement. Each type of request a resource might have to deal with is
  described in its own subsection.</p>

  <p>The resource sharing policy described by this specification is bound to
  a particular resource. For the purposes of this section each resource is
  bound to the following:</p>

  <ul>
   <li>
    <p>A <dfn>list of origins</dfn> consisting of zero or more
    <span data-anolis-spec=origin title=origin>origins</span> that are
    allowed access to the resource.</p>

    <p class=note>This can include the
    <span data-anolis-spec=origin>origin</span> of the resource itself
    though be aware that requests to <span>cross-origin</span> resources can
    be redirected back to the resource.</p>
   </li>

   <li><p>A <dfn>list of methods</dfn> consisting of zero or more methods
   that are supported by the resource.</p></li>

   <li><p>A <dfn>list of headers</dfn> consisting of zero or more header
   field names that are supported by the resource.</p></li>

   <li><p>A <dfn>list of exposed headers</dfn> consisting of zero or more
   header field names of headers other than the
   <span title="simple response header">simple response headers</span> that the resource might use and can be exposed.</p></li>

   <li><p>A <dfn>supports credentials</dfn> flag that indicates whether the
   resource supports <span>user credentials</span> in the request. It is
   true when the resource does and false otherwise.</p></li>
  </ul>


  <h3 id="resource-requests">Simple Cross-Origin Request, Actual Request, and
  Redirects</h3>

  <p>In response to a <span>simple cross-origin request</span> or
  <span>actual request</span> the resource indicates whether or not to share
  the response.</p>

  <p>If the resource has been relocated, it indicates whether to share
  its new <span data-anolis-spec=html>URL</span>.</p>

  <p>Resources must use the following set of steps to
  determine which additional headers to use in the response:</p>

  <ol>
   <li><p>If the <code title="http-origin">Origin</code> header is not
   present terminate this set of steps. The request is outside the scope of
   this specification.</p></li>

   <li>
    <p>If the value of the <code title="http-origin">Origin</code>
    header is not a <span>case-sensitive</span> match for any of the values
    in <span>list of origins</span>, do not set any additional headers and
    terminate this set of steps.</p>

    <p class=note>Always matching is acceptable since the
    <span>list of origins</span> can be unbounded.</p>
   </li>

   <li>
    <p>If the resource <span>supports credentials</span> add a single
    <code title=http-access-control-allow-origin>Access-Control-Allow-Origin</code>
    header, with the value of the <code title="http-origin">Origin</code>
    header as value, and add a single
    <code title=http-access-control-allow-credentials>Access-Control-Allow-Credentials</code>
    header with the <span>case-sensitive</span> string
    "<code title>true</code>" as value.</p>

    <p>Otherwise, add a single
    <code title=http-access-control-allow-origin>Access-Control-Allow-Origin</code>
    header, with either the value of the
    <code title="http-origin">Origin</code> header or the string
    "<code title>*</code>" as value.</p>

    <p class=note>The string "<code title>*</code>" cannot be used for a
    resource that <span>supports credentials</span>.</p>
   </li>

   <li><p>If the <span>list of exposed headers</span> is not empty add one
   or more
   <code title=http-access-control-expose-headers>Access-Control-Expose-Headers</code>
   headers, with as values the header field names given in the
   <span>list of exposed headers</span>.</p></li>
  </ol>

  <p class=note>By not adding the appropriate headers resource can also
  clear the <span>preflight result cache</span> of all entries where
  <span title="cache-origin">origin</span> is a <span>case-sensitive</span>
  match for the value of the <code title="http-origin">Origin</code>
  header and <span title="cache-url">url</span> is a
  <span>case-sensitive</span> match for the
  <span data-anolis-spec=html>URL</span> of the
  resource.</p>


  <h3 id="resource-preflight-requests">Preflight Request</h3>

  <p>In response to a <span>preflight request</span> the resource indicates
  which methods and headers (other than
  <span title="simple method">simple methods</span> and
  <span title="simple header">simple headers</span>) it is willing to handle
  and whether it <span>supports credentials</span>.</p>

  <p>Resources must use the following set of steps to
  determine which additional headers to use in the response:</p>

  <ol>
   <li><p>If the <code title="http-origin">Origin</code> header is not
   present terminate this set of steps. The request is outside the scope of
   this specification.</p></li>

   <li>
    <p>If the value of the <code title="http-origin">Origin</code>
    header is not a <span>case-sensitive</span> match for any of the
    values in <span>list of origins</span> do not set any additional headers
    and terminate this set of steps.</p>

    <p class=note>Always matching is acceptable since the
    <span>list of origins</span> can be unbounded.</p>

    <p class=note>The <code title="http-origin">Origin</code> header can
    only contain a single <span data-anolis-spec=origin>origin</span> as the
    user agent will not follow redirects.</p>
   </li>

   <li>
    <p>Let <var title>method</var> be the value as result of
    <span title="header parsing">parsing</span> the
    <code title=http-access-control-request-method>Access-Control-Request-Method</code>
    header.</p>

    <p>If there is no
    <code title=http-access-control-request-method>Access-Control-Request-Method</code>
    header or if <span title="header parsing failed">parsing failed</span>,
    do not set any additional headers and terminate this set of steps. The
    request is outside the scope of this specification.</p>
   </li>

   <li>
    <p>Let <var title>header field-names</var> be the values as result of
    <span title="header parsing">parsing</span> the
    <code title=http-access-control-request-headers>Access-Control-Request-Headers</code>
    headers.</p>

    <p>If there are no
    <code title=http-access-control-request-headers>Access-Control-Request-Headers</code>
    headers let <var title>header field-names</var> be the empty list.

    <p>If <span title="header parsing failed">parsing failed</span> do not
    set any additional headers and terminate this set of steps. The request
    is outside the scope of this specification.</p>
   </li>

   <li>
    <p>If <var title>method</var> is not a <span>case-sensitive</span>
    match for any of the values in <span>list of methods</span> do not set
    any additional headers and terminate this set of steps.</p>

    <p class=note>Always matching is acceptable since the
    <span>list of methods</span> can be unbounded.</p>
   </li>

   <li>
    <p>If any of the <var title>header field-names</var> is not a
    <span>ASCII case-insensitive</span> match for any of the values in
    <span>list of headers</span> do not set any additional headers and
    terminate this set of steps.</p>

    <p class=note>Always matching is acceptable since the
    <span>list of headers</span> can be unbounded.</p>
   </li>

   <li>
    <p>If the resource <span>supports credentials</span> add a single
    <code title=http-access-control-allow-origin>Access-Control-Allow-Origin</code>
    header, with the value of the <code title="http-origin">Origin</code>
    header as value, and add a single
    <code title=http-access-control-allow-credentials>Access-Control-Allow-Credentials</code>
    header with the <span>case-sensitive</span> string
    "<code title>true</code>" as value.</p>

    <p>Otherwise, add a single
    <code title=http-access-control-allow-origin>Access-Control-Allow-Origin</code>
    header, with either the value of the
    <code title="http-origin">Origin</code> header or the string
    "<code title>*</code>" as value.</p>

    <p class=note>The string "<code title>*</code>" cannot be used for a
    resource that <span>supports credentials</span>.</p>
   </li>

   <li><p>Optionally add a single
   <code title=http-access-control-max-age>Access-Control-Max-Age</code>
   header with as value the amount of seconds the user agent is allowed to
   cache the result of the request.</p></li>
   <!-- there is no limit -->

   <li>
    <p>If <var title>method</var> is a <span>simple method</span>
    this step may be skipped.</p>

    <p>Add one or more
    <code title=http-access-control-allow-methods>Access-Control-Allow-Methods</code>
    headers consisting of (a subset of) the
    <span>list of methods</span>.</p>

    <p class=note>If a method is a <span>simple method</span> it does not
    need to be listed, but this is not prohibited.</p>

    <p class=note>Since the <span>list of methods</span> can be unbounded
    simply returning <var title>method</var> can be enough.</p>
   </li>

   <li>
    <p>If each of the <var title>header field-names</var> is a
    <span>simple header</span> and none is <code>Content-Type</code>, than
    this step may be skipped.</p>

    <p>Add one or more
    <code title=http-access-control-allow-headers>Access-Control-Allow-Headers</code>
    headers consisting of (a subset of) the
    <span>list of headers</span>.</p>

    <p class=note>If a header field name is a <span>simple header</span> and
    is not <code>Content-Type</code>, it is not required to be listed.
    <code>Content-Type</code> is to be listed as only a subset of its values
    makes it qualify as <span>simple header</span>.</p>

    <p class=note>Since the <span>list of headers</span> can be unbounded
    simply returning <var title>headers</var> can be enough.</p>
   </li>
  </ol>


  <h3 id="resource-security">Security</h3>

  <p><em>This section is non-normative.</em></p>

  <p>Resource authors are strongly encouraged to ensure that requests using
  safe methods, e.g. <code>GET</code> or <code>OPTIONS</code>, have no side
  effects so potential attackers cannot modify the user's data easily. If
  resources are set up like this attackers would effectively have to be on
  the <span>list of origins</span> to do harm.</p>

  <p>In addition to checking the <code title="http-origin">Origin</code>
  header, resource authors are strongly encouraged to also check the
  <code>Host</code> header. That is, make sure that the host name provided
  by that header matches the host name of the server on which the resource
  resides. This will provide protection against DNS rebinding attacks.</p>

  <p>To provide integrity protection of resource sharing policy statements
  usage of SSL/TLS is encouraged.</p>




  <h2 id="user-agent-processing-model">User Agent Processing Model</h2>

  <!-- XXX
  <p><em>This section only applies to user agents.</em></p>
  -->

  <p>This section describes the processing models that user agents have to
  implement.</p>

  <p>The processing models in this sections need to be referenced by a
  CORS API specification that defines when the algorithm is invoked and how
  the return values are to be handled. The processing models are not
  suitable for standalone use.</p>


  <h3>Cross-Origin Request</h3>

  <p>The <dfn id=cross-origin-request>cross-origin request</dfn>
  algorithm takes the following parameters:

  <dl>
   <dt><dfn id="request-url">request URL</dfn></dt>
   <dd>
    <p>The <span data-anolis-spec=html>URL</span> to be
    <span data-anolis-spec=html title=fetch>fetched</span>.</p>

    <p class=note>The <span>request URL</span> is modified in face of
    redirects.</p>
   </dd>

   <dt><dfn id="request-method">request method</dfn></dt>
   <dd><p>The method for the request. <code>GET</code>, unless explicitly
   set.</p></dd>

   <dt><dfn id="author-request-headers">author request headers</dfn></dt>
   <dd><p>A list of headers set by authors for the request. Empty, unless
   explicitly set.</p></dd>

   <dt><dfn id="request-entity-body">request entity body</dfn></dt>
   <dd><p>The entity body for the request. Missing, unless explicitly
   set.</p></dd>

   <dt><dfn id="source-origin">source origin</dfn></dt>
   <dd>
    <p>The <span data-anolis-spec=origin>origin</span> of the request.</p>
    <p class=note>Due to the specifics of some APIs this cannot be defined
    in a generic way and therefore it has to be provided as argument.</p>
   </dd>

   <dt><dfn id="manual-redirect-flag">manual redirect flag</dfn></dt>
   <dd><p>Set when redirects are <em>not</em> to be automatically followed.

   <dt><dfn id="omit-credentials-flag">omit credentials flag</dfn></dt>
   <dd><p>Set when <span>user credentials</span> are to be excluded in the
   request and when cookies are to be ignored in its response.

   <dt><dfn id="force-preflight-flag">force preflight flag</dfn></dt>
   <dd><p>Set when a <span>preflight request</span> is required.
  </dl>

  <p>The <span>cross-origin request</span> algorithm can be used by
  CORS API specifications who wish to allow cross-origin requests for the
  network APIs they define.</p>

  <p class=note>CORS API specifications are free to limit the abilities of
  a <span>cross-origin request</span>. E.g., the
  <span>omit credentials flag</span> could always be set.

  <p>When the <span>cross-origin request</span> algorithm is invoked,
  these steps must be followed:</p>

  <ol>
   <li>
    <p>If for some reason the user agent does not want to make the request
    terminate this algorithm and set the
    <span>cross-origin request status</span> to <i>network error</i>.</p>

    <p class=note>The <span>request URL</span> could have been blacklisted
    by the user in some fashion.</p>
   </li>

   <li>
    <p>If the following conditions are true, follow the
    <span>simple cross-origin request</span> algorithm:

    <ul>
     <li><p>The <span>request method</span> is a
     <span>simple method</span> and the <span>force preflight flag</span> is
     unset.

     <li><p>Each of the <span>author request headers</span> is a
     <span>simple header</span> or <span>author request headers</span> is
     empty.</p></li>
    </ul>
   </li>

   <li><p>Otherwise, follow the
   <span>cross-origin request with preflight</span> algorithm.</p></li>
  </ol>

  <p class=note>Cross-origin requests using a method that is
  <span title="simple method">simple</span> with
  <span>author request headers</span> that are not
  <span title="simple header">simple</span> will have a
  <span>preflight request</span> to ensure that the resource can handle
  those headers. (Similarly to requests using a method that is not a
  <span>simple method</span>.)</p>


  <h4>Handling a Response to a Cross-Origin Request</h4>

  <p>User agents must filter out all response headers
  other than those that are a <span>simple response header</span> or of
  which the field name is an <span>ASCII case-insensitive</span> match for
  one of the values of the
  <code title=http-access-control-expose-headers>Access-Control-Expose-Headers</code>
  headers (if any), before exposing response headers to APIs defined in
  CORS API specifications.</p>

  <p class=note>The
  <code data-anolis-spec=xhr title=dom-XMLHttpRequest-getResponseHeader>getResponseHeader()</code>
  method of <code data-anolis-spec=xhr>XMLHttpRequest</code> will therefore
  not expose any header not indicated above.</p>


  <h4>Cross-Origin Request Status</h4>

  <p>Each <span>cross-origin request</span> has an associated
  <dfn id="cross-origin-request-status">cross-origin request status</dfn>
  that CORS API specifications that enable an API to make
  <span title="cross-origin request">cross-origin requests</span> can hook
  into. It can take at most two distinct values over the course of a
  <span>cross-origin request</span>. The values are:</p>

  <dl>
   <dt><i>preflight complete</i></dt>
   <dd>The user agent is about to make the <span>actual request</span>.</dd>

   <dt><i>success</i>
   <dd>The resource can be shared.</dd>

   <dt><i>abort error</i>
   <dd>The user aborted the request.</dd>

   <dt><i>network error</i>
   <dd>The resource cannot be shared. Also used when a DNS error, TLS
   negotiation failure, or other type of network error occurs.
   <span class=note>This does not include HTTP responses that indicate some
   type of error, such as HTTP status code 410.</span>
   <!-- shared with XMLHttpRequest -->
  </dl>


  <h4>Source Origin</h4>

  <p>The <span>source origin</span> is the initial
  <span data-anolis-spec=origin>origin</span> that user agents must use for
  the <code title="http-origin">Origin</code> header. It can be modified
  during the <span>redirect steps</span>.</p>


  <h4>Simple Cross-Origin Request</h4>

  <p>The steps below describe what user agents must do
  for a
  <dfn id="simple-cross-origin-request">simple cross-origin request</dfn>:</p>

  <ol>
   <li>
    <p>Apply the <span>make a request steps</span> and observe the
    <i>request rules</i> below while making the request.</p>

    <dl class=switch>
     <dt>If the <span>manual redirect flag</span> is unset and the response
     has an HTTP status code of 301, 302, 303, or 307</dt>
     <dd><p>Apply the <span>redirect steps</span>.</p></dd>

     <dt>If the end user cancels the request</dt>
     <dd><p>Apply the <span>abort steps</span>.</p></dd>

     <dt>If there is a network error</dt>
     <dd>
      <p>In case of DNS errors, TLS negotiation failure, or other type of
      network errors, apply the <span>network error steps</span>. Do not
      request any kind of end user interaction.</p>

      <p class=note>This does not include HTTP responses that indicate
      some type of error, such as HTTP status code 410.</p>
     </dd>

     <dt>Otherwise</dt>
     <dd><p>Perform a <span>resource sharing check</span>. If it returns
     fail, apply the <span>network error steps</span>. Otherwise, if it
     returns pass, terminate this algorithm and set the
     <span>cross-origin request status</span> to <i>success</i>. Do not
     actually terminate the request.</p></dd>
    </dl>
   </li>
  </ol>


  <h4>Cross-Origin Request with Preflight</h4>

  <p>To protect resources against cross-origin requests that could not
  originate from certain user agents before this specification existed a
  <span>preflight request</span> is made to ensure that the resource is
  aware of this specification. The result of this request is stored in a
  <span>preflight result cache</span>.</p>

  <p>The steps below describe what user agents must do
  for a
  <dfn id="cross-origin-request-with-preflight">cross-origin request with preflight</dfn>.
  This is a request to a non same-origin URL that first needs to be
  authorized using either a <span>preflight result cache</span> entry or a
  <span>preflight request</span>.</p>

  <ol>
   <li>
    <p>Go to the next step if the following conditions are true:

    <ul>
     <li>
      <p>For <span>request method</span> there either is a
      <span>method cache match</span> or it is a
      <span>simple method</span> and the <span>force preflight flag</span>
      is unset.

     <li>
      <p>For every header of <span>author request headers</span>
      there either is a <span>header cache match</span> for the field name
      or it is a <span>simple header</span>.</p>
     </li>
    </ul>


    <!-- the preflight request -->
    <p>Otherwise, make a
    <dfn id="preflight-request">preflight request</dfn>.
    <span data-anolis-spec=html>Fetch</span> the <span>request URL</span>
    from <i title>origin</i> <span>source origin</span> with the
    <i title>manual redirect flag</i> and the
    <i title>block cookies flag</i> set, using the method
    <code>OPTIONS</code>, and with the following additional constraints:</p>

    <ul>
     <li><p>Include an
     <code title=http-access-control-request-method>Access-Control-Request-Method</code>
     header with as header field value the <span>request method</span> (even
     when that is a <span>simple method</span>).</p></li>

     <li><p>If <span>author request headers</span> is not empty include an
     <code title=http-access-control-request-headers>Access-Control-Request-Headers</code>
     header with as header field value a comma-separated list of the header
     field names from <span>author request headers</span> in lexicographical
     order, each <span>converted to ASCII lowercase</span> (even when one or
     more are a <span>simple header</span>).</p></li>

     <li><p>Exclude the <span>author request headers</span>.</p></li>

     <li><p>Exclude <span>user credentials</span>.</p></li>

     <li><p>Exclude the <code title="http-referer">Referer</code> header if
     <span>source origin</span> is a globally unique identifier.</p></li>

     <li><p>Exclude the <span>request entity body</span>.</p></li>
    </ul>

    <p>The following <i>request rules</i> are to be observed while making
    the <span>preflight request</span>:</p>

    <dl class=switch>
     <dt>If the end user cancels the request</dt>
     <dd><p>Apply the <span>abort steps</span>.</p></dd>

     <dt>If the response has an HTTP status code that is not 200</dt>
     <dd>
      <p>Apply the <span>network error steps</span>.</p>

      <p class=note>The <span>cache and network error steps</span> are not
      used here as this is about an actual network error.</p>
     </dd>

     <dt>If there is a network error</dt>
     <dd>
      <p>In case of DNS errors, TLS negotiation failure, or other type of
      network errors, apply the <span>network error steps</span>. Do not
      request any kind of end user interaction.</p>

      <p class=note>This does not include HTTP responses that indicate
      some type of error, such as HTTP status code 410.</p>

      <p class=note>The <span>cache and network error steps</span> are not
      used here as this is about an actual network error.</p>
     </dd>

     <dt>Otherwise (the HTTP status code is 200)</dt>
     <dd>
      <ol>
       <li><p>If the <span>resource sharing check</span> returns fail,
       apply the <span>cache and network error steps</span>.</p></li>

       <li><p>Let <var title>methods</var> be the empty list.</p></li>

       <li>
        <p>If there are one or more
        <code title=http-access-control-allow-methods>Access-Control-Allow-Methods</code>
        headers let <var title>methods</var> be the values as result of
        <span title="header parsing">parsing</span> the headers.</p>

        <p>If <span title="header parsing failed">parsing failed</span>
        apply the <span>cache and network error steps</span>.</p>
       </li>

       <li>
        <p>If <var title>methods</var> is still the empty list and the
        <span>force preflight flag</span> is set, append the
        <span>request method</span> to <var title>methods</var>.

        <p class=note>This ensures that
        <span title="preflight request">preflight requests</span> that
        happened solely because of the <span>force preflight flag</span> are
        cached too.

       <li><p>Let <var title>headers</var> be the empty list.</p></li>

       <li>
        <p>If there are one or more
        <code title=http-access-control-allow-headers>Access-Control-Allow-Headers</code>
        headers let <var title>headers</var> be the values as result of
        <span title="header parsing">parsing</span> the headers.</p>

        <p>If <span title="header parsing failed">parsing failed</span>
        apply the <span>cache and network error steps</span>.</p>
       </li>

       <li><p>If <span>request method</span> is not a
       <span>case-sensitive</span> match for any method in
       <var title>methods</var> and is not a <span>simple method</span>,
       apply the <span>cache and network error steps</span>.</p></li>

       <li><p>If the field name of each header in
       <span>author request headers</span> is not an
       <span>ASCII case-insensitive</span> match for one of the
       header field names in <var title>headers</var> and the header is
       not a <span>simple header</span>, apply the
       <span>cache and network error steps</span>.</p></li>

       <li><p>If for some reason the user agent is unable to provide a
       <span>preflight result cache</span> (e.g. because of limited disk
       space) go to the next step in the overall set of steps (i.e. the
       <span>actual request</span>).</p></li>

       <li>
        <p>If there is a single
        <code title=http-access-control-max-age>Access-Control-Max-Age</code>
        header, <span title="header parsing">parse</span> it and let
        <var title>max-age</var> be the resulting value.</p>

        <p>If there is no such header, there is more than one such header,
        or <span title="header parsing failed">parsing failed</span>, let
        <var title>max-age</var> be a value at the discretion of the user
        agent (zero is allowed).</p>

        <p>If the user agent imposes a limit on the
        <span title="cache-max-age">max-age</span> field value and
        <var title>max-age</var> is greater than that limit let
        <var title>max-age</var> be the limit.</p>
       </li>

       <li>
        <p>For each method in <var title>methods</var> for which there is
        a <span>method cache match</span> set the
        <span title="cache-max-age">max-age</span> field value of the
        matching entry to <var title>max-age</var>.</p>

        <p>For each method in <var title>methods</var> for which there is
        <em>no</em> <span>method cache match</span> create a new entry in
        the <span>preflight result cache</span> with the various fields set
        as follows:</p>

        <dl>
         <dt><span title="cache-origin">origin</span></dt>
         <dd>The <span>source origin</span>.</dd>

         <dt><span title="cache-url">url</span></dt>
         <dd>The <span>request URL</span>.</dd>

         <dt><span title="cache-max-age">max-age</span></dt>
         <dd>The <var title>max-age</var>.</dd>

         <dt><span title="cache-credentials">credentials</span></dt>
         <dd>False if the <span>omit credentials flag</span> is set, or true
         otherwise.

         <dt><span title="cache-method">method</span></dt>
         <dd>The given method.</dd>

         <dt><span title="cache-header">header</span></dt>
         <dd>Empty.</dd>
        </dl>
       </li>

       <li>
        <p>For each header in <var title>headers</var> for which there is
        a <span>header cache match</span> set the
        <span title="cache-max-age">max-age</span> field value of the
        matching entry to <var title>max-age</var>.</p>

        <p>For each header in <var title>headers</var> for which there is
        <em>no</em> <span>header cache match</span> create a new entry in
        the <span>preflight result cache</span> with the various fields set
        as follows:</p>

        <dl>
         <dt><span title="cache-origin">origin</span></dt>
         <dd>The <span>source origin</span>.</dd>

         <dt><span title="cache-url">url</span></dt>
         <dd>The <span>request URL</span>.</dd>

         <dt><span title="cache-max-age">max-age</span></dt>
         <dd>The <var title>max-age</var>.</dd>

         <dt><span title="cache-credentials">credentials</span></dt>
         <dd>False if the <span>omit credentials flag</span> is set, or true
         otherwise.

         <dt><span title="cache-method">method</span></dt>
         <dd>Empty.</dd>

         <dt><span title="cache-header">header</span></dt>
         <dd>The given header.</dd>
        </dl>
       </li>
      </ol>
     </dd>
    </dl>
   </li>

   <li><p>Set the <span>cross-origin request status</span> to
   <i>preflight complete</i>.</p></li>

   <!-- the actual request -->
   <li>
    <p>This is the <dfn>actual request</dfn>. Apply the
    <span>make a request steps</span> and observe the <i>request rules</i>
    below while making the request.</p>

    <dl class=switch>
     <dt>If the response has an HTTP status code of 301, 302, 303, or 307</dt>

     <dd><p>Apply the <span>cache and network error steps</span>.</p></dd>

     <dt>If the end user cancels the request</dt>

     <dd><p>Apply the <span>abort steps</span>.</p></dd>

     <dt>If there is a network error</dt>
     <dd>
      <p>In case of DNS errors, TLS negotiation failure, or other type of
      network errors, apply the <span>network error steps</span>. Do not
      request any kind of end user interaction.</p>

      <p class=note>This does not include HTTP responses that indicate
      some type of error, such as HTTP status code 410.</p>
     </dd>


     <dt>Otherwise</dt>

     <dd><p>Perform a <span>resource sharing check</span>. If it returns
     fail, apply the <span>cache and network error steps</span>. Otherwise,
     if it returns pass, terminate this algorithm and set the
     <span>cross-origin request status</span> to <i>success</i>. Do not
     actually terminate the request.</p></dd>
    </dl>
  </ol>

  <div class="example">
   <p>Consider the following scenario:</p>

   <ol>
    <li><p>The user agent gets the request from an API, such as
    <code data-anolis-spec=xhr>XMLHttpRequest</code>, to perform a
    cross-origin request using the custom <code>XMODIFY</code> method from
    <span>source origin</span> <code>http://example.org</code> to
    <code>http://blog.example/entries/hello-world</code>.

    <li><p>The user agent performs a <span>preflight request</span> using
    the <code>OPTIONS</code> method to
    <code>http://blog.example/entries/hello-world</code> and includes the
    <code title="http-origin">Origin</code> and
    <code title=http-access-control-request-method>Access-Control-Request-Method</code>
    headers with the appropriate values.</p></li>

    <li>
     <p>The response to that request includes the following headers:</p>
     <pre>Access-Control-Allow-Origin: http://example.org
Access-Control-Max-Age: 2520
Access-Control-Allow-Methods: PUT, DELETE, XMODIFY</pre>

    <li><p>The user agent then performs the desired request using the
    <code>XMODIFY</code> method to
    <code>http://blog.example/entries/hello-world</code> as this was allowed
    by the resource. In addition, for the coming forty-two minutes, no
    <span>preflight request</span> will be needed.
   </ol>
  </div>


  <h4>Preflight Result Cache</h4>

  <p>As mentioned, a <span>cross-origin request with preflight</span>
  uses a <dfn id="preflight-result-cache">preflight result cache</dfn>. This
  cache consists of a set of entries. Each entry consists of the following
  fields:</p>

  <dl>
   <dt><dfn id="cache-origin" title="cache-origin">origin</dfn></dt>
   <dd>Holds the <span>source origin</span>.</dd>

   <dt><dfn id="cache-url" title="cache-url">url</dfn></dt>
   <dd>Holds the <span>request URL</span>.</dd>

   <dt><dfn id="cache-max-age" title="cache-max-age">max-age</dfn></dt>
   <dd>Holds the
   <code title=http-access-control-max-age>Access-Control-Max-Age</code>
   header value.</dd>

   <dt><dfn id="cache-credentials" title="cache-credentials">credentials</dfn></dt>
   <dd>False if the <span>omit credentials flag</span> is set, or true
   otherwise.

   <dt><dfn id="cache-method" title="cache-method">method</dfn></dt>
   <dd>Empty if <span title="cache-header">header</span> is not empty;
   otherwise one of the values from the
   <code title=http-access-control-allow-methods>Access-Control-Allow-Methods</code>
   headers.</dd>

   <dt><dfn id="cache-header" title="cache-header">header</dfn></dt>
   <dd>Empty if <span title="cache-method">method</span> is not empty;
   otherwise one of the values from the
   <code title=http-access-control-allow-headers>Access-Control-Allow-Headers</code>
   headers.</dd>
  </dl>

  <p class=note>To be clear, the <span title="cache-method">method</span>
  and <span title="cache-header">header</span> fields are mutually
  exclusive. When one of them is empty the other is non-empty.</p>

  <p class=note>The primary key of an entry consists of all fields
  excluding the <span title="cache-max-age">max-age</span> field.</p>

  <p>Entries must be removed when the time specified in
  the <span title="cache-max-age">max-age</span> field has passed since
  storing the entry. Entries can also be added and removed per the
  algorithms below. They are added and removed in such a way that there can
  never be duplicate items in the cache.</p>

  <p>User agents may clear cache entries before the
  time specified in the <span title="cache-max-age">max-age</span> field has
  passed.</p>

  <p class=note>Although this effectively makes the
  <span>preflight result cache</span> optional, user agents are strongly
  encouraged to support it.</p>


  <h4>Generic Cross-Origin Request Algorithms</h4>

  <p>The variables used in the generic set of steps are part of the
  algorithms that invoke these set of steps.</p>

  <hr>

  <p>Whenever the <dfn>make a request steps</dfn> are applied,
  <span data-anolis-spec=html>fetch</span> the <span>request URL</span> from
  <i title>origin</i> <span>source origin</span> with the
  <i title>manual redirect flag</i> set, and the
  <i title>block cookies flag</i> set if the
  <span>omit credentials flag</span> is set. Use method
  <span>request method</span>, entity body <span>request entity body</span>,
  including the <span>author request headers</span>, and include
  <span>user credentials</span> if the <span>omit credentials flag</span> is unset.
  Exclude the <code title="http-referer">Referer</code> header if
  <span>source origin</span> is a globally unique identifier.</p>

  <p>Whenever the <dfn id="redirect-steps">redirect steps</dfn> are applied,
  follow this set of steps:</p>

  <ol>
   <li><p>Let <var>original URL</var> be the <span>request URL</span>.

   <li><p>Let <span>request URL</span> be the
   <span data-anolis-spec=html>URL</span> conveyed by
   the <code>Location</code> header in the redirect response.</p></li>
   <!-- XXX should be resolved URL per HTML5 algorithms ... -->

   <li><p>If the <span>request URL</span> &lt;scheme> is not supported,
   infinite loop precautions are violated, or the user agent does not wish
   to make the new request for some other reason, apply the
   <span>network error steps</span>.

   <li><p>If the <span>request URL</span> contains the
   <code data-anolis-spec=uri>userinfo</code> production apply the
   <span>network error steps</span>.</p></li>

   <li><p>If the <span>resource sharing check</span> for the current
   resource returns fail, apply the <span>network error steps</span>.
   <!--This prevents intranet data leakage.-->

   <li><p>If the <span>request URL</span>
   <span data-anolis-spec=origin>origin</span> is not
   <span data-anolis-spec=origin>same origin</span> with the
   <var>original URL</var> <span data-anolis-spec=origin>origin</span>, set
   <span>source origin</span> to a globally unique identifier (becomes
   "<code title>null</code>" when transmitted).

   <li><p>Transparently follow the redirect while observing the set of
   <i>request rules</i>.
   <!-- XXX or should this use the make a request steps? -->
  </ol>

  <hr>

  <p>Whenever the <dfn id="abort-steps">abort steps</dfn> are applied,
  terminate the algorithm that invoked this set of steps and set the
  <span>cross-origin request status</span> to <i>abort error</i>.</p>

  <hr>

  <p>Whenever the <dfn id="network-error-steps">network error steps</dfn>
  are applied, terminate the algorithm that invoked this set of steps and
  set the <span>cross-origin request status</span> to
  <i>network error</i>.</p>

  <p class=note>This has no effect on setting of
  <span>user credentials</span>. I.e. if the <i title>block cookies flag</i>
  is unset, cookies will be set by the response.

  <p>Whenever the
  <dfn id="cache-and-network-error-steps">cache and network error steps</dfn>
  are applied, follow these steps:</p>

  <ol>
   <li><p>Remove the entries in the <span>preflight result cache</span>
   where <span title="cache-origin">origin</span> field value is a
   <span>case-sensitive</span> match for <span>source origin</span>
   and <span title="cache-url">url</span> field value is a
   <span>case-sensitive</span> match for <span>request URL</span>.</p></li>

   <li><p>Apply the <span>network error steps</span> acting as if the
   algorithm that invoked the <span>cache and network error steps</span>
   invoked the <span>network error steps</span> instead.</p>
  </ol>

  <hr>

  <p>There is a
  <dfn id="preflight-result-cache-match">cache match</dfn>
  when there is a cache entry in the <span>preflight result cache</span>
  for which the following is true:</p>

  <ul>
   <li><p>The <span title="cache-origin">origin</span> field value is a
   <span>case-sensitive</span> match for
   <span>source origin</span>.</p></li>

   <li><p>The <span title="cache-url">url</span> field value is a
   <span>case-sensitive</span> match for
   <span>request URL</span>.</p></li>

   <li><p>The <span title="cache-credentials">credentials</span> field value
   is true and the <span>omit credentials flag</span> is unset, or it is false and
   the <span>omit credentials flag</span> is set.
  </ul>

  <p>There is a
  <dfn id="preflight-result-cache-method-match">method cache match</dfn>
  when there is a cache entry for which there is a <span>cache match</span>
  and the <span title="cache-method">method</span> field value is a
  <span>case-sensitive</span> match for the given method.</p>

  <p>There is a
  <dfn id="preflight-result-cache-header-match">header cache match</dfn>
  when there is a cache entry for which there is a <span>cache match</span>
  and the <span title="cache-header">header</span> field value is an
  <span>ASCII case-insensitive</span> match for the given header field
  name.</p>


  <h3>Resource Sharing Check</h3>

  <p>The <dfn id="resource-sharing-check">resource sharing check</dfn>
  algorithm for a given resource is as follows:</p>

  <ol>
   <li><p>If the response includes zero or more than one
   <code title=http-access-control-allow-origin>Access-Control-Allow-Origin</code>
   header values, return fail and terminate this algorithm.</p></li>

   <li><p>If the
   <code title=http-access-control-allow-origin>Access-Control-Allow-Origin</code>
   header value is the "<code>*</code>" character and the
   <span>omit credentials flag</span> is set, return pass and terminate this
   algorithm.</p></li>

   <li><p>If the value of
   <code title=http-access-control-allow-origin>Access-Control-Allow-Origin</code>
   is not a <span>case-sensitive</span> match for the value of the
   <code title="http-origin">Origin</code> header as defined by its
   specification, return fail and terminate this algorithm.</p></li>

   <li><p>If the <span>omit credentials flag</span> is unset and the response
   includes zero or more than one
   <code title=http-access-control-allow-credentials>Access-Control-Allow-Credentials</code>
   header values, return fail and terminate this algorithm.</p></li>

   <li><p>If the <span>omit credentials flag</span> is unset and the
   <code title=http-access-control-allow-credentials>Access-Control-Allow-Credentials</code>
   header value is not a <span>case-sensitive</span> match for
   "<code>true</code>", return fail and terminate this algorithm.

   <li><p>Return pass.
  </ol>

  <p class=note>The above algorithm also functions when the
  <span data-anolis-spec=origin>ASCII serialization</span> of an origin is
  the string "<code>null</code>".</p>


  <h3 id="user-agent-security">Security</h3>

  <p><em>This section is non-normative.</em></p>

  <p>At various places user agents are allowed to take additional
  precautions. E.g. user agents are allowed to not store cache items, remove
  cache items before they reached their
  <span title="cache-max-age">max-age</span>, and not connect to certain
  <span data-anolis-spec=html title=URL>URLs</span>.</p>

  <p>User agents are encouraged to impose a limit on
  <span title="cache-max-age">max-age</span> so items cannot stay in the
  <span>preflight result cache</span> for unreasonable amounts of time.</p>

  <p>As indicated as the first step of the <span>cross-origin request</span>
  algorithm and in the <span>redirect steps</span> algorithm user agents
  are allowed to terminate the algorithm and not make a request. This could
  be done because e.g.:</p>

  <ul>
   <li>The server on which the resource resides is blacklisted.</li>
   <li>The server on which the resource resides is known to be part of an
   intranet.</li>
   <li>The URL &lt;scheme> is not supported.</li>
   <li><code>https</code> to <code>http</code> is not allowed.</li>
   <li><code>https</code> to <code>https</code> is not allowed because e.g.
   the certificates differ.</li>
  </ul>

  <p>User agents are encouraged to apply security decisions on a generic
  level and not just to the resource sharing policy. E.g. if a user agent
  disallows requests from the <code>https</code> to the <code>http</code>
  scheme for a <span>cross-origin request</span> it is encouraged to do the
  same for the HTML <code>img</code> element.</p>




  <h2 id="cors-api-specification-advice">CORS API Specification Advice</h2>

  <p><em>This section is non-normative.</em></p>

  <p>This specification defines a resource sharing policy that cannot be
  implemented without an API that utilizes it. The specification that
  defines the API that uses the policy is a CORS API specification.</p>

  <p>In case a CORS API specification defines multiple APIs that utilize the
  policy the advice is to be considered separately for each API.</p>


  <h3 id="cors-api-specifiation-request">Constructing a Cross-Origin Request</h3>

  <p>For all <span>cross-origin</span> requests that APIs can make for
  which the resource sharing policy in this specification is supposed to
  apply, the CORS API specification needs to reference the
  <span>cross-origin request</span> algorithm and set the following input
  variables appropriately: <span>request URL</span>,
  <span>request method</span>, <span>author request headers</span>,
  <span>request entity body</span>, <span>source origin</span>,
  <span>manual redirect flag</span>, <span>omit credentials flag</span>,
  and the <span>force preflight flag</span>.</p>

  <p>CORS API specifications are allowed to let these input variables be
  controlled by the API, but can also set fixed values.</p>

  <p class="example">A CORS API specification for an API that only allows
  requests using the <code>GET</code> method might set
  <span>request method</span> to <code>GET</code>,
  <span>request entity body</span> to empty, and <span>source origin</span>
  to some appropriate value and let the other variables be controlled by the
  API.</p>


  <h3 id="cors-api-specification-redirect">Dealing with Same Origin to Cross-Origin Redirects</h3>

  <p>Since browsers are based on a
  <span data-anolis-spec=origin>same origin</span> security model and the
  policy outlined in this specification is intended for APIs used in
  browsers, it is expected that APIs that will utilize this policy will have
  to handle a <span data-anolis-spec=origin>same origin</span> request that
  results in a redirect that is <span>cross-origin</span> in a special
  way.</p>

  <p>For APIs that transparently handle redirects CORS API specifications
  are encouraged to handle this scenario transparently as well by "catching"
  the redirect and invoking the <span>cross-origin request</span> algorithm
  on the (<span>cross-origin</span>) redirect URL.</p>

  <p class=note>The XMLHttpRequest specification does this.
  <span data-anolis-ref class=informative>XHR</span>


  <h3 id="cors-api-specification-response">Dealing with the
  Cross-Origin Request Status</h3>

  <p>While a <span>cross-origin request</span> is progressing its
  associated <span>cross-origin request status</span> is updated.
  Depending on the value of the <span>cross-origin request status</span> the
  API is to react in a different way:</p>

  <dl>
   <dt><i>preflight complete</i></dt>
   <dd>
    <p>Features that can only be safely exposed after a
    <span>preflight request</span> can now be enabled.</p>

    <p class=note>E.g. upload progress events for
    <code data-anolis-spec=xhr>XMLHttpRequest</code>.
   </dd>

   <dt><i>success</i></dt>
   <dd>
    <p>The contents of the response can be shared with the API, including
    headers that have not been filtered out.</p>

    <p class=note>The request itself can still be progressing. I.e. the
    <span>cross-origin request status</span> value does not indicate that
    the request has completed.</p>
   </dd>

   <dt><i>abort error</i></dt>
   <dd><p>Handle analogous to requests where the user aborted the request.
   This can be handled equivalently to how <i>network error</i> is
   handled. Ensure not to reveal any further information about the
   request.</p></dd>

   <dt><i>network error</i></dt>
   <dd><p>Handle analogous to requests where some kind of error
   occured. Ensure not the reveal any further information about the
   request.</p></dd>
  </dl>


  <h3 id="cors-api-specification-security">Security</h3>

  <p>Similarly to <span data-anolis-spec=origin>same origin</span> requests,
  CORS API specifications are encouraged to properly limit headers, methods,
  and <span>user credentials</span> the author can set and get for requests
  that are <span>cross-origin</span>.</p>

  <p class=note>Reviewing the XMLHttpRequest specification provides a good
  start for the kind of limitations that are to be imposed.
  <span data-anolis-ref class=informative>XHR</span>

  <p>CORS API specifications also need to ensure not to reveal anything
  until the <span>cross-origin request status</span> is set to
  <i>preflight complete</i> or <i>success</i> to prevent e.g. port
  scanning.</p>

  <p class=note>In XMLHttpRequest progress events are dispatched
  only after the <span>cross-origin request status</span> is set to
  <i>success</i>. Upload progress events are only dispatched once the
  <span>cross-origin request status</span> is <i>preflight complete</i>.</p>



<h2 class=no-num>References</h2>
<div id=anolis-references></div>


  <h2 class="no-num" id="acknowledgments">Acknowledgments</h2>

  <p><em>This appendix is non-normative.</em></p>

  <p>The editor would like to thank

  Adam Barth,
  Alexey Proskuryakov,
  Arne Johannessen,
  Arthur Barstow,
  Benjamin Hawkes-Lewis,
  Bert Bos,
  Bj&ouml;rn H&ouml;hrmann,
  Boris Zbarsky,
  Brad Hill,
  Cameron McCormack,
  Collin Jackson,
  David H&aring;s&auml;ther,
  David Orchard,
  Dean Jackson,
  Eric Lawrence,
  Frank Ellerman,
  Frederick Hirsch,
  Graham Klyne,
  Hal Lockhart,
  Henri Sivonen,
  Ian Hickson,
  Jesse M. Heines,
  Jonas Sicking,
  Lachlan Hunt,
   (Kang-Hao Lu),
  Maciej Stachowiak,
  Marc Silbey,
  Marcos Caceres,
  Mark Nottingham,
  Mark S. Miller,
  Martin D&uuml;rst,
  Matt Womer,
  Mhano Harkness,
  Michael Smith,
  Mohamed Zergaoui,
  Nikunj Mehta,
  Odin H&oslash;rthe Omdal,
  Sharath Udupa,
  Simon Pieters,
  Sunava Dutta,
  Surya Ismail,
  Thomas Roessler,
  Tyler Close,
  Vladimir Dzhuvinov,
  Wayne Carr, and
  Zhenbin Xu

  for their contributions to this specification.</p>

  <p>Special thanks to Brad Porter, Matt Oshry and R. Auburn, who all helped
  editing earlier versions of this document.</p>
 </body>
</html>
